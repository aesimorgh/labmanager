{% extends "base_user_panel.html" %}
{% load static %}

{% block title %}Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --muted:#6b7280; --ring:#e9eaf3;
    --shadow:0 8px 24px rgba(15,23,42,.06);
    --radius:14px; --radius-sm:12px;
  }
  body{background:var(--bg)}
  .container-narrow{max-width:1100px;margin-inline:auto}
  .card-soft{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card-headerx{border-bottom:1px solid var(--ring);padding:.85rem 1rem;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);background:#fff}

  .form-label{font-weight:600;margin-bottom:.35rem}
  .ctrl{box-sizing:border-box!important;height:44px!important;padding:.45rem .6rem!important;font-size:.95rem;line-height:1.2;}
  .form-control.ctrl,.form-select.ctrl{width:100%;height:44px!important}
  .form-select.ctrl{-webkit-appearance:none; -moz-appearance:none; appearance:none;padding-right:.6rem!important;background-position: left .6rem center;}
  .pdate{direction:ltr;text-align:center;letter-spacing:.4px}
  .form-control.ctrl::placeholder{font-size:.9rem;color:#9ca3af}

  .filter-wrap{padding:1rem 1.2rem}
  .equal-grid-4{display:grid !important;grid-template-columns:repeat(4, minmax(0,1fr));grid-auto-rows:auto;gap:12px;align-items:end;}
  @media (max-width: 992px){ .equal-grid-4{grid-template-columns:repeat(2, minmax(0,1fr));} }
  @media (max-width: 576px){ .equal-grid-4{grid-template-columns:1fr;} }

  .filter-actions{display:flex;gap:.8rem;justify-content:space-between;align-items:center;margin-top:.6rem;flex-wrap:wrap}
  .btn-lgx{height:44px;padding:.45rem 1rem;font-weight:700;border-radius:10px}

  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.75rem;margin-bottom:1rem}
  .kpi{background:linear-gradient(180deg,#ffffff,#fafbff);border:1px solid var(--ring);border-radius:var(--radius-sm);padding:1rem;display:flex;align-items:center;gap:.75rem;box-shadow:var(--shadow)}
  .kpi .ico{width:38px;height:38px;border-radius:10px;display:grid;place-items:center;font-size:18px}
  .kpi .meta .lbl{color:var(--muted);font-size:.85rem}
  .kpi .meta .val{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:800;font-size:1.05rem}
  .ico-g{background:#eef9f0} .ico-b{background:#eef2ff} .ico-y{background:#fff7e6} .ico-r{background:#fff1f2}
  .ok{color:#16a34a} .muted{color:var(--muted)}
  .table-wrap{border:1px solid var(--ring);border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow)}
  table thead th{background:#f5f7ff !important;position:sticky;top:0;z-index:2}
  .money{font-family:ui-monospace,Menlo,Consolas,monospace}
  .page-head{display:flex;align-items:center;justify-content:space-between;margin:12px 0 18px}
  .page-title{font-weight:900;font-size:1.15rem}
  .chip{font-size:.8rem;background:#eef2ff;border:1px solid var(--ring);padding:.2rem .6rem;border-radius:999px;color:#374151}
</style>

<!-- Ú©Ø§Ù†ØªÚ©Ø³Øª Ø³Ø±ÙˆØ±ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ -->
<script>
  window.DOCTOR_CHOICES = {{ DOCTOR_CHOICES|default:"[]"|safe }};
  window.PRODUCT_CHOICES = {{ PRODUCT_CHOICES|default:"[]"|safe }};
</script>

<div class="container-narrow py-3">
  <div class="page-head">
    <div class="page-title">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±</div>
    <span class="chip">ÙÛŒÙ„ØªØ± Ù¾ÙˆÛŒØ§ + KPI</span>
  </div>

  <div class="card-soft mb-3">
    <div class="card-headerx">ÙÛŒÙ„ØªØ± Ú¯Ø²Ø§Ø±Ø´</div>
    <form id="filter-form">
      <div class="filter-wrap">
        <div class="equal-grid-4">
          <div>
            <label for="d_from" class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
            <input id="d_from" type="text" class="form-control ctrl pdate" placeholder="YYYY/MM/DD" autocomplete="off">
          </div>
          <div>
            <label for="d_to" class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
            <input id="d_to" type="text" class="form-control ctrl pdate" placeholder="YYYY/MM/DD" autocomplete="off">
          </div>
          <div>
            <label for="doctor" class="form-label">Ø¯Ú©ØªØ±</label>
            <select id="doctor" class="form-select ctrl">
              <option value="">Ù‡Ù…Ù‡</option>
              <!-- Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </select>
          </div>
          <div>
            <label for="order_type" class="form-label">Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</label>
            <select id="order_type" class="form-select ctrl">
              <option value="">Ù‡Ù…Ù‡</option>
              <!-- Ø§Ú¯Ø± PRODUCT_CHOICES Ø¨Ø§Ø´Ø¯ ÛŒØ§ API Ù¾Ø§Ø³Ø® Ø¯Ù‡Ø¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </select>
          </div>
        </div>

        <div class="filter-actions">
          <label class="d-flex align-items-center gap-2 m-0" for="include_expense">
            <input class="form-check-input" type="checkbox" id="include_expense" checked>
            <span class="form-check-label">Ø´Ø§Ù…Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡</span>
          </label>

          <div class="d-flex align-items-center gap-3 flex-wrap">
            <label class="m-0">Ù†ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯:</label>
            <label class="d-flex align-items-center gap-2 m-0">
              <input class="form-check-input" type="radio" name="settlement" value="realized" checked>
              <span class="form-check-label">ØªØ­Ù‚Ù‚â€ŒÛŒØ§ÙØªÙ‡</span>
            </label>
            <label class="d-flex align-items-center gap-2 m-0">
              <input class="form-check-input" type="radio" name="settlement" value="unrealized">
              <span class="form-check-label">ØªØ­Ù‚Ù‚â€ŒÙ†ÛŒØ§ÙØªÙ‡</span>
            </label>
            <label class="d-flex align-items-center gap-2 m-0">
              <input class="form-check-input" type="radio" name="settlement" value="all">
              <span class="form-check-label">Ù‡Ù…Ù‡</span>
            </label>
          </div>

          <button type="submit" class="btn btn-primary btn-lgx">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
        </div>
      </div>
    </form>
  </div>

  <div id="loading" class="text-center my-3" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="muted mt-2">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡â€¦</div>
  </div>

  <div id="results" class="results-section">
    <div class="kpi-grid">
      <div class="kpi"><div class="ico ico-g">ğŸ’°</div><div class="meta"><div class="lbl">Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„</div><div id="t-revenue" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-y">ğŸ› ï¸</div><div class="meta"><div class="lbl">Ù‡Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ§Ø¯</div><div id="t-material" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-b">ğŸ§ª</div><div class="meta"><div class="lbl">Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</div><div id="t-dl" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-r">ğŸ‘¥</div><div class="meta"><div class="lbl">Ù‡Ø²ÛŒÙ†Ù‡ Ø¯Ø³ØªÙ…Ø²Ø¯</div><div id="t-wage" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-r">ğŸ¢</div><div class="meta"><div class="lbl">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡</div><div id="t-opex" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ“ˆ</div><div class="meta"><div class="lbl">Ø³ÙˆØ¯ Ù†Ø§Ø®Ø§Ù„Øµ</div><div id="t-gross" class="val ok"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ“Š</div><div class="meta"><div class="lbl">Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ</div><div id="t-net" class="val ok"></div></div></div>
    </div>

    <!-- Ø­Ø§Ù„Øª ØªÚ©ÛŒ: Ø¨Ø±Ø§ÛŒ realized ÛŒØ§ unrealized -->
<div id="table-single" class="table-wrap">
  <div class="p-2 muted" style="border-bottom:1px solid var(--ring)">Ø±ÛŒØ² Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
  <div class="table-responsive">
    <table class="table table-sm table-striped text-center m-0">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th>Ú©Ø¯ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ú©ØªØ±</th>
          <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ø±Ø¢Ù…Ø¯</th>
          <th>Ù…ÙˆØ§Ø¯</th>
          <th>Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</th>
          <th>Ø¯Ø³ØªÙ…Ø²Ø¯</th>
          <th>Ø³ÙˆØ¯ Ù†Ø§Ø®Ø§Ù„Øµ</th>
          <th>Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>
</div>

<!-- Ø­Ø§Ù„Øª Ø¯ÙˆÚ¯Ø§Ù†Ù‡: Ø¨Ø±Ø§ÛŒ both -->
<div id="table-both" class="table-wrap" style="display:none">
  <div class="p-2 muted" style="border-bottom:1px solid var(--ring)">ØªØ­Ù‚Ù‚â€ŒÛŒØ§ÙØªÙ‡</div>
  <div class="table-responsive mb-2">
    <table class="table table-sm table-striped text-center m-0">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th>Ú©Ø¯ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ú©ØªØ±</th>
          <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ø±Ø¢Ù…Ø¯</th>
          <th>Ù…ÙˆØ§Ø¯</th>
          <th>Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</th>
          <th>Ø¯Ø³ØªÙ…Ø²Ø¯</th>
          <th>Ø³ÙˆØ¯ Ù†Ø§Ø®Ø§Ù„Øµ</th>
          <th>Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ</th>
        </tr>
      </thead>
      <tbody id="orders-realized"></tbody>
    </table>
  </div>

  <div class="p-2 muted" style="border-bottom:1px solid var(--ring)">ØªØ­Ù‚Ù‚â€ŒÙ†ÛŒØ§ÙØªÙ‡</div>
  <div class="table-responsive">
    <table class="table table-sm table-striped text-center m-0">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th>Ú©Ø¯ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ú©ØªØ±</th>
          <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
          <th>Ø¯Ø±Ø¢Ù…Ø¯ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±</th>
          <th>Ù…ÙˆØ§Ø¯</th>
          <th>Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</th>
          <th>Ø¯Ø³ØªÙ…Ø²Ø¯</th> 
          <th>Ø³ÙˆØ¯ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒâ€ŒØ´Ø¯Ù‡</th>
          <th>Ù‚Ø§Ø¨Ù„ Ø¯Ø±ÛŒØ§ÙØª</th>
        </tr>
      </thead>
      <tbody id="orders-unrealized"></tbody>
    </table>
  </div>
</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){

  // Loader ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ (fallback Ø¯ÙˆØ³ØªØ§Ù†Ù‡)
  function loadScript(src){return new Promise((res,rej)=>{var s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}
  function loadCSS(href){var l=document.createElement('link');l.rel='stylesheet';l.href=href;document.head.appendChild(l);}

  (async function ensureJalaliPicker(){
    try{
      if (window.jQuery && jQuery.fn && jQuery.fn.persianDatepicker) {
        jQuery('.pdate').persianDatepicker({format:'YYYY/MM/DD',autoClose:true,initialValue:false});
        return;
      }
      if (typeof window.persianDate === 'undefined') {
        await loadScript('https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js');
      }
      if (!(window.jQuery && jQuery.fn)) { await loadScript('https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js'); }
      if (!jQuery.fn.persianDatepicker) {
        loadCSS('https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css');
        await loadScript('https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js');
      }
      jQuery('.pdate').persianDatepicker({format:'YYYY/MM/DD',autoClose:true,initialValue:false});
    }catch(e){ console.warn('[JalaliPicker] fallback failed', e); }
  })();

  // Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø² Ú©Ø§Ù†ØªÚ©Ø³Øª (Ø§Ú¯Ø± ÙˆÛŒÙˆ ØªØ²Ø±ÛŒÙ‚ Ú©Ù†Ø¯)
  const DOCTOR_CHOICES = Array.isArray(window.DOCTOR_CHOICES) ? window.DOCTOR_CHOICES : null;
  const PRODUCT_CHOICES = Array.isArray(window.PRODUCT_CHOICES) ? window.PRODUCT_CHOICES : null;

  // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ù‚Ø§Ù… Ùˆ ØªØ§Ø±ÛŒØ®
  const fa={'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
  const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  const toAscii=s=>String(s||'').replace(/[Û°-Û¹]/g,d=>fa[d]).replace(/[Ù -Ù©]/g,d=>ar[d]).trim();
  function normalizeJalali(s){
    s = toAscii(s).replace(/-/g,'/');
    const m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if(!m) return '';
    const y = m[1], mm = ('0'+m[2]).slice(-2), dd = ('0'+m[3]).slice(-2);
    return `${y}/${mm}/${dd}`;
  }

  const api_url = "{{ api_url|default:'/billing/api/profit-summary/' }}";
  const $form=document.getElementById('filter-form'), $loading=document.getElementById('loading'), $res=document.getElementById('results'), $tbody=document.getElementById('orders-body');
  const show=(el,on)=>{el.style.display=on?'block':'none'}
  const fm=x=>{try{return Number(x||0).toLocaleString('fa-IR')}catch(_){return x||'0'}}
 
    function getSettlement(){
    const el = document.querySelector('input[name="settlement"]:checked');
    return el ? el.value : 'both';
  }
  function toggleTables(mode){
    const single = document.getElementById('table-single');
    const both   = document.getElementById('table-both');
    if(mode === 'both'){ single.style.display='none'; both.style.display='block'; }
    else { single.style.display='block'; both.style.display='none'; }
  }

  // Ù¾Ø±Ú©Ø±Ø¯Ù† select Ø¯Ú©ØªØ±
  async function populateDoctors(){
    const sel = document.getElementById('doctor');
    if (!sel) return;

    if (DOCTOR_CHOICES && DOCTOR_CHOICES.length){
      for (const d of DOCTOR_CHOICES){
        const name = d.name || d.title || d.label;
        if(!name) continue;
        const opt = document.createElement('option');
        opt.value = name; // API ÙØ¹Ù„ÛŒ Ù†Ø§Ù… Ø¯Ú©ØªØ± Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        opt.textContent = name;
        sel.appendChild(opt);
      }
      return;
    }

    // fallback: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² API Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ú©ØªØ±
    try {
      let resp = await fetch('/api/doctors?q=*', {headers:{'Accept':'application/json'}});
      if (!resp.ok) throw 0;
      let data = await resp.json();
      if (Array.isArray(data)) {
        for (const d of data){
          const name = d.name || d.title || d.label;
          if (!name) continue;
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }
      }
    } catch(e){
      console.warn('[doctor list] fallback failed', e);
      // Â«Ù‡Ù…Ù‡Â» Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
    }
  }

  // Ù¾Ø±Ú©Ø±Ø¯Ù† select Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´) Ø§Ø² Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Product
  async function populateProducts(){
    const sel = document.getElementById('order_type');
    if (!sel) return;

    function fillFrom(arr){
      sel.innerHTML = '';
      const allOpt = document.createElement('option');
      allOpt.value = '';
      allOpt.textContent = 'Ù‡Ù…Ù‡';
      sel.appendChild(allOpt);
      for (const p of arr){
        const value = p.code || p.value || '';
        const label = p.name || p.label || value || 'â€”';
        if(!value) continue;
        const opt = document.createElement('option');
        opt.value = value;    // Ú©Ø¯ Ù…Ø­ØµÙˆÙ„ Ø¨Ø±Ø§ÛŒ API
        opt.textContent = label;
        sel.appendChild(opt);
      }
    }

    if (PRODUCT_CHOICES && PRODUCT_CHOICES.length){
      fillFrom(PRODUCT_CHOICES);
      return;
    }

    // fallback: Ø§Ú¯Ø± ÙˆÛŒÙˆ ØªØ²Ø±ÛŒÙ‚ Ù†Ú©Ø±Ø¯Ù‡ØŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÛŒÚ© API Ø¹Ù…ÙˆÙ…ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
    try{
      let resp = await fetch('/api/products?active=1', {headers:{'Accept':'application/json'}});
      if(!resp.ok) throw 0;
      let data = await resp.json();
      if (Array.isArray(data) && data.length){
        fillFrom(data);
        return;
      }
    }catch(e){
      console.warn('[product list] fallback failed', e);
      // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ù†Ø¨Ø¹ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ø§Ù† Ú¯Ø²ÛŒÙ†Ù‡ Â«Ù‡Ù…Ù‡Â» Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
    }
  }

    function fillRowsUnrealized(rows){
    const $tbodyU = document.getElementById('orders-unrealized');
    $tbodyU.innerHTML='';
    (rows||[]).forEach((r,i)=>{
      const tr = document.createElement('tr');

      const orderCell = r.order_url && r.order_id
        ? `<a href="${r.order_url}" target="_blank" rel="noopener">${r.order_id}</a>`
        : `${r.order_id ?? 'â€”'}`;

      const doctorCell = r.doctor_url && r.doctor_name
        ? `<a href="${r.doctor_url}" target="_blank" rel="noopener">${r.doctor_name}</a>`
        : `${r.doctor_name ?? 'â€”'}`;

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${orderCell}</td>
        <td>${doctorCell}</td>
        <td>${(r.order_type ?? r.product_code) ?? 'â€”'}</td>
        <td class="money">${fm(r.expected_revenue)}</td>
        <td class="money">${fm(r.material_cogs)}</td>
        <td class="money">${fm(r.digital_lab_cost)}</td>
        <td class="money">${fm(r.wage_cost)}</td>
        <td class="money">${fm(r.projected_profit)}</td>
        <td class="money">${fm(r.receivable_amount)}</td>
      `;
      $tbodyU.appendChild(tr);
    });
  }

  function fillRowsUnrealizedIntoSingle(rows){
  const $tbody = document.getElementById('orders-body');
  $tbody.innerHTML='';
  (rows||[]).forEach((r,i)=>{
    const tr = document.createElement('tr');

    const orderCell = r.order_url && r.order_id
      ? `<a href="${r.order_url}" target="_blank" rel="noopener">${r.order_id}</a>`
      : `${r.order_id ?? 'â€”'}`;

    const doctorCell = r.doctor_url && r.doctor_name
      ? `<a href="${r.doctor_url}" target="_blank" rel="noopener">${r.doctor_name}</a>`
      : `${r.doctor_name ?? 'â€”'}`;

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${orderCell}</td>
      <td>${doctorCell}</td>
      <td>${(r.order_type ?? r.product_code) ?? 'â€”'}</td>
      <td class="money">${fm(r.expected_revenue)}</td>
      <td class="money">${fm(r.material_cogs)}</td>
      <td class="money">${fm(r.digital_lab_cost)}</td>
      <td class="money">${fm(r.wage_cost)}</td>
      <td class="money">${fm(r.projected_profit)}</td>
      <td class="money">${fm(r.receivable_amount)}</td>
    `;
    $tbody.appendChild(tr);
  });
}
  function fillTotals(t){
    document.getElementById("t-revenue").textContent  = fm(t?.revenue);
    document.getElementById("t-material").textContent = fm(t?.material_cogs);
    document.getElementById("t-dl").textContent       = fm(t?.digital_lab_cost);
    // ğŸ†• Ù‡Ø²ÛŒÙ†Ù‡ Ø¯Ø³ØªÙ…Ø²Ø¯ Ø§Ø² totals.wage_cost
    document.getElementById("t-wage").textContent     = fm(t?.wage_cost);
    document.getElementById("t-opex").textContent     = fm(t?.opex_period);
    document.getElementById("t-gross").textContent    = fm(t?.gross_profit);
    document.getElementById("t-net").textContent      = fm(t?.net_profit);
  }
  function fillRows(rows){
  $tbody.innerHTML='';
  (rows||[]).forEach((r,i)=>{
    const tr = document.createElement('tr');

    // Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø§Ø² API: r.order_url Ùˆ r.doctor_url
    const orderCell = r.order_url && r.order_id
      ? `<a href="${r.order_url}" target="_blank" rel="noopener">${r.order_id}</a>`
      : `${r.order_id ?? 'â€”'}`;

    const doctorCell = r.doctor_url && r.doctor_name
      ? `<a href="${r.doctor_url}" target="_blank" rel="noopener">${r.doctor_name}</a>`
      : `${r.doctor_name ?? 'â€”'}`;

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${orderCell}</td>
      <td>${doctorCell}</td>
      <td>${(r.order_type ?? r.product_code) ?? 'â€”'}</td>
      <td class="money">${fm(r.revenue)}</td>
      <td class="money">${fm(r.material_cogs)}</td>
      <td class="money">${fm(r.digital_lab_cost)}</td>
      <td class="money">${fm(r.wage_cost)}</td>
      <td class="money">${fm(r.gross_profit)}</td>
      <td class="money">${fm(r.net_profit)}</td>
    `;
    $tbody.appendChild(tr);
  });
}

  // Ø´Ø±ÙˆØ¹: Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†
  populateDoctors();
  populateProducts();

  // Submit Ø¨Ø§ Ù…Ø­Ú©Ù…â€ŒÚ©Ø§Ø±ÛŒ
  $form.addEventListener('submit', function(e){
    e.preventDefault();
    try {
      show($res,false); show($loading,true);

      const dFrom=normalizeJalali(document.getElementById('d_from').value);
      const dTo  =normalizeJalali(document.getElementById('d_to').value);
      if(!dFrom && !dTo){ show($loading,false); alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒ Ø§Ø² ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      const settlement = getSettlement();

      const params = new URLSearchParams({
        d_from: dFrom || '',
        d_to: dTo || '',
        doctor: (document.getElementById('doctor').value || '').trim(),
        order_type: document.getElementById('order_type').value || '',
        include_expense: document.getElementById('include_expense').checked ? '1' : '0',
        settlement: settlement
      });
      console.log('API URL:', api_url, 'Params:', params.toString());


      fetch(api_url+'?'+params.toString(), {headers:{'Accept':'application/json'}})
        .then(r=>r.json())
        .then(resp=>{
          show($loading,false);
          if(!resp?.ok){ alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡'); return; }
          fillTotals(resp.data?.totals);

          const mode = getSettlement();
          toggleTables(mode);

          if(mode === 'both'){
            // realized
            const realizedRows = resp.data?.realized?.orders || [];
            const $tbodyR = document.getElementById('orders-realized');
            $tbodyR.innerHTML='';  // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
            fillRows(realizedRows); // fillRows Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯ Ø¯Ø± #orders-bodyØŒ Ù¾Ø³ Ù…ÙˆÙ‚ØªØ§Ù‹ Ù…Ù‚ØµØ¯ Ø±Ø§ Ø¹ÙˆØ¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            // Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø­ØªÙˆØ§ Ø§Ø² #orders-body Ø¨Ù‡ #orders-realized
            $tbodyR.innerHTML = document.getElementById('orders-body').innerHTML;
            document.getElementById('orders-body').innerHTML='';

            // unrealized
            const unrealRows = resp.data?.unrealized?.orders || [];
            fillRowsUnrealized(unrealRows);
          }else{
            // Ø­Ø§Ù„Øª ØªÚ©ÛŒ (realized ÛŒØ§ unrealized)
            const rows = resp.data?.orders || [];
            if(mode === 'unrealized'){
              fillRowsUnrealizedIntoSingle(rows);
              // Ú†ÙˆÙ† Ø¬Ø¯ÙˆÙ„ ØªÚ©ÛŒ Ù‡Ø¯Ø±Ù Â«Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒÂ» Ø¯Ø§Ø±Ø¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø§ÛŒÙ† Ø³ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ unrealized Ù¾Ø± Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø§Ø´Ú©Ø§Ù„ Ù†Ø¯Ø§Ø±Ø¯).
              // Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ù‡Ø¯Ø± Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª unrealized ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒÙ…Ø› ÙØ¹Ù„Ø§Ù‹ Ø³Ø§Ø¯Ù‡ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ….
            }else{
              fillRows(rows);
            }
          }

          show($res,true);

        })
        .catch(err=>{ console.error(err); show($loading,false); alert('Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'); });
    } catch(err){
      console.error(err);
      show($loading,false);
      alert('Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±Ù…');
    }
  });
});
</script>
{% endblock %}














