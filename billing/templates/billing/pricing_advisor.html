{% extends "base_user_panel.html" %}
{% load static %}

{% block title %}Ù…Ø´Ø§ÙˆØ± Ù‚ÛŒÙ…Øª (Pricing Advisor){% endblock %}

{% block content %}
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --muted:#6b7280; --ring:#e9eaf3;
    --shadow:0 8px 24px rgba(15,23,42,.06);
    --radius:14px; --radius-sm:12px;
  }
  body{background:var(--bg)}
  .container-narrow{max-width:1100px;margin-inline:auto}
  .card-soft{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card-headerx{border-bottom:1px solid var(--ring);padding:.85rem 1rem;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);background:#fff}

  .form-label{font-weight:600;margin-bottom:.35rem}
  .ctrl{box-sizing:border-box!important;height:44px!important;padding:.45rem .6rem!important;font-size:.95rem;line-height:1.2;}
  .form-control.ctrl,.form-select.ctrl{width:100%;height:44px!important}
  .form-select.ctrl{-webkit-appearance:none; -moz-appearance:none; appearance:none;padding-right:.6rem!important;background-position: left .6rem center;}
  .pdate{direction:ltr;text-align:center;letter-spacing:.4px}
  .form-control.ctrl::placeholder{font-size:.9rem;color:#9ca3af}

  .filter-wrap{padding:1rem 1.2rem}
  .equal-grid-4{display:grid !important;grid-template-columns:repeat(4, minmax(0,1fr));grid-auto-rows:auto;gap:12px;align-items:end;}
  @media (max-width: 992px){ .equal-grid-4{grid-template-columns:repeat(2, minmax(0,1fr));} }
  @media (max-width: 576px){ .equal-grid-4{grid-template-columns:1fr;} }

  .filter-actions{display:flex;gap:.8rem;justify-content:space-between;align-items:center;margin-top:.6rem;flex-wrap:wrap}
  .btn-lgx{height:44px;padding:.45rem 1rem;font-weight:700;border-radius:10px}

  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.75rem;margin-bottom:1rem}
  .kpi{background:linear-gradient(180deg,#ffffff,#fafbff);border:1px solid var(--ring);border-radius:var(--radius-sm);padding:1rem;display:flex;align-items:center;gap:.75rem;box-shadow:var(--shadow)}
  .kpi .ico{width:38px;height:38px;border-radius:10px;display:grid;place-items:center;font-size:18px}
  .kpi .meta .lbl{color:var(--muted);font-size:.85rem}
  .kpi .meta .val{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:800;font-size:1.05rem}
  .ico-g{background:#eef9f0} .ico-b{background:#eef2ff} .ico-y{background:#fff7e6} .ico-r{background:#fff1f2}
  .ok{color:#16a34a} .muted{color:var(--muted)}
  .table-wrap{border:1px solid var(--ring);border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow)}
  table thead th{background:#f5f7ff !important;position:sticky;top:0;z-index:2}
  .money{font-family:ui-monospace,Menlo,Consolas,monospace}
  .page-head{display:flex;align-items:center;justify-content:space-between;margin:12px 0 18px}
  .page-title{font-weight:900;font-size:1.15rem}
  .chip{font-size:.8rem;background:#eef2ff;border:1px solid var(--ring);padding:.2rem .6rem;border-radius:999px;color:#374151}
</style>

<div class="container-narrow py-3">
  <div class="page-head">
    <div class="page-title">ğŸª™ Ù…Ø´Ø§ÙˆØ± Ù‚ÛŒÙ…Øª (Pricing Advisor)</div>
    <span class="chip">ÙÛŒÙ„ØªØ± Ù¾ÙˆÛŒØ§ + KPI</span>
  </div>

  <div class="card-soft mb-3">
    <div class="card-headerx">Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡</div>
    <form id="frm">
      <div class="filter-wrap">
        <div class="equal-grid-4">
          <div>
            <label class="form-label">Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</label>
            <select id="product_code" class="form-select ctrl" required>
              <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>
              {% for p in products %}
                <option value="{{ p.code }}">{{ p.name }} ({{ p.code }})</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
            <input id="d_from" type="text" class="form-control ctrl pdate" placeholder="YYYY/MM/DD" autocomplete="off">
          </div>

          <div>
            <label class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</label>
            <input id="d_to" type="text" class="form-control ctrl pdate" placeholder="YYYY/MM/DD" autocomplete="off">
          </div>

          <div>
            <label class="form-label d-block">&nbsp;</label>
            <label class="d-flex align-items-center gap-2 m-0" for="include_open">
              <input class="form-check-input" type="checkbox" id="include_open" checked>
              <span class="form-check-label">Ø´Ø§Ù…Ù„ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
            </label>
          </div>
        </div>

        <div class="equal-grid-4" style="margin-top:.4rem">
          <div>
            <label class="form-label">Ù‡Ø¯Ù Ù…Ø§Ø±Ø¬ÛŒÙ† (Ù…Ø«Ø§Ù„ 0.6 = 60%)</label>
            <input id="target_margin" class="form-control ctrl" placeholder="0.6" inputmode="decimal" autocomplete="off">
          </div>
          <div>
            <label class="form-label">Markup Ã— (Ù…Ø«Ø§Ù„ 2.2)</label>
            <input id="markup" class="form-control ctrl" placeholder="2.2" inputmode="decimal" autocomplete="off">
          </div>
          <div>
            <label class="form-label">Ù¾Ù„Ù‡Ù” Ø±ÙÙ†Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
            <input id="rounding_step" class="form-control ctrl" value="10000" inputmode="numeric" autocomplete="off">
          </div>
            <div>
              <label class="form-label">Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
              <select id="method" class="form-select ctrl">
                <option value="history" selected>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ</option>
                <option value="bom">Ø¨Ø± Ø§Ø³Ø§Ø³ BOM Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</option>
                <option value="hybrid">ØªØ±Ú©ÛŒØ¨ÛŒ (BOM + Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ ÙˆØ§Ù‚Ø¹ÛŒ)</option>
              </select>
            </div>
        </div>

        <div class="filter-actions">
          <div></div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary btn-lgx" type="submit">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
            <button class="btn btn-outline-secondary btn-lgx" type="button" id="btn-clear">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div id="loading" class="text-center my-3" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="muted mt-2">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡â€¦</div>
  </div>

  <div id="out" style="display:none">
    <div class="kpi-grid">
      <div class="kpi"><div class="ico ico-g">ğŸ”¢</div><div class="meta"><div class="lbl">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ù†Ù…ÙˆÙ†Ù‡</div><div id="n_orders" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ’°</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±Ø¢Ù…Ø¯</div><div id="avg_rev" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-y">ğŸ› ï¸</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ§Ø¯</div><div id="avg_mat" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-b">ğŸ§ª</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</div><div id="avg_dlab" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-y">ğŸ§®</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„</div><div id="avg_cost" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ“ˆ</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³ÙˆØ¯ Ù†Ø§Ø®Ø§Ù„Øµ</div><div id="avg_gross" class="val ok"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ“Š</div><div class="meta"><div class="lbl">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ</div><div id="avg_net" class="val ok"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ’µ</div><div class="meta"><div class="lbl">Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Ù…Ø§Ø±Ø¬ÛŒÙ†)</div><div id="price_margin" class="val"></div></div></div>
      <div class="kpi"><div class="ico ico-g">ğŸ’µ</div><div class="meta"><div class="lbl">Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Markup)</div><div id="price_markup" class="val"></div></div></div>
    </div>

    <div class="table-wrap">
      <div class="p-2 muted" style="border-bottom:1px solid var(--ring)">Ù†Ù…ÙˆÙ†Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ (Ø­Ø¯Ø§Ú©Ø«Ø± Û²Ûµ)</div>
      <div class="table-responsive">
        <table class="table table-sm table-striped text-center m-0">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>Order ID</th>
              <th>Revenue</th>
              <th>Material</th>
              <th>Digital Lab</th>
              <th>Gross</th>
              <th>Net</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){

  // Ù‡Ù…Ø§Ù† Ù„ÙˆØ¯Ø± Ø¬Ù„Ø§Ù„ÛŒ Ù¾Ù†Ù„ Ù…Ø±Ø¬Ø¹ ØªÙˆ (fallback Ø¯ÙˆØ³ØªØ§Ù†Ù‡)
  function loadScript(src){return new Promise((res,rej)=>{var s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}
  function loadCSS(href){var l=document.createElement('link');l.rel='stylesheet';l.href=href;document.head.appendChild(l);}

  (async function ensureJalaliPicker(){
    try{
      if (window.jQuery && jQuery.fn && jQuery.fn.persianDatepicker) {
        jQuery('.pdate').persianDatepicker({format:'YYYY/MM/DD',autoClose:true,initialValue:false});
        return;
      }
      if (typeof window.persianDate === 'undefined') {
        await loadScript('https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js');
      }
      if (!(window.jQuery && jQuery.fn)) { await loadScript('https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js'); }
      if (!jQuery.fn.persianDatepicker) {
        loadCSS('https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css');
        await loadScript('https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js');
      }
      jQuery('.pdate').persianDatepicker({format:'YYYY/MM/DD',autoClose:true,initialValue:false});
    }catch(e){ console.warn('[JalaliPicker] fallback failed', e); }
  })();

  // â€”â€”â€” Ø§Ø±Ù‚Ø§Ù… Ùˆ ØªØ§Ø±ÛŒØ® â€”â€”â€”
  const fa={'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
  const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  const toAscii=s=>String(s||'').replace(/[Û°-Û¹]/g,d=>fa[d]).replace(/[Ù -Ù©]/g,d=>ar[d]).trim();
  function normalizeJalali(s){
    s = toAscii(s).replace(/-/g,'/');
    const m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if(!m) return '';
    const y = m[1], mm = ('0'+m[2]).slice(-2), dd = ('0'+m[3]).slice(-2);
    return `${y}/${mm}/${dd}`;
  }
  const fm=x=>{try{return Number(x||0).toLocaleString('fa-IR')}catch(_){return x||'0'}};

  // â€”â€”â€” API & ÙØ±Ù… â€”â€”â€”
  const api_url = "{{ api_url|default:'/billing/api/pricing/quote/' }}";
  const $form=document.getElementById('frm'), $loading=document.getElementById('loading'), $out=document.getElementById('out');

  document.getElementById('btn-clear').onclick = ()=>{
    $form.reset(); document.getElementById('rows').innerHTML=''; $out.style.display='none';
  };

  $form.addEventListener('submit', function(e){
    e.preventDefault();
    const pc = document.getElementById('product_code').value;
    if(!pc){ alert('Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }

    const dFrom = normalizeJalali(document.getElementById('d_from').value);
    const dTo   = normalizeJalali(document.getElementById('d_to').value);
    const include_open = document.getElementById('include_open').checked ? '1' : '0';
    const target_margin = toAscii(document.getElementById('target_margin').value);
    const markup        = toAscii(document.getElementById('markup').value);
    const rounding_step = toAscii(document.getElementById('rounding_step').value || '10000');

    const params = new URLSearchParams({
      product_code: pc,
      d_from: dFrom || '',
      d_to: dTo || '',
      include_open: include_open,
      min_orders: '3',
      target_margin: target_margin || '',
      markup: markup || '',
      rounding_step: rounding_step,
      method: document.getElementById('method').value || 'history'
    });

    $loading.style.display='block'; $out.style.display='none';

    fetch(api_url + '?' + params.toString(), {headers:{'Accept':'application/json'}})
      .then(r=>r.json())
      .then(resp=>{
        $loading.style.display='none';
        if(!resp?.ok){ alert('âŒ Ø®Ø·Ø§: ' + (resp?.error||'Ù†Ø§Ù…Ø´Ø®Øµ')); return; }
        const d = resp.data || {};

        document.getElementById('n_orders').textContent = fm(d.n_orders);
        document.getElementById('avg_rev').textContent  = fm(d.avg_revenue);
        document.getElementById('avg_mat').textContent  = fm(d.avg_material);
        document.getElementById('avg_dlab').textContent = fm(d.avg_dlab);
        document.getElementById('avg_cost').textContent = fm(d.avg_total_cost);
        document.getElementById('avg_gross').textContent= fm(d.avg_gross_profit);
        document.getElementById('avg_net').textContent  = fm(d.avg_net_profit);
        document.getElementById('price_margin').textContent = fm(d.suggested_price_margin);
        document.getElementById('price_markup').textContent = fm(d.suggested_price_markup);

        const body = document.getElementById('rows');
        body.innerHTML = '';
        (d.rows||[]).slice(0,25).forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${r.order_id ?? 'â€”'}</td>
            <td class="money">${fm(r.revenue)}</td>
            <td class="money">${fm(r.material_cogs)}</td>
            <td class="money">${fm(r.digital_lab_cost)}</td>
            <td class="money">${fm(r.gross_profit)}</td>
            <td class="money">${fm(r.net_profit)}</td>
          `;
          body.appendChild(tr);
        });

        $out.style.display='block';
      })
      .catch(err=>{
        console.error(err);
        $loading.style.display='none';
        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
      });
  });
});
</script>
{% endblock %}



