{% extends "base_user_panel.html" %}
{% load num_extras %}
{% load jalali_tags %}
{% block title %}Ù…Ø§Ù„ÛŒ{% endblock %}

{% block head_extra %}
<style>
  .muted{color:#6b7280;font-size:.9rem}
  .btn{display:inline-block;padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:.5rem;text-decoration:none;color:#111827}
  .btn:hover{background:#f8fafc}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:.45rem .55rem;border-top:1px solid #eef2f7;text-align:start}
  .table thead th{background:#f8fafc;white-space:nowrap}
  .num{text-align:end;font-variant-numeric:tabular-nums}

  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem;margin-bottom:1rem}
  .kpi{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem;padding:.8rem}
  .kpi .t{font-size:.9rem;color:#6b7280;margin-bottom:.25rem}
  .kpi .v{font-weight:800;font-size:1.1rem;font-variant-numeric:tabular-nums}

  .cards-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1mm;margin-top:1rem}
  .cardx{border:1px solid #e5e7eb;border-radius:.75rem;background:#fff;padding:1rem;display:flex;flex-direction:column;height:100%;box-sizing:border-box;overflow:hidden}
  .cardx h3{margin:.25rem 0 .5rem;font-size:1.1rem}
  .actions{margin-top:auto;display:flex;gap:.5rem;flex-wrap:wrap}

  .card--reports .toggle-area{cursor:pointer}
  .subcards{display:none;margin-top:.5rem;grid-template-columns:repeat(2,minmax(0,1fr));gap:1mm}
  .subcards .subcard{border:1px dashed #e5e7eb;border-radius:.6rem;padding:.75rem;display:flex;flex-direction:column;gap:.35rem}
  .subcards .title{font-weight:600}
  .card--reports.open .subcards{display:grid}

  .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-top:1rem}
  .mini th,.mini td{padding:.4rem .5rem}
</style>
{% endblock %}

{% block subtabs %}
<ul class="nav nav-pills mb-3">
  <li class="nav-item"><span class="nav-link active">Ù…Ø§Ù„ÛŒ</span></li>
</ul>
{% endblock %}

{% block content %}

<!-- KPI Ù‡Ø§ -->
<div class="kpis">
  <div class="kpi">
    <div class="t">Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</div>
    <div class="v">{{ kpis.open_total|default:0|money_fa }}</div>
    <div class="muted" style="margin-top:.25rem"><a href="{% url 'billing:report_open_invoices' %}" class="muted">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</a></div>
  </div>
  <div class="kpi">
    <div class="t">Û¹Û°+ Ø±ÙˆØ²</div>
    <div class="v">{{ kpis.over_90|default:0|money_fa }}</div>
    <div class="muted" style="margin-top:.25rem"><a href="{% url 'billing:report_aging' %}" class="muted">Ú¯Ø²Ø§Ø±Ø´ Aging</a></div>
  </div>
  <div class="kpi">
    <div class="t">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</div>
    <div class="v">{{ kpis.this_month_payments|default:0|money_fa }}</div>
  </div>
  <div class="kpi">
    <div class="t">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (ØªØ¹Ø¯Ø§Ø¯)</div>
    <div class="v">{{ kpis.this_month_invoices|default:0|int_fa }}</div>
  </div>
  <div class="kpi">
    <div class="t">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø² (ØªØ¹Ø¯Ø§Ø¯)</div>
    <div class="v">{{ kpis.open_count|default:0|int_fa }}</div>
  </div>
  <div class="kpi">
    <div class="t">Ø§Ø±Ø²Ø´ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù†Ø¨Ø§Ø±</div>
    <div class="v">{{ inventory_value|money_fa }}</div>
    <div class="muted" style="margin-top:.25rem"><a href="/inventory/reports/stock/" class="muted">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ø¬Ø²Ø¦ÛŒØ§Øª</a></div>
  </div>
  <div class="kpi">
    <div class="t">Ù‡Ø²ÛŒÙ†Ù‡Ù” Ù…ÙˆØ§Ø¯ Ù…ØµØ±ÙÛŒ Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</div>
    <div class="v">{{ month_consumption|money_fa }}</div>
    <div class="muted" style="margin-top:.25rem"><a href="/inventory/reports/movements-summary/" class="muted">Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±Ú©Ø§Øª</a></div>
  </div>
</div>

<!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ -->
<div class="cards-grid">

  <div class="cardx">
    <h3>Ø­Ø³Ø§Ø¨ Ø¯Ú©ØªØ±</h3>
    <p class="muted">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù…Ø§Ù†Ø¯Ù‡ØŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ùˆ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù‡Ø± Ù¾Ø²Ø´Ú©.</p>
    <div class="actions">
      <a class="btn" href="{% url 'billing:doctor_list' %}">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø­Ø³Ø§Ø¨ Ø¯Ú©ØªØ±</a>
    </div>
  </div>

  <div class="cardx">
    <h3>ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h3>
    <p class="muted">ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³â€ŒÙ‡Ø§ Ùˆ Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ØµØ§Ø¯Ø±Ø´Ø¯Ù‡.</p>
    <div class="actions">
      <a class="btn" href="{% url 'billing:invoice_list' %}">Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</a>
      <a class="btn" href="{% url 'billing:invoice_create_draft' %}">ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</a>
    </div>
  </div>

  <div class="cardx card--reports" id="reportsCard">
    <div class="toggle-area">
      <h3>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ</h3>
      <p class="muted">ÙØ±ÙˆØ´ Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ Ù…Ø¬Ù…ÙˆØ¹ ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§ØŒ Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø² Ùˆ Aging Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§.</p>
    </div>
    <div class="actions">
      <button type="button" class="btn" id="reportsToggleBtn">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
    </div>
    <div class="subcards" aria-hidden="true">
      <div class="subcard">
        <div class="title">Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</div>
        <div class="muted">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡â€ŒÙ†Ø´Ø¯Ù‡.</div>
        <a class="btn" href="{% url 'billing:report_open_invoices' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
      </div>
      <div class="subcard">
        <div class="title">Ú¯Ø²Ø§Ø±Ø´ Aging</div>
        <div class="muted">ØªÙÚ©ÛŒÚ© Û³Û°/Û¶Û°/Û¹Û°+ Ø±ÙˆØ².</div>
        <a class="btn" href="{% url 'billing:report_aging' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
      </div>
      <div class="subcard">
        <div class="title">ÙØ±ÙˆØ´ Ù…Ø§Ù‡Ø§Ù†Ù‡</div>
        <div class="muted">Ø±ÙˆÙ†Ø¯ ÙØ±ÙˆØ´ Ø¯Ø± Ù…Ø§Ù‡â€ŒÙ‡Ø§.</div>
        <a class="btn" href="{% url 'billing:report_monthly_sales' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
      </div>
      <div class="subcard">
        <div class="title">ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§</div>
        <div class="muted">Ù…Ø¬Ù…ÙˆØ¹ Ùˆ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ®ÙÛŒÙâ€ŒÙ‡Ø§.</div>
        <a class="btn" href="{% url 'billing:report_discounts' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
      </div>
    </div>
  </div>

  <div class="cardx">
    <h3>Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ</h3>
    <p class="muted">ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒØŒ Ø¯Ú©ØªØ± Ùˆ Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´ + KPI Ùˆ Ø¬Ø¯ÙˆÙ„ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§.</p>
    <div class="actions">
      <a class="btn" href="{% url 'billing:report_profit_summary_page' %}">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú¯Ø²Ø§Ø±Ø´ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù†</a>
    </div>
  </div>

  <div class="cardx">
    <h3>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
    <p class="muted">Ø«Ø¨Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª: Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ø±ÛŒØŒ Ø®Ø±ÛŒØ¯ Ù…ØªØ±ÛŒØ§Ù„/Ø§Ø¨Ø²Ø§Ø±ØŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ùˆ ØªØ¹Ù…ÛŒØ±Ø§Øª.</p>
    <div class="actions">
      <a class="btn" href="{% url 'billing:costs_home' %}">Ù‡Ø§Ø¨ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a>
    </div>
  </div>

  <div class="cardx">
    <h3>ğŸ’° Ù…Ø´Ø§ÙˆØ± Ù‚ÛŒÙ…Øª</h3>
    <p class="muted">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‚ÛŒÙ…Øª Ø¨Ø± Ø§Ø³Ø§Ø³ BOMØŒ Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ.</p>
    <div class="actions">
      <a class="btn" href="{% url 'billing:pricing_advisor_page' %}">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ± Ù‚ÛŒÙ…Øª</a>
    </div>
  </div>

  <div class="cardx">
    <h3>Ø§Ù†Ø¨Ø§Ø±Ø¯Ø§Ø±ÛŒ</h3>
    <p class="muted">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ù‡ ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨Ø§Ø±.</p>
    <div class="actions">
      <a class="btn" href="/inventory/">Ø®Ø§Ù†Ù‡Ù” Ø§Ù†Ø¨Ø§Ø±</a>
      <a class="btn" href="/inventory/items/materials/">ÙÙ‡Ø±Ø³Øª Ù…ØªØ±ÛŒØ§Ù„</a>
      <a class="btn" href="/inventory/items/consumables/">Ø§Ø¨Ø²Ø§Ø± Ù…ØµØ±ÙÛŒ</a>
      <a class="btn" href="/inventory/items/equipment/">ØªØ¬Ù‡ÛŒØ²Ø§Øª</a>
      <a class="btn" href="/inventory/movements/">Ú©Ø§Ø±ØªÚ©Ø³</a>
      <a class="btn" href="/inventory/reports/movements-summary/">Ø®Ù„Ø§ØµÙ‡Ù” Ø­Ø±Ú©Ø§Øª</a>
      <a class="btn" href="/inventory/reports/stock/">ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ</a>
      <a class="btn" href="/billing/materials/issue/new/">Ù…ØµØ±Ù Ø¯Ø³ØªÛŒ Ù…ØªØ±ÛŒØ§Ù„</a>
    </div>
  </div>

  <div class="cardx">
    <h3>Ú¯Ø²Ø§Ø±Ø´ Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h3>
    <p class="muted">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡ (ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® + Ø®Ø±ÙˆØ¬ÛŒ CSV).</p>
    <div class="actions">
      <a class="btn" href="{% url 'core:digital_lab_list' %}?status=SENT">Ù„ÛŒØ³Øª Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</a>
      <a class="btn" href="{% url 'core:digital_lab_list' %}">Ú©Ù„ Ù„ÛŒØ³Øª</a>
      <a class="btn" href="{% url 'core:digital_lab_report' %}">ØªØ­Ù„ÛŒÙ„ Ù…Ø§Ù„ÛŒ</a>
    </div>
  </div>

  <div class="cardx">
    <h3>ğŸ’° Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªÙ…Ø²Ø¯ Ù¾Ø±Ø³Ù†Ù„</h3>
    <p class="muted">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¯Ø³ØªÙ…Ø²Ø¯Ù‡Ø§ + Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ØªØ³ÙˆÛŒÙ‡Ù” Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªÚ©Ù†Ø³ÛŒÙ†.</p>  
    <div class="actions">
      <a class="btn" href="{% url 'core:wages_report' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªÙ…Ø²Ø¯Ù‡Ø§</a>
      <a class="btn" href="{% url 'core:wages_payout_new' %}">Ø§ÛŒØ¬Ø§Ø¯ ØªØ³ÙˆÛŒÙ‡Ù” Ø¯Ø³ØªÙ…Ø²Ø¯</a>
    </div>
  </div>

</div> <!-- /cards-grid -->

<!-- Ù†Ù…ÙˆØ¯Ø§Ø± + Ø¢Ø®Ø±ÛŒÙ†â€ŒÙ‡Ø§ + Ûµ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø¨Ø±ØªØ± -->
<div class="grid-2">
  <div class="cardx">
    <h3>Ø±ÙˆÙ†Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡ (Û±Û² Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±)</h3>
    <p class="muted">Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±ØŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ØµÙØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
    <canvas id="fmChart" height="120"></canvas>
    <script id="monthlyData" type="application/json">{{ monthly_json|default:"[]"|safe }}</script>
    <div class="actions">
      <a class="btn" href="{% url 'billing:report_monthly_sales' %}">Ú¯Ø²Ø§Ø±Ø´ ÙØ±ÙˆØ´ Ù…Ø§Ù‡Ø§Ù†Ù‡</a>
    </div>
  </div>

  <div class="cardx">
    <h3>Ø¢Ø®Ø±ÛŒÙ† ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²</h3>
    {% if latest_open_invoices %}
      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>Ú©Ø¯</th>
              <th>Ù¾Ø²Ø´Ú©</th>
              <th>ØªØ§Ø±ÛŒØ® ØµØ¯ÙˆØ±</th>
              <th class="num">Ø¨Ø¯Ù‡ÛŒ Ø¨Ø§Ø²</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for inv in latest_open_invoices %}
            <tr>
              <td>{{ inv.code }}</td>
              <td>{{ inv.doctor_name }}</td>
              <!-- âœ… Ø§ØµÙ„Ø§Ø­ ÙØ±Ù…Øª Ø±ÙˆØ²/Ù…Ø§Ù‡/Ø³Ø§Ù„ Ø¬Ù„Ø§Ù„ÛŒ -->
              <td class="muted pdate" data-gdate="{{ inv.issued_at|date:'Y-m-d' }}">
                <span class="jalali-date">{{ inv.issued_at|to_jalali:"%Y/%m/%d"|digits_fa }}</span>
              </td>
              <td class="num">{{ inv.amount_due|money_fa }}</td>
              <td><a class="btn" href="{{ inv.url|default:'#' }}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø²
        <a href="{% url 'billing:report_open_invoices' %}">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</a> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
    {% endif %}
    <div class="actions">
      <a class="btn" href="{% url 'billing:report_open_invoices' %}">Ù‡Ù…Ù‡Ù” Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</a>
      <a class="btn" href="{% url 'billing:report_aging' %}">Aging Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§</a>
    </div>
  </div>

  <div class="cardx">
    <h3>Ûµ Ù¾Ø²Ø´Ú© Ø¨Ø¯Ù‡Ú©Ø§Ø±</h3>
    {% if top_debtors %}
      <div style="overflow:auto">
        <table class="table mini">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>Ù¾Ø²Ø´Ú©</th>
              <th class="num" style="width:160px">Ø¨Ø¯Ù‡ÛŒ Ø¨Ø§Ø²</th>
              <th style="width:120px"></th>
            </tr>
          </thead>
          <tbody>
            {% for d in top_debtors %}
            <tr>
              <td>{{ forloop.counter|int_fa }}</td>
              <td>{{ d.doctor_name }}</td>
              <td class="num">{{ d.amount_due|money_fa }}</td>
              <td>
                {% if d.doctor_id %}
                  <a class="btn" href="{% url 'billing:doctor_account' d.doctor_id %}">Ø­Ø³Ø§Ø¨ Ø¯Ú©ØªØ±</a>
                {% else %}
                  <span class="muted">â€”</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Â«Ù¾Ø²Ø´Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Ù‡Ú©Ø§Ø±Â» Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>

<!-- Ù†Ù…ÙˆØ¯Ø§Ø±: Ø¨Ø±Ú†Ø³Ø¨ Ù…Ø­ÙˆØ± Ø¨Ù‡ Ø¬Ù„Ø§Ù„ÛŒ -->
<script>
(function(){
  function faDigits(s){return (s+'').replace(/\d/g,d=>"Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);}
  function ymToJalaliLabel(ym){
    // ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø«Ù„ 2025-02 ÛŒØ§ 1403-01
    if(!ym) return '';
    var s=(ym+'').replace('/','-');
    var p=s.split('-'); if(p.length!==2) return faDigits(s);
    var y=+p[0], m=+p[1]; if(!y||!m) return faDigits(s);

    // Ø§Ú¯Ø± Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø§Ø³Øª â†’ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¬Ù„Ø§Ù„ÛŒ
    if(y>=1900){
      if(window.DateUtils && typeof DateUtils.gregorianToJalali==='function'){
        try{ var j=DateUtils.gregorianToJalali(y,m,1); var mm=(j[1]<10?'0':'')+j[1]; return faDigits(j[0]+'/'+mm); }catch(e){}
      }
      if(window.persianDate){
        try{ var g=new Date(y,m-1,1); return faDigits(new persianDate(g).calendar('persian').format('YYYY/MM')); }catch(e){}
      }
    }
    // Ø§Ú¯Ø± Ø®ÙˆØ¯Ø´ Ø¬Ù„Ø§Ù„ÛŒ Ø§Ø³Øª
    if(y>=1300 && y<=1600){ return faDigits(y+'/'+(m<10?'0':'')+m); }
    return faDigits(s);
  }

  var raw=document.getElementById('monthlyData');
  var data=[]; try{ data=JSON.parse(raw ? (raw.textContent.trim()||'[]') : '[]'); }catch(e){ data=[]; }

  var labels=[], sales=[], pays=[];
  if(Array.isArray(data) && data.length){
    data.forEach(function(r){
      labels.push( ymToJalaliLabel(r.m||'') );
      sales.push(Number(r.sales||0));
      pays.push(Number(r.payments||0));
    });
  }else{
    for(var i=1;i<=12;i++){ labels.push(faDigits('1403/'+(i<10?'0':'')+i)); sales.push(0); pays.push(0); }
  }

  var el=document.getElementById('fmChart'); if(!el) return;
  new Chart(el,{
    type:'bar',
    data:{ labels:labels, datasets:[ {label:'ÙØ±ÙˆØ´',data:sales},{label:'Ù¾Ø±Ø¯Ø§Ø®Øª',data:pays} ] },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'top'},
        tooltip:{callbacks:{label:function(c){ try{return ' '+Number(c.parsed.y||0).toLocaleString('fa-IR')}catch(e){return c.parsed.y} }}}
      },
      scales:{ y:{ ticks:{ callback:function(v){ try{return Number(v).toLocaleString('fa-IR')}catch(e){return v} } } } }
    }
  });
})();
</script>

<!-- ØªØ«Ø¨ÛŒØª ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø¬Ù„Ø§Ù„ÛŒ Ø¬Ø¯ÙˆÙ„ -->
<script>
document.addEventListener('DOMContentLoaded',function(){
  function faDigits(s){return (s+'').replace(/\d/g,d=>"Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);}
  function toJalaliFromISO(iso){
    if(!iso) return '';
    if(window.DateUtils){
      if(typeof DateUtils.toJalaliStrFromISO==='function') return DateUtils.toJalaliStrFromISO(iso);
      if(typeof DateUtils.toJalaliString==='function') return DateUtils.toJalaliString(iso);
      if(typeof DateUtils.gregorianToJalali==='function'){
        try{
          var p=iso.split('-').map(Number), j=DateUtils.gregorianToJalali(p[0],p[1],p[2]);
          var pad=n=>(n<10?'0':'')+n; return j?(j[0]+'/'+pad(j[1])+'/'+pad(j[2])):'';
        }catch(e){}
      }
    }
    try{
      var g=new Date(iso+'T00:00:00'); if(isNaN(g.getTime())) return '';
      return new persianDate(g).calendar('persian').format('YYYY/MM/DD');
    }catch(e){return '';}
  }

  document.querySelectorAll('td.pdate').forEach(function(td){
    var span=td.querySelector('.jalali-date');
    if(span && span.textContent.trim()){ td.textContent = span.textContent.trim(); return; }
    var iso=(td.getAttribute('data-gdate')||'').trim();
    var j=toJalaliFromISO(iso);
    td.textContent = j ? faDigits(j) : '';
  });
});
</script>

<!-- Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Û´ Ø²ÛŒØ±Ú©Ø§Ø±Øª Â«Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒÂ» -->
<script>
document.addEventListener('DOMContentLoaded',function(){
  var card=document.getElementById('reportsCard');
  var btn=document.getElementById('reportsToggleBtn');
  function toggleReports(){
    if(!card) return;
    var isOpen=card.classList.toggle('open');
    var sc=card.querySelector('.subcards');
    if(sc) sc.setAttribute('aria-hidden',isOpen?'false':'true');
    if(btn) btn.textContent=isOpen?'Ø¨Ø³ØªÙ†':'Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§';
  }
  if(btn) btn.addEventListener('click',function(e){e.preventDefault();toggleReports();});
  var ta=card && card.querySelector('.toggle-area');
  if(ta) ta.addEventListener('click',toggleReports);
});
</script>
{% endblock %}













