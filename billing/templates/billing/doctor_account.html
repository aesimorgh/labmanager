{% extends "base_user_panel.html" %}
{% load static %}
{% load jalali_tags %}
{% load num_extras %}

{% block title %}حساب دکتر{% if doctor %} — {{ doctor.name }}{% endif %}{% endblock %}

{% block head_extra %}
  <!-- فقط برای این صفحه: Bootstrap و Persian Datepicker -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <style>
    body { background:#f8f9fa; }
    .container-narrow { max-width: 1100px; margin-inline:auto; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .badge-status { font-size:.8rem; }
    .card { border-radius: .8rem; }
    .metric { text-align:center; padding:.8rem .6rem; border-radius:.7rem; background:#fff; border:1px solid #e9ecef; }
    .metric .k { font-weight:800; font-size:1.1rem; margin-top:.25rem; }
    .metric .v { font-variant-numeric: tabular-nums; }
    .table-sm th, .table-sm td { padding:.4rem .5rem; }
    .num { text-align:center; font-variant-numeric: tabular-nums; }
    .muted { color:#6c757d; }
    .status-chip{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.18rem .55rem; border-radius:9999px; font-size:.78rem;
      border:1px solid transparent; white-space:nowrap;
    }
    .status-unalloc{ background:#f1f5f9; color:#334155; border-color:#e2e8f0; }  /* بدون تخصیص - خاکستری */
    .status-partial{ background:#fff7e6; color:#915f00; border-color:#ffe0a3; }  /* بخشی - نارنجی */
    .status-alloc  { background:#eef9f1; color:#0f7a2e; border-color:#cbead6; }  /* کامل - سبز */
    .status-draft{ background:#fff7e6; color:#915f00; border-color:#ffe0a3; }
    .status-issued{ background:#eef9f1; color:#0f7a2e; border-color:#cbead6; }
    .actions a { text-decoration:none; }
    .pwt-datepicker-container { z-index: 2050 !important; } /* تقویم در مودال/روی صفحه دیده شود */
  </style>
{% endblock %}

{% block subtabs %}
  <ul class="nav nav-pills mb-3">
    <li class="nav-item">
      <span class="nav-link active">حساب دکتر{% if doctor %} — {{ doctor.name }}{% endif %}</span>
    </li>
  </ul>
{% endblock %}

{% block content %}
<div class="container-narrow">

  <!-- سربرگ صفحه -->
  <div class="page-head mb-3">
    <div>
      <h1 class="h5 mb-1">حساب دکتر{% if doctor %} — {{ doctor.name }}{% endif %}</h1>
      <div class="small text-muted">مرور فاکتورها، پرداخت‌ها و ماندهٔ جاری</div>
    </div>
    <div>
      <a class="btn btn-outline-secondary btn-sm" href="javascript:history.back()">بازگشت</a>
    </div>
  </div>

  <!-- خلاصهٔ آماری -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="metric">
        <div class="k muted">تعداد فاکتورها</div>
        <div class="v k">{{ invoice_count|default:0|int_fa }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="metric">
        <div class="k muted">جمع مبلغ (همه)</div>
        <div class="v k">{{ total_amount_all|default:0|money_fa }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="metric">
        <div class="k muted">پرداخت‌ها</div>
        <div class="v k">{{ total_paid|default:0|money_fa }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="metric">
        <div class="k muted">ماندهٔ جاری</div>
        <div class="v k text-danger">{{ running_balance|default:0|money_fa }}</div>
      </div>
    </div>
  </div>

  <!-- فاکتورها -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-primary text-white py-2">فاکتورها</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th style="width:140px">کد/شناسه</th>
              <th style="width:150px">وضعیت</th>
              <th>بازه</th>
              <th class="num" style="width:150px">جمع فاکتور</th>
              <th class="num" style="width:150px">مانده</th>
              <th style="width:180px">اقدامات</th>
            </tr>
          </thead>
          <tbody>
            {% if invoices %}
              {% for inv in invoices %}
                <tr>
                  <td class="num">{{ forloop.counter|int_fa }}</td>
                  <td>
                    {% if inv.code %}<strong>{{ inv.code }}</strong>{% else %}—{% endif %}
                    <div class="small text-muted">ID: {{ inv.id|int_fa }}</div>
                  </td>
                  <td>
                    {% if inv.status == 'draft' %}
                      <span class="status-chip status-draft">پیش‌نویس</span>
                    {% elif inv.status == 'issued' %}
                      <span class="status-chip status-issued">صادر شده</span>
                    {% else %}
                      <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ inv.status }}</span>
                    {% endif %}
                  </td>
                  <td class="small">
                    {% if inv.period_from %}{{ inv.period_from|date:"Y/m/d"|digits_fa }}{% else %}—{% endif %}
                      <span class="mx-1">تا</span>
                    {% if inv.period_to %}{{ inv.period_to|date:"Y/m/d"|digits_fa }}{% else %}—{% endif %}
                  </td>
                  <td class="num">{{ inv.total_amount|default:0|money_fa }}</td>
                  <td class="num">{{ inv.amount_due|default:0|money_fa }}</td>
                  <td class="actions">
                    <a class="btn btn-outline-primary btn-sm" href="/billing/invoices/{{ inv.id }}/">جزئیات</a>
                    <a class="btn btn-outline-secondary btn-sm" href="/billing/invoices/{{ inv.id }}/print/" target="_blank">چاپ</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="text-center text-muted py-4">فاکتوری ثبت نشده است.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- فرم ثبت پرداخت جدید -->
  <div class="card shadow-sm mb-3">
    <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
  <span>ثبت پرداخت جدید</span>
  <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#allocModal">
    تخصیص پیشرفته
  </button>
</div>
    <div class="card-body">
      <form method="post" action="/billing/doctor/{{ doctor.id }}/payments/create/" class="row g-3" id="paymentForm">
        {% csrf_token %}
        <div class="col-md-3">
          <label class="form-label">مبلغ</label>
          <input type="text" name="amount" class="form-control" placeholder="مثلاً ۲,۵۰۰,۰۰۰" required>
          <div class="form-text">ارقام فارسی/لاتین و ویرگول مجاز است.</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">تاریخ پرداخت</label>
          <!-- فیلد نمایشی شمسی -->
          <input type="text" id="pay_date" class="form-control" placeholder="YYYY/MM/DD" autocomplete="off">
          <!-- فیلد پنهان که میلادیِ درست را با name=date ارسال می‌کند -->
          <input type="hidden" name="date" id="pay_date_hidden">
          <div class="form-text">اگر خالی باشد، تاریخ امروز ثبت می‌شود.</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">روش پرداخت</label>
          <input type="text" name="method" class="form-control" placeholder="کارت/واریز/نقد...">
        </div>
        <div class="col-md-3">
          <label class="form-label">توضیحات</label>
          <input type="text" name="note" class="form-control" placeholder="اختیاری">
        </div>
        <!-- اضافه‌شده: فیلد پنهان JSON تخصیص -->
        <input type="hidden" name="alloc_json" id="alloc_json">
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">ثبت پرداخت</button>
        </div>
      </form>
    </div>
  </div>

  <!-- پرداخت‌ها -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white py-2 d-flex justify-content-between align-items-center">
      <span>پرداخت‌ها</span>
      <small class="text-white-50">جمع پرداخت‌ها: {{ total_paid|default:0|money_fa }}</small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th style="width:140px">تاریخ</th>
              <th class="num" style="width:140px">مبلغ</th>
              <th style="width:160px">وضعیت/تخصیص</th>  <!-- ← اضافه شد -->
              <th style="width:140px">روش</th>
              <th>توضیحات</th>
            </tr>
          </thead>
          <tbody>
            {% if payments %}
              {% for p in payments %}
                <tr>
                  <td class="num">{{ forloop.counter|int_fa }}</td>
                  <!-- تاریخِ ذخیره‌شده را به صورت ISO می‌گذاریم؛ JS پایین تصمیم می‌گیرد چگونه نمایش دهد -->
                  <td class="pdate" data-gdate="{{ p.date|date:'Y-m-d' }}">
                    {{ p.date|to_jalali:"%Y/%m/%d"|default_if_none:"—"|digits_fa }}
                  </td>
                  <td class="num">{{ p.amount|default:0|money_fa }}</td>
                  <td>
  {# Badge وضعیت با تکیه بر فیلد جدید allocation_status #}
  {% if p.allocation_status == 'allocated' %}
    <span class="status-chip status-alloc">کامل تخصیص‌یافته</span>
  {% elif p.allocation_status == 'partial' %}
    <span class="status-chip status-partial">بخشی تخصیص‌یافته</span>
  {% else %}
    <span class="status-chip status-unalloc">بدون تخصیص</span>
  {% endif %}

  {# خط دوم: خلاصه تخصیص بر اساس pay_sums (دیکشنری‌ای که قبلاً در همین صفحه استفاده می‌کنی) #}
  <div class="small mt-1">
    {% if pay_sums %}
      {% with pid=p.id|stringformat:"s" %}
        {% for item in pay_sums.items %}
          {% with sid=item.0 s=item.1 %}
            {% if sid|stringformat:"s" == pid %}
              تخصیص‌شده: <strong>{{ s.allocated|default:0|money_fa }}</strong>
              &nbsp;|&nbsp;
              باقیمانده:
              <strong class="{% if s.remaining|default:0 > 0 %}text-danger{% else %}text-success{% endif %}">
                {{ s.remaining|default:0|money_fa }}
              </strong>
            {% endif %}
          {% endwith %}
        {% endfor %}
      {% endwith %}
    {% else %}
      <span class="text-muted">(دادهٔ جمع تخصیص ارسال نشده)</span>
    {% endif %}
  </div>
</td>
                  <td>{% if p.method %}{{ p.method }}{% else %}—{% endif %}</td>
                  <td class="small">{{ p.note|default:"—" }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="5" class="text-center text-muted py-4">پرداختی ثبت نشده است.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

 <!-- اضافه‌شده: مودال تخصیص پیشرفته -->
<div class="modal fade" id="allocModal" tabindex="-1" aria-labelledby="allocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="allocModalLabel">تخصیص دستی پرداخت به فاکتورها (قدیمی→جدید)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">فقط فاکتورهای «صادر شده» که مانده دارند نمایش داده می‌شوند.</div>
          <div>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnAutoDistribute">توزیع خودکار</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0" id="allocTable">
            <thead>
              <tr>
                <th style="width:70px">#</th>
                <th style="width:140px">کد/شناسه</th>
                <th>بازه</th>
                <th class="num" style="width:140px">ماندهٔ باز</th>
                <th class="num" style="width:180px">مبلغ تخصیص</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invoices %}
                {% if inv.status == 'issued' and inv.amount_due|default:0 > 0 %}
                  <tr
                    data-invoice-id="{{ inv.id }}"
                    data-amount-due="{{ inv.amount_due|default:0 }}"
                    data-issued-at="{{ inv.issued_at|date:'Y-m-d' }}"
                  >
                    <td class="num">{{ forloop.counter|int_fa }}</td>
                    <td>
                      {% if inv.code %}<strong>{{ inv.code }}</strong>{% else %}—{% endif %}
                      <div class="small text-muted">ID: {{ inv.id|int_fa }}</div>
                    </td>
                    <td class="small">
                      {% if inv.period_from %}{{ inv.period_from|date:"Y/m/d"|digits_fa }}{% else %}—{% endif %}
                      <span class="mx-1">تا</span>
                      {% if inv.period_to %}{{ inv.period_to|date:"Y/m/d"|digits_fa }}{% else %}—{% endif %}
                    </td>
                    <td class="num due-cell">{{ inv.amount_due|default:0|money_fa }}</td>
                    <td class="num">
                      <input type="text" class="form-control form-control-sm alloc-input" placeholder="۰"
                             inputmode="decimal" dir="ltr" style="max-width: 160px;">
                      <div class="form-text small">≤ مانده</div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
              {% if not invoices or invoices|length == 0 %}
                <tr><td colspan="5" class="text-center text-muted py-4">فاکتور باز پیدا نشد.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <small class="me-auto text-muted">راهنما: مبلغ پرداخت را بالا وارد کنید؛ می‌توانید اینجا بین فاکتورها توزیع کنید.</small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
        <button type="button" class="btn btn-primary" id="btnApplyAlloc">اعمال تخصیص</button>
      </div>
    </div> <!-- /.modal-content -->
  </div>   <!-- /.modal-dialog -->
</div>     <!-- /#allocModal -->
<!-- /مودال -->

<!-- ✅ جزئیات تخصیص پرداخت‌ها: بیرون از مودال تا همیشه قابل مشاهده باشد -->
{% if payments %}
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-info text-white py-2">جزئیات تخصیص پرداخت‌ها</div>
    <div class="card-body">
      {% for p in payments %}
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold">
              پرداخت {{ forloop.counter|int_fa }} — مبلغ: {{ p.amount|default:0|money_fa }}
              <span class="text-muted small">(تاریخ: {{ p.date|to_jalali:"%Y/%m/%d"|digits_fa }})</span>
            </div>
            <div class="small">
              {% if pay_sums %}
                {% with pid=p.id|stringformat:"s" %}
                  {% for item in pay_sums.items %}
                    {% with sid=item.0 s=item.1 %}
                      {% if sid|stringformat:"s" == pid %}
                        تخصیص‌شده: <strong>{{ s.allocated|default:0|money_fa }}</strong>
                        &nbsp;|&nbsp;
                        باقیمانده:
                        <strong class="{% if s.remaining|default:0 > 0 %}text-danger{% else %}text-success{% endif %}">
                          {{ s.remaining|default:0|money_fa }}
                        </strong>
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                {% endwith %}
              {% else %}
                <span class="text-muted">(دادهٔ جمع تخصیص ارسال نشده)</span>
              {% endif %}
            </div>
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:160px">فاکتور</th>
                  <th class="num" style="width:160px">مبلغ تخصیص</th>
                </tr>
              </thead>
              <tbody>
                {% with pid=p.id %}
                  {% if pay_allocs %}
                    {% for item in pay_allocs.items %}
                      {% with aid=item.0 allocs=item.1 %}
                        {% if aid == pid %}
                          {% if allocs %}
                            {% for a in allocs %}
                              <tr>
                                <td>
                                  {% if a.invoice_id %}
                                    <a href="/billing/invoices/{{ a.invoice_id }}/">{{ a.invoice_code|default_if_none:"—" }}</a>
                                  {% else %}
                                    {{ a.invoice_code|default_if_none:"—" }}
                                  {% endif %}
                                </td>
                                <td class="num">{{ a.amount|default:0|money_fa }}</td>
                              </tr>
                            {% endfor %}
                          {% else %}
                            <tr><td colspan="2" class="text-muted text-center">تخصیصی برای این پرداخت ثبت نشده است.</td></tr>
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="2" class="text-muted text-center">دادهٔ ریز تخصیص‌ها ارسال نشده است.</td></tr>
                  {% endif %}
                {% endwith %}
              </tbody>
            </table>
          </div>
        </div>
        {% if not forloop.last %}<hr class="my-3">{% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
  <!-- /مودال -->

  <div class="text-center text-muted small mt-3">Doctor Account • v1.3</div>

</div>
{% endblock %}

{% block body_extra %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
  
  <script>
    (function(){
      // --- فعال‌سازی تقویم شمسی روی فیلد نمایشی (با اولویت DateUtils و fallback به persian-datepicker)
(function initJalaliPicker(){
  try {
    var $el = $("#pay_date");
    if (!$el.length) return;

    // اگر پروژه DateUtils مرکزی دارد، از همان استفاده کن
    if (window.DateUtils && typeof DateUtils.attachJalaliInput === 'function') {
      // اگر hidden مخصوص داری، از همون استفاده کن؛ وگرنه فقط ورودی نمایشی رو وصل کن
      var hidden = document.getElementById('pay_date_hidden');
      try {
        DateUtils.attachJalaliInput($el[0], hidden || null, { autoClose: true, format: 'YYYY/MM/DD' });
        return; // با موفقیت از DateUtils استفاده شد
      } catch (_) {}
    }

    // fallback: persian-datepicker
    // نکته: بعضی نسخه‌ها data-flag متفاوت دارند، پس بدون چکِ data از نو مقداردهی کن
    $el.persianDatepicker({
      format: 'YYYY/MM/DD',
      autoClose: true,
      calendar: { persian: { locale: 'fa' } }
    });

    // اگر به هر دلیل lazy-init شد، با فوکوس کاربر هم باز شود
    $el.on('focus', function(){
      try { $(this).persianDatepicker(); } catch(_){}
    });
  } catch(e) {
    console.warn('Jalali init error:', e);
  }
})();
})();
      // --- تبدیل مقدار شمسی به میلادی و ارسال در hidden[name=date]
      $("#paymentForm").on("submit", function(){
        var v = ($("#pay_date").val() || "").trim();
        if (!v){
          $("#pay_date_hidden").val(""); // خالی = بگذار سرور تاریخ امروز بگذارد
          return true;
        }
        try{
          // ورودی به شکل 1404/07/10
          var parts = v.replace(/-/g,'/').split('/');
          var jy = parseInt(parts[0],10),
              jm = parseInt(parts[1],10),
              jd = parseInt(parts[2],10);
          // تبدیل به میلادی با persian-date
          var g = persianDate.toGregorian(jy, jm, jd);  // {gy, gm, gd}
          var pad = function(n){ return (n<10?'0':'')+n; };
          var iso = g.gy + '-' + pad(g.gm) + '-' + pad(g.gd);
          $("#pay_date_hidden").val(iso);
        }catch(err){
          // اگر هر دلیلی نشد، همان مقدار را نگذار تا سرور خطا نگیرد
          $("#pay_date_hidden").val("");
        }
        return true;
      });

            // --- نمایش تاریخ پرداخت‌ها به‌صورت شمسیِ پایدار با اولویت استفاده از DateUtils ---
      (function formatPaymentDates(){
        function faDigits(s){
          if (window.DateUtils && typeof DateUtils.faDigits === 'function') {
            return DateUtils.faDigits(s+'');
          }
          return (s+'').replace(/\d/g, d=>"۰۱۲۳۴۵۶۷۸۹"[d]);
        }

        function toJalaliFromISO(iso){
          // اگر DateUtils در پروژه هست، از همون استفاده کن
          if (window.DateUtils) {
            // API های متداول که ممکن است در فایل شما باشد:
            if (typeof DateUtils.toJalaliStrFromISO === 'function') return DateUtils.toJalaliStrFromISO(iso);
            if (typeof DateUtils.toJalaliString    === 'function') return DateUtils.toJalaliString(iso);
            if (typeof DateUtils.gregorianToJalali === 'function') {
              try{
                var parts = (iso||'').split('-').map(Number);
                var j = DateUtils.gregorianToJalali(parts[0], parts[1], parts[2]); // [jy,jm,jd]
                var pad = n => (n<10?'0':'')+n;
                return j ? (j[0]+'/'+pad(j[1])+'/'+pad(j[2])) : '';
              }catch(e){}
            }
          }
          // fallback قدیمی با persian-date
          try{
            var g = new Date(iso + 'T00:00:00');
            // اگر تاریخ نامعتبر بود:
            if (isNaN(g.getTime())) return '';
            /* global persianDate */
            return new persianDate(g).calendar('persian').format('YYYY/MM/DD');
          }catch(e){
            return '';
          }
        }

        document.querySelectorAll('td.pdate[data-gdate]').forEach(function(td){
  var iso = (td.getAttribute('data-gdate')||'').trim();
  if (!iso) { td.textContent = '—'; return; }

  var y = parseInt(iso.slice(0,4),10);

  if (!isNaN(y) && y >= 1700) {
    // فقط اگر تبدیل واقعاً موفق شد، متن را عوض کن؛ وگرنه به خروجیِ درستِ سرور دست نزن
    var j = toJalaliFromISO(iso);
    if (j) {
      td.textContent = faDigits(j);
      td.classList.add('muted');
    }
  } else {
    // به‌نظر می‌رسد مقدار از قبل شمسی/نمایشی است؛ دست نزن
  }
});
      })();
  </script>

  <!-- اضافه‌شده: اسکریپت تخصیص دستی (کاملاً مستقل از بلوک قبلی) -->
  <script>
    (function(){
      function normalizeNumber(str){
        if (str == null) return 0;
        var s = String(str).trim();
        if (!s) return 0;
        var mapFa = {'۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9','٫':'.','٬':',','،':','};
        s = s.replace(/[۰-۹٫٬،]/g, function(c){ return mapFa[c] || c; }).replace(/,/g,'');
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }

      function buildAllocJSON(){
        var rows = document.querySelectorAll('#allocTable tbody tr[data-invoice-id]');
        var out = [];
        rows.forEach(function(tr){
          var id = parseInt(tr.getAttribute('data-invoice-id'), 10);
          var due = normalizeNumber(tr.getAttribute('data-amount-due'));
          var inp = tr.querySelector('input.alloc-input');
          var val = normalizeNumber(inp && inp.value);
          if (!id || !val) return;
          if (val > due) val = due;
          if (val > 0){
            out.push({invoice_id: id, amount: String(val)});
          }
        });
        return out;
      }

      function autoDistribute(){
        var total = normalizeNumber(document.querySelector('#paymentForm input[name="amount"]').value || 0);
        if (total <= 0) return;

        var rows = Array.from(document.querySelectorAll('#allocTable tbody tr[data-invoice-id]'));
        rows.sort(function(a,b){
          return String(a.getAttribute('data-issued-at')||'') < String(b.getAttribute('data-issued-at')||'') ? -1 : 1;
        });

        rows.forEach(function(tr){
          var inp = tr.querySelector('input.alloc-input');
          if (inp) inp.value = '';
        });

        var remaining = total;
        for (var i=0; i<rows.length && remaining>0; i++){
          var tr = rows[i];
          var due = normalizeNumber(tr.getAttribute('data-amount-due'));
          if (due <= 0) continue;
          var alloc = remaining >= due ? due : remaining;
          var inp = tr.querySelector('input.alloc-input');
          if (inp){ inp.value = String(alloc); }
          remaining -= alloc;
        }
      }

      document.getElementById('btnAutoDistribute') && document.getElementById('btnAutoDistribute').addEventListener('click', autoDistribute);

      document.getElementById('btnApplyAlloc') && document.getElementById('btnApplyAlloc').addEventListener('click', function(){
        var arr = buildAllocJSON();
        var hid = document.getElementById('alloc_json');
        if (hid) hid.value = arr.length ? JSON.stringify(arr) : '';
        var modalEl = document.getElementById('allocModal');
        if (window.bootstrap && modalEl){
          var m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          m.hide();
              // پاکسازی دفاعی اگر بک‌دراپ یا کلاس‌ها باقی ماندند
          setTimeout(function(){
            document.body.classList.remove('modal-open');
            document.querySelectorAll('.modal-backdrop').forEach(function(b){ b.remove(); });
            // اگر به هر دلیل خودِ مودال به حالت نمایش باقی مانده بود:
            modalEl.classList.remove('show');
            modalEl.setAttribute('aria-hidden','true');
            modalEl.style.display = 'none';
          }, 50);
        }
      });

      document.getElementById('paymentForm') && document.getElementById('paymentForm').addEventListener('submit', function(){
        var hid = document.getElementById('alloc_json');
        if (hid && !hid.value){
          var arr = buildAllocJSON();
          hid.value = arr.length ? JSON.stringify(arr) : '';
        }
      });
    })();
  </script>
{% endblock %}






