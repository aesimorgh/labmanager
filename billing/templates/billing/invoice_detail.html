{% extends "base_user_panel.html" %}
{% load static %}
{% load num_extras %}
{% load jalali_tags %}

{% block title %}جزئیات فاکتور{% endblock %}

{% block head_extra %}
  <!-- Bootstrap (مثل قبل) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ✅ حفظ ظاهر قبلی دقیقاً مثل نسخه‌ی شما */
    body { font-family: Tahoma, sans-serif; background: #f8f9fa; }
    .container-narrow { max-width: 1100px; }
    .invoice-head { display:flex; align-items:start; justify-content:space-between; gap:1rem; }
    .badge-status { font-size: .85rem; }
    .table thead th { background:#0d6efd; color:#fff; }
    .totals table th, .totals table td { padding:.35rem .5rem; }
    .sticky-actions { position: sticky; top: 0; background: #fff; z-index: 10; padding: .5rem 0 0.75rem; border-bottom: 1px solid #eee; }
    .is-embed body { background:#fff; }
    .is-embed .page-wrap { padding: 1rem; }
    .is-embed h5.title { font-size: 1rem; margin-bottom: .5rem; }
    .num { text-align:end; font-variant-numeric: tabular-nums; }

    /* برند/لوگو */
    .brand-wrap{ text-align:center; margin-top: .75rem; }
    .brand-logo{
      height:64px; max-width:240px; object-fit:contain; display:block; margin:0 auto .35rem;
    }
    .brand-title{ font-weight:800; font-size:1rem; }
    .brand-sub{ font-size:.9rem; color:#6c757d; margin-top:.1rem; }

    /* باکس اطلاعات بانکی */
    .bank-box{
      border:1px dashed #adb5bd; border-radius:.5rem; padding:.75rem 1rem; margin-top:1rem;
      background:#fcfcfd;
    }
    .bank-box h6{ margin:0 0 .5rem; font-weight:700; font-size:.95rem; color:#212529; }
    .bank-box .line{ margin:.15rem 0; }

    /* ⛔️ مخفی‌کردن هدر و تب‌های اسکلت برای حفظ ظاهر قدیمی همین صفحه */
    .header, .tabs { display:none !important; }
    main.container { padding-block: 0 !important; }
  </style>
  <script>
    // اگر داخل iframe بودیم، کلاس is-embed را به <html> اضافه کن تا استایل مینیمال مثل قبل اعمال شود
    (function(){
      try { if (window.self !== window.top) { document.documentElement.classList.add('is-embed'); } } catch(e){}
    })();
  </script>
{% endblock %}

{% block content %}
<div class="page-wrap container container-narrow py-3">

  <!-- هدر و اکشن‌ها -->
  <div class="sticky-actions">
    <div class="invoice-head">
      <div>
        <h5 class="title mb-1">
          فاکتور
          <span class="text-muted">#{{ invoice.id }}</span>
          {% if invoice.code %}<small class="text-muted">({{ invoice.code }})</small>{% endif %}
        </h5>
        <div class="text-muted small">
          پزشک:
          <strong>{{ invoice.doctor|default:"-" }}</strong>
          <span class="mx-2">|</span>
          وضعیت:
          {% with s=invoice.status %}
            {% if s == 'draft' or invoice.is_draft %}
              <span class="badge bg-warning-subtle text-warning-emphasis badge-status">پیش‌نویس</span>
            {% elif s == 'issued' %}
              <span class="badge bg-success-subtle text-success-emphasis badge-status">صادر شده</span>
            {% else %}
              <span class="badge bg-secondary-subtle text-secondary-emphasis badge-status">{{ s }}</span>
            {% endif %}
          {% endwith %}
          {% if invoice.issued_at %}
            <span class="mx-2">|</span>
            تاریخ صدور: {{ invoice.issued_at|to_jalali:"%Y/%m/%d" }}
          {% endif %}
          {% if invoice.period_from or invoice.period_to %}
            <span class="mx-2">|</span>
            بازه: {{ invoice.period_from|default:"-" }} تا {{ invoice.period_to|default:"-" }}
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-2">
        {% with s=invoice.status %}
          {% if s == 'draft' or invoice.is_draft %}
            <form method="post" action="/billing/invoices/{{ invoice.id }}/issue/{% if request.GET.embed == '1' %}?embed=1{% endif %}">
              {% csrf_token %}
              <button class="btn btn-success btn-sm">صدور</button>
            </form>
          {% endif %}
        {% endwith %}
        <a class="btn btn-outline-secondary btn-sm" href="/billing/invoices/{{ invoice.id }}/print/" target="_blank" rel="noopener">چاپ</a>
        <!-- دکمه بستن (برای مودال) -->
        <a id="btn-close-embed" class="btn btn-light btn-sm" href="#" title="بستن">بستن</a>
      </div>
    </div>
  </div>

  <!-- برند/لوگو (در صورت وجود پروفایل) -->
  {% if LAB_PROFILE %}
    {% if LAB_PROFILE.logo_file or LAB_PROFILE.logo_static_path or LAB_PROFILE.name or LAB_PROFILE.slogan %}
      <div class="brand-wrap">
        {% if LAB_PROFILE.logo_file %}
          <img class="brand-logo" src="{{ LAB_PROFILE.logo_file.url }}" alt="{{ LAB_PROFILE.name|default:'Lab' }}">
        {% elif LAB_PROFILE.logo_static_path %}
          <img class="brand-logo" src="{% static LAB_PROFILE.logo_static_path %}" alt="{{ LAB_PROFILE.name|default:'Lab' }}">
        {% endif %}
        {% if LAB_PROFILE.name %}<div class="brand-title">{{ LAB_PROFILE.name }}</div>{% endif %}
        {% if LAB_PROFILE.slogan %}<div class="brand-sub">{{ LAB_PROFILE.slogan }}</div>{% endif %}
      </div>
    {% endif %}
  {% endif %}

  <!-- خطوط فاکتور -->
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-primary text-white py-2">آیتم‌ها</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width:80px;">#</th>
              <th>شرح</th>
              <th class="text-end" style="width:150px;">تعداد</th>
              <th class="text-end" style="width:150px;">قیمت واحد</th>
              <th class="text-end" style="width:150px;">تخفیف</th>
              <th class="text-end" style="width:160px;">جمع خط</th>
            </tr>
          </thead>
          <tbody>
            {% for line in invoice.lines.all %}
              <tr>
                <td>{{ forloop.counter|int_fa }}</td>
                <td>
                  {% if line.order_id %}#{{ line.order_id }}{% endif %}
                  {% if line.description %} — {{ line.description }}{% endif %}
                </td>
                <td class="text-end">{{ line.unit_count|default:1|int_fa }}</td>
                <td class="text-end">{{ line.unit_price|default:0|money_fa }}</td>
                <td class="text-end">{{ line.discount_amount|default:0|money_fa }}</td>
                <td class="text-end">{{ line.line_total|default:0|money_fa }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">آیتمی ثبت نشده است.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- جمع‌ها -->
  <div class="row mt-3">
    <div class="col-lg-6"></div>
    <div class="col-lg-6">
      <div class="card totals shadow-sm">
        <div class="card-body">

          {# --- فرم ویرایش تخفیف و ماندهٔ قبلی (فقط در Draft) --- #}
          {% with s=invoice.status %}
          {% if s == 'draft' or invoice.is_draft %}
            <form method="post" action="" class="row g-2 align-items-end mb-3">
              {% csrf_token %}
              {% if request.GET.embed == '1' %}
                <input type="hidden" name="embed" value="1">
              {% endif %}

              <div class="col-sm-6">
                <label class="form-label small">تخفیف فاکتور</label>
                <input
                  type="text"
                  name="discount_amount"
                  class="form-control text-end"
                  inputmode="decimal"
                  placeholder="۰"
                  value="{{ invoice.discount_amount|default_if_none:'' }}"
                >
              </div>
              <div class="col-sm-6">
                <label class="form-label small">ماندهٔ قبلی</label>
                <input
                  type="text"
                  name="previous_balance"
                  class="form-control text-end"
                  inputmode="decimal"
                  placeholder="۰"
                  value="{{ invoice.previous_balance|default_if_none:'' }}"
                >
              </div>
              <div class="col-12 text-end">
                <button class="btn btn-primary btn-sm">ذخیره</button>
              </div>
              <div class="col-12">
                <small class="text-muted">می‌توانید اعداد فارسی، عربی یا با ویرگول وارد کنید؛ سیستم به‌صورت خودکار تبدیل می‌کند.</small>
              </div>
            </form>
          {% endif %}
          {% endwith %}

          <table class="w-100">
            {% if discount_total_ctx is not None %}
              <tr>
                <th class="text-end">جمع تخفیف خطوط:</th>
                <td class="num" style="width:180px;">{{ discount_total_ctx|default_if_none:0|money_fa }}</td>
              </tr>
            {% endif %}

            <tr>
              <th class="text-end">تخفیف فاکتور:</th>
              <td class="num">{{ invoice.discount_amount|default_if_none:0|money_fa }}</td>
            </tr>

            <tr>
              <th class="text-end">جمع کل پس از تخفیف‌ها:</th>
              <td class="num">{{ invoice.total_amount|default_if_none:0|money_fa }}</td>
            </tr>

            <tr>
              <th class="text-end">ماندهٔ قبلی:</th>
              <td class="num">{{ invoice.previous_balance|default_if_none:0|money_fa }}</td>
            </tr>

            <tr class="table-info">
              <th class="text-end">ماندهٔ قبل از پرداخت‌ها:</th>
              <td class="num">
                {% if amount_due_raw_ctx is not None %}
                  {{ amount_due_raw_ctx|money_fa }}
                {% else %}
                  {{ invoice.amount_due|default_if_none:0|money_fa }}
                {% endif %}
              </td>
            </tr>

            <tr>
              <th class="text-end">پرداخت‌های قبلی:</th>
              <td class="num {% if paid_total_ctx|default:0 == 0 %}text-muted{% else %}text-danger{% endif %}">
                − {{ paid_total_ctx|default_if_none:0|money_fa }}
              </td>
            </tr>

            <tr class="table-success">
              <th class="text-end">ماندهٔ نهایی قابل پرداخت:</th>
              <td class="num fw-bold">
                {% if amount_due_after_payments_ctx is not None %}
                  {{ amount_due_after_payments_ctx|money_fa }}
                {% else %}
                  {{ invoice.amount_due|default_if_none:0|money_fa }}
                {% endif %}
              </td>
            </tr>
          </table>

          <div class="small text-muted mt-2">
            <em>
              توضیح فرمول: <strong>ماندهٔ نهایی = (جمع کل پس از تخفیف‌ها + ماندهٔ قبلی) − پرداخت‌های قبلی</strong>.
            </em>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- اطلاعات بانکی (انتهای صفحه) -->
  <div class="bank-box">
    <h6>اطلاعات واریز</h6>

    {% if LAB_PROFILE %}
      <div class="line">
        شماره کارت:
        {% if LAB_PROFILE.card_no %}{{ LAB_PROFILE.card_no }}{% else %}-{% endif %}
      </div>
      <div class="line">
        شماره شبا:
        {% if LAB_PROFILE.iban %}{{ LAB_PROFILE.iban }}{% else %}-{% endif %}
      </div>
      <div class="line">
        بنام
        {% if LAB_PROFILE.account_name %}{{ LAB_PROFILE.account_name }}{% else %}-{% endif %}
      </div>
    {% else %}
      <div class="line">شماره کارت: 2828 3597 3310 6104</div>
      <div class="line">شماره شبا: IR80 0120 0100 0000 1226 4712 50</div>
      <div class="line">بنام زهرا پیشکاری</div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block body_extra %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // بستن مودال از داخل iframe (اگر در مودال باشیم)
    (function(){
      var btn = document.getElementById('btn-close-embed');
      if (!btn) return;
      btn.addEventListener('click', function(e){
        e.preventDefault();
        try {
          if (window.self !== window.top) {
            var modalEl = window.parent.document.getElementById('invoiceModal');
            if (modalEl && window.parent.bootstrap) {
              var inst = window.parent.bootstrap.Modal.getOrCreateInstance(modalEl);
              inst.hide();
              return;
            }
          }
        } catch(_) {}
        // اگر مودال نبود، برگرد به صفحهٔ قبل
        if (history.length > 1) history.back();
      });
    })();
  </script>
{% endblock %}















