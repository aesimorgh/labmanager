{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{% block title %}پنل کاربری{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--c-border:#e5e7eb;--c-bg:#fff;--c-muted:#6b7280;--c-active:#0d6efd;}
    body{margin:0;background:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Tahoma;}
    .container{max-width:1100px;margin-inline:auto;padding:1rem;}
    .header{background:var(--c-bg);border-bottom:1px solid var(--c-border);}
    .brand{display:flex;align-items:center;gap:.75rem;justify-content:flex-start;}
    .brand img{height:64px;width:auto;}
    .tabs{background:var(--c-bg);border-bottom:1px solid var(--c-border);position:sticky;top:0;z-index:10;}
    .nav{display:flex;gap:.5rem;list-style:none;margin:0;padding:.25rem 0;}
    .nav a{display:inline-block;padding:.5rem .75rem;border-radius:.5rem;text-decoration:none;color:#111827;}
    .nav a.active{background:rgba(13,110,253,.1);color:var(--c-active);font-weight:600;}
    .card{background:var(--c-bg);border:1px solid var(--c-border);border-radius:.75rem;}
    .card-body{padding:1rem;}
    .alert{padding:.75rem 1rem;border-radius:.5rem;margin-bottom:.5rem;border:1px solid var(--c-border);background:#fff;}
    .alert-success{border-color:#86efac;background:#f0fdf4;}
    .alert-error{border-color:#fca5a5;background:#fef2f2;}
    /* افزوده‌های کوچک برای تگ‌های دیگرِ پیام‌ها */
    .alert-info{border-color:#93c5fd;background:#eff6ff;}
    .alert-warning{border-color:#fcd34d;background:#fffbeb;}
    .small{font-size:.875rem;color:var(--c-muted);}
  </style>
  {% block head_extra %}{% endblock %}
  <script defer src="{% static 'js/date-utils.experimental.v1.js' %}"></script>
</head>
<body>

<header class="header">
  <div class="brand">
  {% if lab_profile %}
    {% with lf=lab_profile.get_logo_url %}
      {% if lf %}
        <img src="{{ lf }}" alt="لوگو">
      {% elif lab_profile.logo_static_path %}
        <img src="{% static lab_profile.logo_static_path %}" alt="لوگو">
      {% endif %}
    {% endwith %}
  {% endif %}
  <div>
    <strong>{{ lab_profile.name|default:"LabManager" }}</strong><br>
    <span class="small">
  {% if lab_profile.slogan %}{{ lab_profile.slogan }}{% endif %}
</span>
  </div>
</div>
</header>

<div class="tabs">
  <div class="container">
    <ul class="nav" role="tablist">
      <li><a data-key="/dashboard" href="/dashboard/" class="{% if '/dashboard' in request.path or request.path == '/' %}active{% endif %}">داشبورد</a></li>
      <li><a data-key="/orders"    href="/orders/"    class="{% if '/orders'    in request.path %}active{% endif %}">سفارش‌ها</a></li>
      <li><a data-key="/billing"   href="/billing/"   class="{% if '/billing'   in request.path %}active{% endif %}">مالی</a></li>
      <li><a data-key="/inventory" href="/inventory/" class="{% if '/inventory' in request.path %}active{% endif %}">انبارداری</a></li>
      <li><a data-key="/settings"  href="/settings/"  class="{% if '/settings'  in request.path %}active{% endif %}">تنظیمات</a></li>
    </ul>
  </div>
</div>

<main class="container" style="padding-block:1rem">
  {% block subtabs %}{% endblock %}

  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {# هردو حالت را پشتیبانی می‌کنیم + پیام پیش‌فرض اگر هیچ کدام نبود #}
  {% block content %}
    {% block body %}
      <div class="card"><div class="card-body">
        <p class="small">اسکلت پنل کاربری آماده است. صفحات دیگر می‌توانند از این قالب ارث‌بری کنند.</p>
      </div></div>
    {% endblock %}
  {% endblock %}
</main>

{% block body_extra %}{% endblock %}

<script>
(function(){
  const nav = document.querySelector('.tabs .nav');
  if(!nav) return;
  const links = Array.from(nav.querySelectorAll('a'));
  const path = (location && location.pathname) ? location.pathname.replace(/\/+$/,'') : '';

  // بر اساس data-key تطبیق می‌دهیم
  let matched = null;
  for (const a of links) {
    const key = (a.dataset.key || '').replace(/\/+$/,'');
    if (key && (path === key || path.startsWith(key + '/'))) {
      matched = a;
      break;
    }
  }

  // فقط اگر match پیدا شد، active را جابجا کن
  if (matched) {
    links.forEach(a => a.classList.remove('active'));
    matched.classList.add('active');
  }
})();
</script>
<script>
/* Date Guard + Loader Debug (financial panel)
   - لاگ می‌گیرد اگر فایل مرکزی لود نشده باشد
   - جلوی دوباره‌نویسی میلادی را می‌گیرد (enforce جلالی روی td.pdate[data-gdate])
   - اگر کسی دوباره میلادی نوشت، با stacktrace گزارش می‌دهد تا منبعِ خرابکار معلوم شود
*/
(function(){
  // 1) چک لود شدن فایل JS مرکزی
  if (!window.DateUtils) {
    console.warn('[DateUtils] NOT loaded -> {% static "js/date-utils.experimental.js" %}');
  } else {
    try {
      console.log('[DateUtils] loaded:', DateUtils.version || '(no version)');
    } catch(_) {}
  }

  // 2) کمکی‌ها
  function faDigits(s){ return (s+'').replace(/\d/g, d=>"۰۱۲۳۴۵۶۷۸۹"[d]); }
  function toJalaliFromISO(iso){
    if (!iso) return '';
    // اولویت با DateUtils
    try{
      if (window.DateUtils){
        if (typeof DateUtils.toJalaliStrFromISO === 'function') return DateUtils.toJalaliStrFromISO(iso);
        if (typeof DateUtils.toJalaliString    === 'function') return DateUtils.toJalaliString(iso);
        if (typeof DateUtils.gregorianToJalali === 'function'){
          var p = iso.split('-').map(Number);
          var j = DateUtils.gregorianToJalali(p[0], p[1], p[2]); // [jy,jm,jd]
          var pad = n => (n<10?'0':'')+n;
          return j ? (j[0]+'/'+pad(j[1])+'/'+pad(j[2])) : '';
        }
      }
    }catch(_){}
    // fallback با persian-date اگر باشد
    try{
      if (window.persianDate){
        var g = new Date(iso + 'T00:00:00');
        if (!isNaN(g.getTime())){
          return new persianDate(g).calendar('persian').format('YYYY/MM/DD');
        }
      }
    }catch(_){}
    return '';
  }

  function enforceJalali(td){
    if (!td) return;
    var iso = (td.getAttribute('data-gdate')||'').trim();
    if (!iso) return;
    var j = toJalaliFromISO(iso);
    // فقط اگر تبدیل واقعاً موفق شد، متن را عوض کن
    if (j) {
      td.textContent = faDigits(j);
      td.classList.add('muted');
      td.__jalali_done__ = true;
    }
  // در غیر این صورت، دست نزن (نمایشِ درستِ سرور را حفظ کن)
  }


  // 3) یکبار اجرا روی همه‌ی سلول‌های تاریخ
  function runOnce(){
    document.querySelectorAll('td.pdate[data-gdate]').forEach(enforceJalali);
  }
  runOnce();

  // 4) اگر کسی بعداً میلادی نوشت، هم گزارش بده هم دوباره جلالی کن
  var gPattern = /^\s*\d{4}[-/]\d{1,2}[-/]\d{1,2}\s*$/;
  var observer = new MutationObserver(function(muts){
    muts.forEach(function(m){
      var el = m.target && (m.target.nodeType===3 ? m.target.parentNode : m.target);
      if (!el || !el.matches || !el.matches('td.pdate[data-gdate]')) return;

      var iso = (el.getAttribute('data-gdate')||'').trim();
      var txt = (el.textContent||'').trim();

      // اگر تبدیل میلادی شد، گزارش + اصلاح
      if (gPattern.test(txt) && iso) {
        var err = new Error('Date overwritten to Gregorian: "'+ txt +'"');
        console.warn('[DateDebug] Overwrite on', el, '\nStack:\n', err.stack);
        enforceJalali(el);
      }
    });
  });
  observer.observe(document.body, { subtree:true, childList:true, characterData:true });

  // 5) برای بعضی race-conditionها بعد از load هم یکبار enforce کن
  window.addEventListener('load', function(){
    setTimeout(runOnce, 0);
    requestAnimationFrame(runOnce);
  });
})();
</script>
<!-- Global Jalali Formatter (runs late & keeps re-applying) -->
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script>
(function GlobalJalaliFormatter(){
  // تبدیل ارقام
  function faDigits(s){ return (s+'').replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]); }

  // تبدیل ISO→Jalali با اولویت DateUtils، بعد persian-date
  function toJalaliFromISO(iso){
    if (!iso) return '';
    try {
      if (window.DateUtils){
        if (typeof DateUtils.toJalaliStrFromISO === 'function') return DateUtils.toJalaliStrFromISO(iso);
        if (typeof DateUtils.toJalaliString    === 'function') return DateUtils.toJalaliString(iso);
        if (typeof DateUtils.gregorianToJalali === 'function'){
          var p = iso.split('-').map(Number);
          var j = DateUtils.gregorianToJalali(p[0], p[1], p[2]); // [jy,jm,jd]
          var pad = n => (n<10?'0':'')+n;
          return j ? (j[0]+'/'+pad(j[1])+'/'+pad(j[2])) : '';
        }
      }
    } catch(_){}

    try {
      if (window.persianDate){
        var g = new Date(iso + 'T00:00:00');
        if (!isNaN(g.getTime())) return new persianDate(g).calendar('persian').format('YYYY/MM/DD');
      }
    } catch(_){}
    return ''; // اگر نشد، چیزی برنگردان (تا با fallback بعدی فقط ارقام فارسی شود)
  }

  // فرمت همه‌ی تاریخ‌ها: فقط المان‌هایی که data-gdate دارند
  function formatAll(){
    document.querySelectorAll('.pdate[data-gdate]').forEach(function(el){
      if (el.__jalali_done__) return;   // یکبار بیشتر
      var iso = (el.getAttribute('data-gdate')||'').trim();
      if (!iso) { el.textContent = '—'; el.__jalali_done__ = true; return; }
      var j = toJalaliFromISO(iso);
      // فقط اگر تبدیل موفق بود، بنویس؛ وگرنه دست نزن
      if (j) {
        el.textContent = faDigits(j);
        el.__jalali_done__ = true;
      }
    });
  }

  // اجرا پس از لودِ کاملِ صفحه + چندبارِ تأخیری برای خنثی‌کردن اسکریپت‌های مزاحم
  function schedule(){
    formatAll();
    setTimeout(formatAll, 0);
    setTimeout(formatAll, 100);
    setTimeout(formatAll, 400);
  }

  document.addEventListener('DOMContentLoaded', schedule);
  window.addEventListener('load', schedule);
  document.addEventListener('visibilitychange', function(){
    if (!document.hidden) setTimeout(formatAll, 0);
  });

  // اگر بعداً محتوایی دینامیک اضافه شد، این متد در دسترس باشد
  window.__formatAllJalali = formatAll;
})();
</script>
</body>
</html>





