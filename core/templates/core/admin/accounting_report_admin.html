{% extends "admin/base_site.html" %}
{% load static %}
{% load jalali_tags %}
{% load num_extras %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tailwind.css' %}">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* Ù¾Ù‡Ù†Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Select2 */
    .select2-container { width: 100% !important; }

    /* ÙÛŒÚ©Ø³ Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ (Ø¯ÛŒÚ¯Ù‡ Ù†ØµÙÙ‡ Ù†Ø¨Ø§Ø´Ù‡) */
    .select2-container--default .select2-selection--single{
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      border-color: #d1d5db !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered{
      line-height: 40px !important;
      padding-right: .75rem !important;
      padding-left: 2rem !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      width: 100% !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow{
      height: 40px !important;
    }

    /* Dropdown Ù‡Ø§ Ø²ÛŒØ± Ø¹Ù†ØµØ± Ù‚Ø±Ø§Ø± Ù†Ú¯ÛŒØ±Ù†Ø¯ */
    .doctor-wrapper { position: relative; }
    .select2-dropdown { z-index: 20010 !important; background: #fff !important; }

    /* Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ØªÙ‚ÙˆÛŒÙ… */
    .pdp-picker { z-index: 20020 !important; }

    /* ÙˆØ±ÙˆØ¯ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§: LTR Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÙ¾ Ø¨Ø§ Ø§Ø³Ù„Ø´ */
    .jalali_date{ direction: ltr !important; text-align: left !important; font-variant-numeric: tabular-nums; }
  </style>
{% endblock %}

{% block content %}
<div class="container mx-auto my-6 px-4">

  <h1 class="text-center text-3xl font-bold mb-6 text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ / Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</h1>

  <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
  <div class="bg-white shadow-lg rounded-lg border-l-4 border-blue-500 mb-6 p-6">
    <h2 class="text-xl font-semibold text-blue-700 mb-4">ÙÛŒÙ„ØªØ± Ú¯Ø²Ø§Ø±Ø´</h2>

    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div class="md:col-span-2 doctor-wrapper">
        <label class="block font-medium text-gray-700 mb-1">Ø¯Ú©ØªØ±:</label>
        <select name="doctor"
                class="doctor-select w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                title="{{ doctor }}" dir="rtl">
          <option value="" {% if not doctor %}selected{% endif %}>Ù‡Ù…Ù‡ Ø¯Ú©ØªØ±Ù‡Ø§</option>
          {% for doc in doctors %}
            <option value="{{ doc|default_if_none:'' }}" {% if doc == doctor %}selected{% endif %} title="{{ doc }}">{{ doc }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
        <input type="text" name="start_date" value="{{ start_date }}"
               class="jalali_date w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
               placeholder="YYYY/MM/DD" autocomplete="off" dir="ltr">
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
        <input type="text" name="end_date" value="{{ end_date }}"
               class="jalali_date w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
               placeholder="YYYY/MM/DD" autocomplete="off" dir="ltr">
      </div>

      <div class="md:col-span-4">
        <button type="submit"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition">
          Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±
        </button>
      </div>
    </form>
  </div>

  <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ -->
  <div class="flex justify-end mb-4 gap-2">
    <a href="?export_excel=1{% if doctor %}&doctor={{ doctor }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
       class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition" title="Ø®Ø±ÙˆØ¬ÛŒ Excel">ğŸ’¾ Excel</a>
    <a href="?export_pdf=1{% if doctor %}&doctor={{ doctor }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
       class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition" title="Ø®Ø±ÙˆØ¬ÛŒ PDF">ğŸ“„ PDF</a>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="bg-gray-800 text-white font-bold text-lg p-3">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-300 text-center">
        <thead class="bg-blue-100">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Ø¨ÛŒÙ…Ø§Ø±</th>
            <th class="px-4 py-2">Ù¾Ø²Ø´Ú©</th>
            <th class="px-4 py-2">Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
            <th class="px-4 py-2">ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯</th>
            <th class="px-4 py-2">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
            <th class="px-4 py-2">Ù‚ÛŒÙ…Øª Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
            <th class="px-4 py-2">ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</th>
            <th class="px-4 py-2">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th>
            <th class="px-4 py-2">ÙˆØ¶Ø¹ÛŒØª</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for order in orders %}
          <tr class="{% if order.total_price > 1000000 %}bg-red-100{% elif order.total_price > 500000 %}bg-yellow-100{% else %}bg-white{% endif %}">
            <td class="px-4 py-2">{{ order.id|digits_fa }}</td>
            <td class="px-4 py-2">{{ order.patient_name }}</td>
            <td class="px-4 py-2" title="{{ order.doctor }}">{{ order.doctor }}</td>
            <td class="px-4 py-2">{{ order.get_order_type_display }}</td>
            <td class="px-4 py-2">{{ order.unit_count|digits_fa }}</td>
            <td class="px-4 py-2">{{ order.price|money_fa }}</td>
            <td class="px-4 py-2">{{ order.total_price|money_fa }}</td>
            <td class="px-4 py-2">{{ order.due_date|dash_to_slash|digits_fa }}</td>
            <td class="px-4 py-2">{{ order.created_at|to_jalali:"%Y/%m/%d"|digits_fa }}</td>
            <td class="px-4 py-2">
              {% if order.status == 'pending' %}
                <span class="px-2 py-1 rounded-md bg-yellow-300 text-yellow-800 font-medium">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
              {% elif order.status == 'completed' %}
                <span class="px-2 py-1 rounded-md bg-green-300 text-green-800 font-medium">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
              {% elif order.status == 'overdue' %}
                <span class="px-2 py-1 rounded-md bg-red-300 text-red-800 font-medium">Ù…Ø¹ÙˆÙ‚</span>
              {% else %}
                <span class="px-2 py-1 rounded-md bg-gray-300 text-gray-800 font-medium">{{ order.status }}</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-gray-500 italic py-4">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <h4 class="text-right mt-4 font-semibold text-gray-700">
    Ø¬Ù…Ø¹ Ú©Ù„ ÙØ§Ú©ØªÙˆØ±: {{ total_invoice|money_fa }} ØªÙˆÙ…Ø§Ù†
  </h4>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- âœ… Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±: persian-date 1.1.0 + persian-datepicker 1.2.0 -->
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function () {
  // 1) Ù‡Ø± Ù…Ù‚Ø¯Ø§Ø± Ø®Ø±Ø§Ø¨/Ù‚Ø¯ÛŒÙ…ÛŒÙ Ø¯Ø§Ø®Ù„ Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø®Ø§Ù„ÛŒ Ú©Ù†
  $("input.jalali_date").each(function(){
    var v = this.value || "";
    if (v && !/^\d{4}\/\d{2}\/\d{2}$/.test(v)) this.value = "";
  });

  // 2) Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ persian-date Ù†Ø³Ø®Ù‡ 1.x Ù„ÙˆØ¯ Ø´Ø¯Ù‡
  if (!(window.persianDate && typeof window.persianDate === "function")) {
    console.error("persian-date 1.x not loaded");
    return;
  }

  // 3) Ø§ÛŒÙ†ÛŒØª Â«ØµØ­ÛŒØ­Â» Ø¨Ø±Ø§ÛŒ persian-datepicker 1.2.0
  if ($.fn.persianDatepicker) {
    $("input.jalali_date").each(function(){
      var $inp = $(this);

      // Ø§ÛŒÙ†ÛŒØª
      $inp.persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: false,            // Ø®ÙˆØ¯Ú©Ø§Ø± Ú†ÛŒØ²ÛŒ Ù†Ø°Ø§Ø±Ù‡
        autoClose: true,
        observer: true,
        calendar: { persian: { locale: 'fa', leapYearMode: 'astronomical' } },
        toolbox: { todayButton: { enabled: true, text: { fa: 'Ø§Ù…Ø±ÙˆØ²' } } }
      });

      // 4) Â«Ø§Ù…Ø±ÙˆØ²Â» ÙˆØ§Ù‚Ø¹ÛŒÙ Ø´Ù…Ø³ÛŒ Ø±Ùˆ Ù‡Ù… Ø¯Ø± Input Ùˆ Ù‡Ù… Ø¯Ø± Ø®ÙˆØ¯ ÙˆÛŒØ¬Øª Ø³Øª Ú©Ù†
      // (ÙÙ‚Ø· Ø§Ú¯Ø± Ø§ÛŒÙ†Ù¾ÙˆØª Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯Ø› Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ø®Ø±Ø§Ø¨ Ù†Ú©Ù†ÛŒÙ…)
      if (!$inp.val()) {
        var today = new persianDate().startOf('day');
        // Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§ÛŒÙ†Ù¾ÙˆØª
        $inp.val(today.format('YYYY/MM/DD'));
        // Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø¯Ø§Ø®Ù„ Ù¾Ø§Ù¾â€ŒØ¢Ù¾ (Ø®ÙˆØ¯ ÙˆÛŒØ¬Øª)
        try {
          var api = $inp.data('datepicker'); // API Ø®ÙˆØ¯Ù persian-datepicker 1.2.0
          if (api && typeof api.setDate === 'function') {
            api.setDate(today);
          }
        } catch (e) {
          console.warn('setDate failed:', e);
        }
      }
    });
  } else {
    console.error('persianDatepicker plugin not found');
  }

  // 5) Select2 Ø¨Ø±Ø§ÛŒ Ø¯Ú©ØªØ± (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± ÙØ¹Ù„ÛŒ)
  var $doctorWrapper = $(".doctor-wrapper");
  if ($.fn.select2) {
    $(".doctor-select").select2({
      dir: "rtl",
      width: "100%",
      dropdownAutoWidth: false,
      dropdownParent: $doctorWrapper,
      minimumResultsForSearch: 10
    });
  }

  // 6) Ù¾Ø§Ù¾â€ŒØ¢Ù¾ ØªÙ‚ÙˆÛŒÙ… Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§Ù„Ø§ØªØ± Ø¯ÛŒØ¯Ù‡ Ø´ÙˆØ¯
  $(".pdp-picker").css("z-index", 20020);
});
</script>

{% endblock %}

























 
















