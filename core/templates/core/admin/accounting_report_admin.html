{% extends "admin/base_site.html" %}
{% load static %}
{% load jalali_tags %}
{% load num_extras %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tailwind.css' %}">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* پهنای کنترل Select2 */
    .select2-container { width: 100% !important; }
    .select2-selection--single { height: 2.5rem !important; display: flex; align-items: center; }
    .select2-selection__rendered { line-height: 2.5rem !important; }
    .select2-selection__arrow { height: 2.5rem !important; }

    /* رنگ متن گزینه‌ها */
    .select2-dropdown { background: #fff !important; }
    .select2-results__option { color: #111 !important; }
    .select2-container--default .select2-results__option--highlighted[aria-selected] { background:#3b82f6 !important; color:#fff !important; }
    .select2-container--default .select2-selection__rendered { color:#111 !important; }

    /* محدود کردن ارتفاع لیست نتایج */
    .select2-results__options { max-height: 240px !important; overflow-y: auto !important; }

    /* جلوگیری از بیرون‌زدن Dropdown */
    .doctor-wrapper { position: relative; }
    .doctor-wrapper .select2-container { max-width: 100% !important; }
    .doctor-wrapper .select2-dropdown {
      right: 0 !important;
      left: auto !important;
      width: 100% !important;
      max-width: 100% !important;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container mx-auto my-6 px-4">

  <h1 class="text-center text-3xl font-bold mb-6 text-gray-800">گزارش مالی / حسابداری</h1>

  <!-- فیلترها -->
  <div class="bg-white shadow-lg rounded-lg border-l-4 border-blue-500 mb-6 p-6">
    <h2 class="text-xl font-semibold text-blue-700 mb-4">فیلتر گزارش</h2>

    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div class="md:col-span-2 doctor-wrapper">
        <label class="block font-medium text-gray-700 mb-1">دکتر:</label>
        <select name="doctor"
                class="doctor-select w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                title="{{ doctor }}" dir="rtl">
          <option value="">همه دکترها</option>
          {% for doc in doctors %}
            <option value="{{ doc|default_if_none:'' }}" {% if doc == doctor %}selected{% endif %} title="{{ doc }}">{{ doc }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">از تاریخ:</label>
        <input type="text" name="start_date" value="{{ start_date }}"
               class="jalali_date w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
               placeholder="YYYY/MM/DD" autocomplete="off" dir="ltr">
      </div>

      <div>
        <label class="block font-medium text-gray-700 mb-1">تا تاریخ:</label>
        <input type="text" name="end_date" value="{{ end_date }}"
               class="jalali_date w-full rounded-md border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
               placeholder="YYYY/MM/DD" autocomplete="off" dir="ltr">
      </div>

      <div class="md:col-span-4">
        <button type="submit"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition">
          اعمال فیلتر
        </button>
      </div>
    </form>
  </div>

  <!-- دکمه‌های خروجی -->
  <div class="flex justify-end mb-4 gap-2">
    <a href="?export_excel=1{% if doctor %}&doctor={{ doctor }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
       class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition" title="خروجی Excel">💾 Excel</a>
    <a href="?export_pdf=1{% if doctor %}&doctor={{ doctor }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}"
       class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition" title="خروجی PDF">📄 PDF</a>
  </div>

  <!-- جدول -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="bg-gray-800 text-white font-bold text-lg p-3">لیست سفارش‌ها</div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-300 text-center">
        <thead class="bg-blue-100">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">بیمار</th>
            <th class="px-4 py-2">پزشک</th>
            <th class="px-4 py-2">نوع سفارش</th>
            <th class="px-4 py-2">تعداد واحد</th>
            <th class="px-4 py-2">قیمت واحد (تومان)</th>
            <th class="px-4 py-2">قیمت کل (تومان)</th>
            <th class="px-4 py-2">تاریخ تحویل</th>
            <th class="px-4 py-2">تاریخ ثبت</th>
            <th class="px-4 py-2">وضعیت</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for order in orders %}
          <tr class="{% if order.total_price > 1000000 %}bg-red-100{% elif order.total_price > 500000 %}bg-yellow-100{% else %}bg-white{% endif %}">
            <td class="px-4 py-2">{{ order.id|digits_fa }}</td>
            <td class="px-4 py-2">{{ order.patient_name }}</td>
            <td class="px-4 py-2" title="{{ order.doctor }}">{{ order.doctor }}</td>
            <td class="px-4 py-2">{{ order.get_order_type_display }}</td>
            <td class="px-4 py-2">{{ order.unit_count|digits_fa }}</td>

            <!-- قیمت واحد: جداکننده فارسی + ارقام فارسی -->
            <td class="px-4 py-2">{{ order.price|money_fa }}</td>

            <!-- قیمت کل: جداکننده فارسی + ارقام فارسی -->
            <td class="px-4 py-2">{{ order.total_price|money_fa }}</td>

            <!-- تاریخ تحویل: همین مقداری که نشون می‌دادی + تبدیل - به / + ارقام فارسی -->
            <td class="px-4 py-2">{{ order.due_date|dash_to_slash|digits_fa }}</td>

            <!-- تاریخ ثبت: جلالی + ارقام فارسی -->
            <td class="px-4 py-2">{{ order.created_at|to_jalali:"%Y/%m/%d"|digits_fa }}</td>

            <td class="px-4 py-2">
              {% if order.status == 'pending' %}
                <span class="px-2 py-1 rounded-md bg-yellow-300 text-yellow-800 font-medium">در انتظار</span>
              {% elif order.status == 'completed' %}
                <span class="px-2 py-1 rounded-md bg-green-300 text-green-800 font-medium">پرداخت شده</span>
              {% elif order.status == 'overdue' %}
                <span class="px-2 py-1 rounded-md bg-red-300 text-red-800 font-medium">معوق</span>
              {% else %}
                <span class="px-2 py-1 rounded-md bg-gray-300 text-gray-800 font-medium">{{ order.status }}</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-gray-500 italic py-4">هیچ سفارشی یافت نشد.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- جمع کل: جداکننده فارسی + ارقام فارسی -->
  <h4 class="text-right mt-4 font-semibold text-gray-700">
    جمع کل فاکتور: {{ total_invoice|money_fa }} تومان
  </h4>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- تقویم شمسی -->
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function () {
  $("input.jalali_date").persianDatepicker({
    format: 'YYYY/MM/DD',
    observer: true,
    autoClose: true
  });

  var $doctorWrapper = $(".doctor-wrapper");
  $(".doctor-select").select2({
    dir: "rtl",
    width: "100%",
    dropdownAutoWidth: false,
    dropdownParent: $doctorWrapper,
    placeholder: "همه دکترها"
  });
});
</script>

{% endblock %}


















 
















