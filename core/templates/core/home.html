{% load crispy_forms_tags %}
{% load num_extras %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Lab Manager</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Persian Datepicker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

  <style>
    body { font-family: Tahoma, sans-serif; background-color: #f8f9fa; direction: rtl; }
    h1 { margin: 30px 0; text-align: center; }
    .tab-content { margin-top: 1rem; }

    /* Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø¶Ø­ Ùˆ Ù‡Ù…â€ŒØªØ±Ø§Ø² */
    .table thead th{
      background-color:#0d6efd !important;
      color:#fff !important;
      vertical-align: middle; white-space: nowrap;
      padding-top:.6rem; padding-bottom:.6rem;
    }
    /* Ù„ÛŒÙ†Ú©Ù Ø³ÙˆØ±Øª: Ù‡Ù…ÛŒØ´Ù‡ Ø®ÙˆØ§Ù†Ø§ Ùˆ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© */
    .table thead th .sort-link{
      display:inline-block; color:inherit !important; text-decoration:none;
    }
    .table thead th .sort-link:hover{ opacity:.9; text-decoration:none; }
    .sort-arrow{ font-size:.9em; line-height:1; }

    .table tbody tr:nth-child(even) { background-color: #f1f3f5; }
    .table td, .table th { vertical-align: middle; }

    .badge { font-size: 0.9em; }
    .card-header { font-weight: bold; }
    .alert-success { margin-top: 1rem; }
    #order-row { flex-direction: row !important; }
    .pwt-datepicker-container { z-index: 2050 !important; }
    input[type="number"] { direction: ltr; text-align: left; }
    .en-num { direction: ltr; text-align: left; }

    /* ÙÛŒÙ„ØªØ± */
    .btn-chip { border-radius: 9999px; padding-inline: 0.9rem; }
    .input-group-sm .form-control { min-width: 95px; }
    .filter-row .form-select, .filter-row .form-control { height: 36px; padding-top: 2px; padding-bottom: 2px; }
  </style>
</head>
<body class="container">

<h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h1>

<ul class="nav nav-tabs" id="tabMenu" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-tab-pane" type="button" role="tab" aria-controls="order-tab-pane" aria-selected="true">
      ğŸ“ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab" aria-controls="list-tab-pane" aria-selected="false">
      ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
    </button>
  </li>
</ul>

<div class="tab-content" id="tabContent">
  <div class="tab-pane fade show active" id="order-tab-pane" role="tabpanel" aria-labelledby="order-tab">
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-primary text-white">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</div>
      <div class="card-body">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
          {% endfor %}
        {% endif %}

        <form method="post">
          {% csrf_token %}
          <div id="order-row" class="row g-3">
            <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª -->
            <div class="col-12 col-md-6 order-md-1">
              {{ order_form.patient_name|as_crispy_field }}
              {{ order_form.doctor|as_crispy_field }}
              {{ order_form.order_type|as_crispy_field }}
              {{ order_form.unit_count|as_crispy_field }}
            </div>
            <!-- Ø³ØªÙˆÙ† Ú†Ù¾ -->
            <div class="col-12 col-md-6 order-md-2">
              {{ order_form.shade|as_crispy_field }}
              {{ order_form.price|as_crispy_field }}
              {{ order_form.serial_number|as_crispy_field }}
              {{ order_form.status|as_crispy_field }}
              {{ order_form.order_date|as_crispy_field }}
              {{ order_form.due_date|as_crispy_field }}
              {{ order_form.notes|as_crispy_field }}
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-success">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="list-tab-pane" role="tabpanel" aria-labelledby="list-tab">
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-secondary text-white">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
      <div class="card-body table-responsive">
        <!-- ÙÛŒÙ„ØªØ± Ø³Ø±ÙˆØ±ÛŒ + Ø¬Ø³ØªØ¬Ùˆ -->
        <form method="get" class="row g-2 mb-3 filter-row" action="#list-tab-pane">
          <input type="hidden" name="sort" value="{{ sort }}">
          <input type="hidden" name="dir" value="{{ dir }}">
          <div class="col-md-4">
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¨ÛŒÙ…Ø§Ø± / Ù¾Ø²Ø´Ú© / Ø³Ø±ÛŒØ§Ù„ / Ø±Ù†Ú¯">
          </div>
          <div class="col-md-3">
            <select name="doctor" class="form-select">
              <option value="">Ù‡Ù…Ù‡ Ù¾Ø²Ø´Ú©â€ŒÙ‡Ø§</option>
              {% for d in doctors %}
                <option value="{{ d }}" {% if d == doctor %}selected{% endif %}>{{ d }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <select name="status" class="form-select">
              <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
              {% for val,label in status_choices %}
                <option value="{{ val }}" {% if val == status %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-primary flex-grow-1">Ø§Ø¹Ù…Ø§Ù„</button>
            <a class="btn btn-outline-secondary" href="?#list-tab-pane">Ø­Ø°Ù ÙÛŒÙ„ØªØ±</a>
          </div>
        </form>

        <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ù„ÙˆÛŒâ€ŒØµÙØ­Ù‡ (Ù…Ø«Ù„ Ù‚Ø¨Ù„) -->
        <input class="form-control mb-3" id="searchInput" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡...">

        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ø¨ÛŒÙ…Ø§Ø±</th>
              <th>Ù¾Ø²Ø´Ú©</th>
              <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
              <th>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„</th>
              <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>

              <!-- Ù‚ÛŒÙ…Øª Ú©Ù„ (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
              <th>
                <a class="sort-link"
                   href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=total_price&dir={% if sort == 'total_price' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                  Ù‚ÛŒÙ…Øª Ú©Ù„
                  <span class="sort-arrow">
                    {% if sort == 'total_price' %}
                      {% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                    {% else %}â†•{% endif %}
                  </span>
                </a>
              </th>

              <th>Ø±Ù†Ú¯</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>

              <!-- ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
              <th>
                <a class="sort-link"
                   href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=due_date&dir={% if sort == 'due_date' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                  ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„
                  <span class="sort-arrow">
                    {% if sort == 'due_date' %}
                      {% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                    {% else %}â†•{% endif %}
                  </span>
                </a>
              </th>

              <!-- ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
              <th>
                <a class="sort-link"
                   href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=created_at&dir={% if sort == 'created_at' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                  ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª
                  <span class="sort-arrow">
                    {% if sort == 'created_at' %}
                      {% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}
                    {% else %}â†•{% endif %}
                  </span>
                </a>
              </th>

              <th>Ø¬Ø²Ø¦ÛŒØ§Øª</th>
              <th>Ø§Ø±Ø³Ø§Ù„</th>
            </tr>
          </thead>

          <tbody id="ordersTable">
            {% for order in orders %}
              <tr>
                <td>{{ order.id|int_fa }}</td>
                <td>{{ order.patient_name }}</td>
                <td>{{ order.doctor }}</td>
                <td>{{ order.get_order_type_display }}</td>
                <td>{{ order.unit_count|int_fa }}</td>
                <td>{{ order.serial_number }}</td>
                <td>{{ order.price|money_fa }}</td>
                <td>{{ order.total_price|money_fa }}</td>
                <td>{{ order.shade }}</td>
                <td>
                  {% if order.status == 'done' %}
                    <span class="badge bg-success">{{ order.get_status_display }}</span>
                  {% elif order.status == 'in_progress' %}
                    <span class="badge bg-warning text-dark">{{ order.get_status_display }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ order.get_status_display }}</span>
                  {% endif %}
                </td>
                <td>{{ order.due_date|jalali_date }}</td>
                <td>{{ order.created_at|jalali_date }}</td>
                <td>
                  <a href="{% url 'core:order_detail' order.id %}" class="btn btn-sm btn-outline-primary btn-chip">Ø¬Ø²Ø¦ÛŒØ§Øª</a>
                </td>
                <td>
                  {% if not order.shipped_date %}
                    <form method="post" action="{% url 'core:deliver_order' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane" class="d-inline-block">
                      {% csrf_token %}
                      <div class="input-group input-group-sm" style="width: 180px;">
                        <input type="text" name="shipped_date" class="form-control jalali_date" placeholder="ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„">
                        <button type="submit" class="btn btn-success">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</button>
                      </div>
                    </form>
                  {% else %}
                    <span class="text-muted">{{ order.shipped_date|dash_to_slash|digits_fa }}</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="14" class="text-center text-muted">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if page_obj.paginator.num_pages > 1 %}
        <nav aria-label="pagination" class="mt-3">
          <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.previous_page_number }}#list-tab-pane">Ù‚Ø¨Ù„ÛŒ</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ù‚Ø¨Ù„ÛŒ</span></li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">{{ page_obj.number|int_fa }} / {{ page_obj.paginator.num_pages|int_fa }}</span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.next_page_number }}#list-tab-pane">Ø¨Ø¹Ø¯ÛŒ</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Ø¨Ø¹Ø¯ÛŒ</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function() {
  // Ø§Ú¯Ø± Ú©ÙˆØ¦Ø±ÛŒâ€ŒØ§Ø³ØªØ±ÛŒÙ†Ú¯ Ø¯Ø§Ø´ØªÛŒÙ… ÛŒØ§ Ù‡ÙØ´ Ù„ÛŒØ³Øª Ø¨ÙˆØ¯ØŒ ØªØ¨ Â«Ù„ÛŒØ³ØªÂ» Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
  try {
    if (window.location.search || window.location.hash === '#list-tab-pane') {
      var triggerEl = document.querySelector('#list-tab');
      if (triggerEl) new bootstrap.Tab(triggerEl).show();
    }
  } catch (e) {}

  // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¯Ø± ÙØ±Ù… Ø«Ø¨Øª Ùˆ ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Â«Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Â»
  const $dateInputs = $("#order-tab-pane input.jalali_date, #order-tab-pane input[name='order_date'], #order-tab-pane input[name='due_date'], #list-tab-pane input.jalali_date");
  $dateInputs.each(function(){
    try { if (this.type !== 'text') this.type = 'text'; } catch(e){}
    $(this).attr('autocomplete', 'off');
  });
  $dateInputs.filter(function(){ return !$(this).data('pDatepicker'); })
      .persianDatepicker({ format: 'YYYY/MM/DD', autoClose: true, calendar: { persian: { locale: 'fa' } } });

  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡
  $("#searchInput").on("keyup", function() {
    let value = $(this).val().toLowerCase();
    $("#ordersTable tr").filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
    });
  });
});
</script>
</body>
</html>



























































