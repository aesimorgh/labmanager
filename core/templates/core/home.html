core/templates/core/home.html:
{% extends "base_user_panel.html" %}
{% load crispy_forms_tags %}
{% load num_extras %}
{% load jalali_tags %}
{% load static %}
{% block title %}Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§{% endblock %}

{% block head_extra %}
  <!-- Bootstrap 5 + Persian Datepicker (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØµÙØ­Ù‡) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <style>
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø§ÛŒÙ† ØµÙØ­Ù‡ */
    h1 { margin: 30px 0; text-align: center; }
    .tab-content { margin-top: 1rem; }

    /* Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø¶Ø­ Ùˆ Ù‡Ù…â€ŒØªØ±Ø§Ø² */
    .table thead th{
      background-color:#0d6efd !important;
      color:#fff !important;
      vertical-align: middle; white-space: nowrap;
      padding-top:.6rem; padding-bottom:.6rem;
    }
    .table thead th .sort-link{ display:inline-block; color:inherit !important; text-decoration:none; }
    .table thead th .sort-link:hover{ opacity:.9; text-decoration:none; }
    .sort-arrow{ font-size:.9em; line-height:1; }

    .table tbody tr:nth-child(even) { background-color: #f1f3f5; }
    .table td, .table th { vertical-align: middle; }

    .badge { font-size: 0.9em; }
    .card-header { font-weight: bold; }
    .alert-success { margin-top: 1rem; }
    #order-row { flex-direction: row !important; }
    .pwt-datepicker-container { z-index: 2050 !important; }
    input[type="number"] { direction: ltr; text-align: left; }
    .en-num { direction: ltr; text-align: left; }

    /* ÙÛŒÙ„ØªØ± */
    .btn-chip { border-radius: 9999px; padding-inline: 0.9rem; }
    .input-group-sm .form-control { min-width: 95px; }
    .filter-row .form-select, .filter-row .form-control { height: 36px; padding-top: 2px; padding-bottom: 2px; }

    /* ===== Tooth Picker (Ú†ÛŒÙ¾â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„) ===== */
    .tooth-card{
      width:100%;
      background:#fff; border:1px solid #dee2e6; border-radius:.65rem;
      padding:1rem; margin-top:.25rem; overflow:hidden; box-sizing:border-box;
    }
    .tooth-card .section-title{font-weight:700;margin-bottom:.5rem}
    .tooth-row{ margin:0; }

    .tooth-grid{
      display:flex; flex-wrap:nowrap; align-items:center;
      justify-content:space-between; width:100%;
      gap:.4rem; padding:0 .25rem; box-sizing:border-box;
    }
    .tooth-group{
      display:flex; align-items:center; gap:.35rem;
      justify-content:space-between; flex:1 1 0; min-width:0;
    }

    /* Ø®Ø· Ø¹Ù…ÙˆØ¯ÛŒ Ù†Ù‚Ø·Ù‡â€ŒÚ†ÛŒÙ† Ø¨ÛŒÙ† Ø¯Ùˆ Â«Û±Â» (Ø±Ø§Ø³Øª/Ú†Ù¾) */
    .midline{
      width:0; height:28px; position:relative; flex:0 0 0;
      border-left:2px dashed #9ca3af;
    }

    /* Ø®Ø· Ø§ÙÙ‚ÛŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨ÛŒÙ† Ø¯Ùˆ Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† */
    .sep-h{
      height:0; border-top:2px dashed #9ca3af;
      margin:.5rem 0;
      pointer-events:none;
    }

    .tooth-chip{
      border:1px solid #dee2e6;background:#fff;border-radius:9999px;
      padding:.24rem .5rem; font-size:.9rem; line-height:1.1; cursor:pointer; user-select:none;
      flex:0 0 auto;
    }
    .tooth-chip.active{background:#0d6efd;color:#fff;border-color:#0d6efd}

    .tooth-help{color:#6b7280;font-size:.86rem;margin-top:.3rem}
    .tooth-actions{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.45rem}
    .tooth-summary{margin-top:.4rem;color:#374151;font-size:.92rem}

    /* ===== Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§: Ø§Ø³Ú©Ø±ÙˆÙ„ Ùˆ Ø§Ø³ØªÛŒÚ©ÛŒ ===== */
    .table-wrap {
      position: relative;
      max-height: 65vh;
      overflow: auto;
      border: 1px solid #e5e7eb;
      border-radius: .5rem;
    }
    .table thead th{
      position: sticky; top: 0; z-index: 5;
      background-color:#0d6efd !important; color:#fff !important;
    }
    .sticky-patient {
      position: sticky; right: 0; z-index: 6;
      background: #fff;
      box-shadow: -4px 0 0 rgba(13,110,253,.08);
      white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
      max-width: 220px;
    }

    /* Ù†Ù…Ø§ÛŒ Ù†Ù…Ø§Ø¯ÛŒÙ† Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ù„ÛŒØ³Øª (Ø§Ú¯Ø± Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯) */
    .toothplus-cell{ min-width: 92px; }
    .toothplus{ position: relative; width: 80px; height: 80px; margin: 0 auto; font-size: 12px; line-height: 1.1; color:#111; user-select:none; }
    .toothplus::before, .toothplus::after{ content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#9ca3af; }
    .toothplus::before{ width:2px; height:86%; }
    .toothplus::after { height:2px; width:86%; }
    .tp{ position:absolute; display:flex; gap:2px; flex-wrap:wrap; max-width:40px; }
    .tp span{ padding:0 2px; border-radius:4px; }
    /* Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ Ù…Ø±Ú©Ø² + Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… */
    .tp-ur{ top:12px; right:18px; justify-content:flex-end; text-align:right; }
    .tp-ul{ top:12px; left:18px;  text-align:left; }
    .tp-ll{ bottom:12px; left:18px; text-align:left; }
    .tp-lr{ bottom:12px; right:18px; justify-content:flex-end; text-align:right; }

     /* Ú©Ù…ÛŒ Ø¬Ù…Ø¹â€ŒÙˆØ¬ÙˆØ±ØªØ± Ø´Ø¯Ù† Ú†ÛŒØ¯Ù…Ø§Ù† Ø¯Ø§Ø®Ù„ Ù‡Ø± Ø±Ø¨Ø¹ (Ø§Ø®ØªÛŒØ§Ø±ÛŒÙ Ø³Ø¨Ú©) */
    .tp{ max-width:34px; gap:1px; }

    .tp span.active{ background:#0d6efd; color:#fff; }
  </style>
{% endblock %}

{% block subtabs %}
  <!-- Ø³Ø§Ø¨â€ŒØªØ¨â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
  <ul class="nav nav-tabs" id="tabMenu" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-tab-pane" type="button" role="tab" aria-controls="order-tab-pane" aria-selected="true">
        ğŸ“ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab" aria-controls="list-tab-pane" aria-selected="false">
        ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
      </button>
    </li>
  </ul>
{% endblock %}

{% block content %}
  <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h1>

  <div class="tab-content" id="tabContent">
    <!-- ØªØ¨: Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ -->
    <div class="tab-pane fade show active" id="order-tab-pane" role="tabpanel" aria-labelledby="order-tab">
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-primary text-white">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
          {% endif %}

          <form method="post">
            {% csrf_token %}

            <div id="order-row" class="row g-3">
              <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª -->
              <div class="col-12 col-md-6 order-md-1">
                {{ order_form.patient_name|as_crispy_field }}
                {{ order_form.doctor|as_crispy_field }}
                {{ order_form.order_type|as_crispy_field }}
                {{ order_form.unit_count|as_crispy_field }}

                <!-- ===== Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ ===== -->
                <div class="tooth-card">
                  <div class="section-title">Ø´Ù…Ø§Ø±Ù‡ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§</div>

                  <!-- Ø®Ù„Ø§ØµÙ‡ -->
                  <div id="tooth-summary" class="tooth-summary text-muted">Ù‡Ù†ÙˆØ² Ø¯Ù†Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>

                  <!-- Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§ -->
                  <div class="tooth-row">
                    <div class="tooth-grid">
                      <!-- Ø¨Ø§Ù„Ø§ Ø±Ø§Ø³Øª (Q1: 18..11) -->
                      <div class="tooth-group" aria-label="Ø¨Ø§Ù„Ø§ Ø±Ø§Ø³Øª">
                        <span class="tooth-chip" data-q="1" data-n="8">8</span>
                        <span class="tooth-chip" data-q="1" data-n="7">7</span>
                        <span class="tooth-chip" data-q="1" data-n="6">6</span>
                        <span class="tooth-chip" data-q="1" data-n="5">5</span>
                        <span class="tooth-chip" data-q="1" data-n="4">4</span>
                        <span class="tooth-chip" data-q="1" data-n="3">3</span>
                        <span class="tooth-chip" data-q="1" data-n="2">2</span>
                        <span class="tooth-chip" data-q="1" data-n="1">1</span>
                      </div>

                      <span class="midline" aria-hidden="true"></span>

                      <!-- Ø¨Ø§Ù„Ø§ Ú†Ù¾ (Q2: 21..28) -->
                      <div class="tooth-group" aria-label="Ø¨Ø§Ù„Ø§ Ú†Ù¾">
                        <span class="tooth-chip" data-q="2" data-n="1">1</span>
                        <span class="tooth-chip" data-q="2" data-n="2">2</span>
                        <span class="tooth-chip" data-q="2" data-n="3">3</span>
                        <span class="tooth-chip" data-q="2" data-n="4">4</span>
                        <span class="tooth-chip" data-q="2" data-n="5">5</span>
                        <span class="tooth-chip" data-q="2" data-n="6">6</span>
                        <span class="tooth-chip" data-q="2" data-n="7">7</span>
                        <span class="tooth-chip" data-q="2" data-n="8">8</span>
                      </div>
                    </div>
                  </div>

                  <!-- Ø®Ø· Ø§ÙÙ‚ÛŒ ÙˆØ³Ø· -->
                  <div class="sep-h" aria-hidden="true"></div>

                  <!-- Ø±Ø¯ÛŒÙ Ù¾Ø§ÛŒÛŒÙ† -->
                  <div class="tooth-row">
                    <div class="tooth-grid">
                      <!-- Ù¾Ø§ÛŒÛŒÙ† Ú†Ù¾ (Q3: 38..31) -->
                      <div class="tooth-group" aria-label="Ù¾Ø§ÛŒÛŒÙ† Ú†Ù¾">
                        <span class="tooth-chip" data-q="3" data-n="8">8</span>
                        <span class="tooth-chip" data-q="3" data-n="7">7</span>
                        <span class="tooth-chip" data-q="3" data-n="6">6</span>
                        <span class="tooth-chip" data-q="3" data-n="5">5</span>
                        <span class="tooth-chip" data-q="3" data-n="4">4</span>
                        <span class="tooth-chip" data-q="3" data-n="3">3</span>
                        <span class="tooth-chip" data-q="3" data-n="2">2</span>
                        <span class="tooth-chip" data-q="3" data-n="1">1</span>
                      </div>

                      <span class="midline" aria-hidden="true"></span>

                      <!-- Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª (Q4: 41..48) -->
                      <div class="tooth-group" aria-label="Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª">
                        <span class="tooth-chip" data-q="4" data-n="1">1</span>
                        <span class="tooth-chip" data-q="4" data-n="2">2</span>
                        <span class="tooth-chip" data-q="4" data-n="3">3</span>
                        <span class="tooth-chip" data-q="4" data-n="4">4</span>
                        <span class="tooth-chip" data-q="4" data-n="5">5</span>
                        <span class="tooth-chip" data-q="4" data-n="6">6</span>
                        <span class="tooth-chip" data-q="4" data-n="7">7</span>
                        <span class="tooth-chip" data-q="4" data-n="8">8</span>
                      </div>
                    </div>
                  </div>

                  <div class="tooth-actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bulk="upper-all">Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡Ù” ÙÚ© Ø¨Ø§Ù„Ø§</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bulk="lower-all">Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡Ù” ÙÚ© Ù¾Ø§ÛŒÛŒÙ†</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bulk="clear">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
                  </div>

                  <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ FDI Codes -->
                  <input type="hidden" name="order-teeth_fdi" id="teeth_fdi" value="">
                  <input type="hidden" name="teeth_fdi" id="teeth_fdi_mf" value="">
                  <div class="tooth-help">Ø±Ø§Ù‡Ù†Ù…Ø§: Ú©Ø¯Ú¯Ø°Ø§Ø±ÛŒ FDI (Û±Û±â€“Û±Û¸ Ø¨Ø§Ù„Ø§ Ø±Ø§Ø³ØªØŒ Û²Û±â€“Û²Û¸ Ø¨Ø§Ù„Ø§ Ú†Ù¾ØŒ Û³Û±â€“Û³Û¸ Ù¾Ø§ÛŒÛŒÙ† Ú†Ù¾ØŒ Û´Û±â€“Û´Û¸ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª). Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Â«ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÂ» Ù†ÛŒØ² Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                </div>
                <!-- ===== Ù¾Ø§ÛŒØ§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ ===== -->
              </div>

              <!-- Ø³ØªÙˆÙ† Ú†Ù¾ -->
              <div class="col-12 col-md-6 order-md-2">
                {{ order_form.shade|as_crispy_field }}
                {{ order_form.price|as_crispy_field }}
                {{ order_form.serial_number|as_crispy_field }}
                <input type="hidden" name="order-status" value="in_progress">
                {# {{ order_form.status|as_crispy_field }} #}
                {{ order_form.order_date|as_crispy_field }}
                {{ order_form.due_date|as_crispy_field }}
                {{ order_form.notes|as_crispy_field }}
              </div>
            </div>

            <div class="mt-3">
              <button type="submit" class="btn btn-success">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- ØªØ¨: Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
    <div class="tab-pane fade" id="list-tab-pane" role="tabpanel" aria-labelledby="list-tab">
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-secondary text-white">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
        <div class="card-body">

          <!-- ÙÛŒÙ„ØªØ± Ø³Ø±ÙˆØ±ÛŒ + Ø¬Ø³ØªØ¬Ùˆ -->
          <form method="get" class="row g-2 mb-3 filter-row" action="#list-tab-pane">
            <input type="hidden" name="sort" value="{{ sort }}">
            <input type="hidden" name="dir" value="{{ dir }}">
            <div class="col-md-4">
              <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¨ÛŒÙ…Ø§Ø± / Ù¾Ø²Ø´Ú© / Ø³Ø±ÛŒØ§Ù„ / Ø±Ù†Ú¯">
            </div>
            <div class="col-md-3">
              <select name="doctor" class="form-select">
                <option value="">Ù‡Ù…Ù‡ Ù¾Ø²Ø´Ú©â€ŒÙ‡Ø§</option>
                {% for d in doctors %}
                  <option value="{{ d }}" {% if d == doctor %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <select name="status" class="form-select">
                <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                {% for val,label in status_choices %}
                  <option value="{{ val }}" {% if val == status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex gap-2">
              <button class="btn btn-primary flex-grow-1">Ø§Ø¹Ù…Ø§Ù„</button>
              <a class="btn btn-outline-secondary" href="?#list-tab-pane">Ø­Ø°Ù ÙÛŒÙ„ØªØ±</a>
            </div>
          </form>

          <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ù„ÙˆÛŒâ€ŒØµÙØ­Ù‡ -->
          <input class="form-control mb-3" id="searchInput" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡...">

          <div class="table-wrap">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th class="sticky-patient">Ø¨ÛŒÙ…Ø§Ø±</th>
                <th>Ù¾Ø²Ø´Ú©</th>
                <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
                <th>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯</th>
                <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„</th>
                <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>

                <!-- Ù‚ÛŒÙ…Øª Ú©Ù„ (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
                <th>
                  <a class="sort-link"
                     href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=total_price&dir={% if sort == 'total_price' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                    Ù‚ÛŒÙ…Øª Ú©Ù„
                    <span class="sort-arrow">{% if sort == 'total_price' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                  </a>
                </th>

                <th>Ø±Ù†Ú¯</th>
                <th>Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>

                <!-- ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
                <th>
                  <a class="sort-link"
                     href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=due_date&dir={% if sort == 'due_date' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                    ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„
                    <span class="sort-arrow">{% if sort == 'due_date' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                  </a>
                </th>

                <!-- ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª (Ù‚Ø§Ø¨Ù„ Ø³ÙˆØ±Øª) -->
                <th>
                  <a class="sort-link"
                     href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=created_at&dir={% if sort == 'created_at' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                    ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª
                    <span class="sort-arrow">{% if sort == 'created_at' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                  </a>
                </th>

                <th>Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
                <th>Ø§Ø±Ø³Ø§Ù„</th>
              </tr>
            </thead>

            <tbody id="ordersTable">
              {% for order in orders %}
  <tr>
    <td>{{ order.id|int_fa }}</td>
    <td class="sticky-patient">{{ order.patient_name }}</td>
    <td>{{ order.doctor }}</td>
    <td>{{ order.get_order_type_display }}</td>
    <td>{{ order.unit_count|int_fa }}</td>
    <td>{{ order.serial_number }}</td>
    <td>{{ order.price|money_fa }}</td>
    <td>{{ order.total_price|money_fa }}</td>
    <td>{{ order.shade }}</td>
    <td class="toothplus-cell">
      <div class="toothplus"
           data-q="{% if order.teeth_fdi %}{% else %}{{ order.teeth_quadrants|default:'' }}{% endif %}"
           data-fdi="{{ order.teeth_fdi|default:'' }}"
           data-notes="{{ order.notes|default_if_none:''|striptags }}">
        <div class="tp tp-ul"></div>
        <div class="tp tp-ur"></div>
        <div class="tp tp-ll"></div>
        <div class="tp tp-lr"></div>
      </div>
    </td>
    <td>
      {% if order.status == 'done' %}
        <span class="badge bg-success">{{ order.get_status_display }}</span>
      {% elif order.status == 'in_progress' %}
        <span class="badge bg-warning text-dark">{{ order.get_status_display }}</span>
      {% else %}
        <span class="badge bg-secondary">{{ order.get_status_display }}</span>
      {% endif %}
    </td>

    {# Ù€Ù€Ù€Ù€Ù€ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§: ÙÙ‚Ø· Ø³Ø±ÙˆØ±ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø± Ù€Ù€Ù€Ù€Ù€ #}
    <td>{{ order.due_date|jalali_date|digits_fa }}</td>
    <td>{{ order.order_date|jalali_date|digits_fa }}</td>

    <td>
      <a href="{% url 'core:order_detail' order.id %}"
         class="btn btn-sm btn-outline-primary btn-chip">Ø¬Ø²Ø¦ÛŒØ§Øª</a>
    </td>
    <td>
      <a href="{% url 'core:order_edit' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
         class="btn btn-sm btn-outline-warning btn-chip">ÙˆÛŒØ±Ø§ÛŒØ´</a>
    </td>

    <td>
      {% if not order.shipped_date %}
        <form method="post"
              action="{% url 'core:deliver_order' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
              class="d-inline-block">
          {% csrf_token %}
          <div class="input-group input-group-sm" style="width: 200px;">
            <input type="text" name="shipped_date" class="form-control jalali_date" placeholder="ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„">
            <button type="submit" class="btn btn-success">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</button>
          </div>
        </form>
      {% else %}
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted">{{ order.shipped_date|dash_to_slash|digits_fa }}</span>
          <form method="post"
                action="{% url 'core:deliver_order' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
                class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="undo" value="1">
            <button type="submit" class="btn btn-outline-danger btn-sm">Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†</button>
          </form>
        </div>
      {% endif %}
    </td>
  </tr>
{% empty %}
  <tr>
    <td colspan="16" class="text-center text-muted">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
  </tr>
{% endfor %}
</tbody>
</table>
</div> <!-- /.table-wrap -->

{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="pagination" class="mt-3">
  <ul class="pagination pagination-sm justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.previous_page_number }}#list-tab-pane">Ù‚Ø¨Ù„ÛŒ</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Ù‚Ø¨Ù„ÛŒ</span></li>
    {% endif %}
    <li class="page-item disabled">
      <span class="page-link">{{ page_obj.number|int_fa }} / {{ page_obj.paginator.num_pages|int_fa }}</span>
    </li>
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.next_page_number }}#list-tab-pane">Ø¨Ø¹Ø¯ÛŒ</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Ø¨Ø¹Ø¯ÛŒ</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

</div>
</div>
</div>
</div>
{% endblock %}

{% block body_extra %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Feature flags (Ø®Ø§Ù…ÙˆØ´ Ù¾ÛŒØ´â€ŒÙØ±Ø¶Ø› ÙÙ‚Ø· Ø¨Ø§ ?tp=1 / ?dp=1 Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯) -->
  <script>
    window.__TP_FLAG__ = !/(?:^|[?&])tp=0(?:&|$)/.test(location.search);
    window.__DP_FLAG__ = !/(?:^|[?&])dp=0(?:&|$)/.test(location.search);
  </script>

  <!-- Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ (ÙØ¹Ù„Ø§Ù‹ ØµØ±ÙØ§Ù‹ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› Ø§Ø¬Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹) -->
  <script src="{% static 'js/toothpicker.experimental.v1.js' %}?v=20251009"></script>
  <script src="{% static 'js/date-utils.experimental.v1.js' %}?v=20251009"></script>

 <script>
  $(function() {
    const TP = !!window.__TP_FLAG__; // Tooth Picker Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒØŸ
    const DP = !!window.__DP_FLAG__; // ØªØ§Ø±ÛŒØ® Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒØŸ

    // --- ØªØ¨ Ù„ÛŒØ³Øª Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† query/hash
    try {
      if (window.location.search || window.location.hash === '#list-tab-pane') {
        var triggerEl = document.querySelector('#list-tab');
        if (triggerEl) new bootstrap.Tab(triggerEl).show();
      }
    } catch (e) {}

   // ØªØ§Ø±ÛŒØ® Jalali Ø¨Ø±Ø§ÛŒ Â«Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Â» (Ù„ÛŒØ³Øª) â€” Ù¾Ø§ÛŒØ¯Ø§Ø± + Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
const $listDates = $("#list-tab-pane input.jalali_date");

// ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ù…ØªÙ†ÛŒ Ùˆ ØªÙ…ÛŒØ² Ú©Ù†
$listDates.each(function(){
  try { this.type = 'text'; } catch(e){}
  $(this).attr('autocomplete','off')
         .attr('inputmode','numeric')
         .attr('dir','ltr');
});

// ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§ÛŒÙ†ÛŒØ´ÛŒØ§Ù„ â€” Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± UI
$listDates.filter(function(){ return !$(this).data('pDatepicker'); })
  .persianDatepicker({
    format: 'YYYY/MM/DD',
    autoClose: true,
    initialValue: false,
    initialValueType: 'persian',
    calendar: { persian: { locale: 'fa' } },
    persianDigit: true
  });

// Ù‚Ø¨Ù„ Ø§Ø² submit Ù‡Ø± ÙØ±Ù… Â«Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Â»: Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¨Ù‡ YYYY/MM/DD Ø¨Ø§ Ø§Ø±Ù‚Ø§Ù… Ù„Ø§ØªÛŒÙ† ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
$("#list-tab-pane form[action*='deliver_order']").on('submit', function(){
  var $inp = $(this).find('input.jalali_date').first();
  if (!$inp.length) return;
  var v = ($inp.val() || '').trim();
  if (!v) return;

  // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ/Ø¹Ø±Ø¨ÛŒ Ø¨Ù‡ Ù„Ø§ØªÛŒÙ† + Â«-Â» Ø¨Ù‡ Â«/Â»
  var map = {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9',
             'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','-':'/'};
  v = v.replace(/[Û°-Û¹Ù -Ù©\-]/g, function(ch){ return map[ch] || ch; });
  $inp.val(v); // Ù†Ù…ÙˆÙ†Ù‡: 1403/07/19
});


    // --- ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ (Create tab) Ø¨Ø§ altField
    const $createDates = $("#order-tab-pane input[name$='order_date'], #order-tab-pane input[name$='due_date']");
    if (!DP) {
      // Ø­Ø§Ù„Øª Ù‚Ø¯ÛŒÙ…ÛŒ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø®Ø§Ù…ÙˆØ´ Ø¨ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯)
      $createDates.each(function(idx){
        const $vis = $(this);
        try { this.type = 'text'; } catch(e){}
        $vis.attr('autocomplete','off');
        const altId = ($vis.attr('id') ? $vis.attr('id') : ('create_date_' + idx)) + '_alt';
        if (!document.getElementById(altId)) {
          $('<input>', {type:'hidden', id:altId}).insertAfter($vis);
        }
        $vis.persianDatepicker({
          format: 'YYYY/MM/DD',
          autoClose: true,
          initialValue: false,
          calendar: { persian: { locale: 'fa' } },
          altField: '#'+altId,
          altFormat: 'YYYY-MM-DD',
          altCalendar: 'gregorian'
        });
      });
    } else {
      // Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ LMDateX
      $createDates.each(function(idx){
        const $vis = $(this);
        try { this.type = 'text'; } catch(e){}
        $vis.attr('autocomplete','off');
        const altId = ($vis.attr('id') ? $vis.attr('id') : ('create_date_' + idx)) + '_alt';
        if (!document.getElementById(altId)) {
          $('<input>', {type:'hidden', id:altId}).insertAfter($vis);
        }
        $vis.persianDatepicker({
          format: 'YYYY/MM/DD',
          autoClose: true,
          initialValue: false,
          initialValueType: 'persian', // ØªÙØ³ÛŒØ± Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¬Ù„Ø§Ù„ÛŒ
          persianDigit: true,          // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ
          calendar: { persian: { locale: 'fa' } },
          altField: '#'+altId,
          altFormat: 'YYYY-MM-DD',
          altCalendar: 'gregorian'
        });
      });
    }

    // --- Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Create: Ù…Ù‚Ø¯Ø§Ø± visible Ø±Ø§ Ø¨Ø§ Ù…ÛŒÙ„Ø§Ø¯ÛŒ alt Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
    var $orderForm = $('#order-tab-pane form');
    if($orderForm.length){
      // Ù†Ø§Ù…â€ŒÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ù†Ø¯Ø¨Ø§Ø± ÙˆØµÙ„â€ŒØ´Ø¯Ù†
      $orderForm.off('submit.__create_dates');
      $orderForm.on('submit.__create_dates', function(){
        $createDates.each(function(idx){
          const $vis = $(this);
          const altId = ($vis.attr('id') ? $vis.attr('id') : ('create_date_' + idx)) + '_alt';
          const $alt = $('#'+altId);
          if ($alt.length && $alt.val()) {
            $vis.val($alt.val()); // Ø§Ø±Ø³Ø§Ù„: YYYY-MM-DD
          }
        });
      });
    }

    // --- Tooth Picker (Create tab)
    const chips = document.querySelectorAll('#order-tab-pane .tooth-chip');
    const hidden = document.querySelector('#order-tab-pane #teeth_fdi');
    const summary = document.querySelector('#order-tab-pane #tooth-summary');

    if (!TP) {
      // Ø­Ø§Ù„Øª Ù‚Ø¯ÛŒÙ…ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
      function fdiCode(q, n){ return (q*10 + n).toString(); }
      function refreshSummary(){
        const codes = (hidden.value || '').split(',').filter(Boolean);
        if (!codes.length){
          summary.textContent = 'Ù‡Ù†ÙˆØ² Ø¯Ù†Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
          summary.classList.add('text-muted');
          return;
        }
        summary.classList.remove('text-muted');
        const groups = {1:[],2:[],3:[],4:[]};
        codes.forEach(c=>{
          const q = parseInt(c[0],10);
          const n = parseInt(c.slice(1),10);
          if(groups[q]) groups[q].push(n);
        });
        Object.keys(groups).forEach(k=> groups[k].sort((a,b)=>a-b));
        const parts = [];
        if(groups[1].length) parts.push('Ø¨Ø§Ù„Ø§ Ø±Ø§Ø³Øª: ' + groups[1].join(', '));
        if(groups[2].length) parts.push('Ø¨Ø§Ù„Ø§ Ú†Ù¾: '   + groups[2].join(', '));
        if (groups[3].length) parts.push('Ù¾Ø§ÛŒÛŒÙ† Ú†Ù¾: ' + groups[3].join(', '));
        if(groups[4].length) parts.push('Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª: ' + groups[4].join(', '));
        summary.textContent = parts.join('  |  ');
      }
      function toggleChip(el){
        el.classList.toggle('active');
        const q = parseInt(el.dataset.q,10);
        const n = parseInt(el.dataset.n,10);
        const code = fdiCode(q,n);
        let arr = (hidden.value || '').split(',').filter(Boolean);
        if (el.classList.contains('active')){ if (!arr.includes(code)) arr.push(code); }
        else { arr = arr.filter(c => c !== code); }
        arr.sort((a,b)=>parseInt(a,10)-parseInt(b,10));
        hidden.value = arr.join(',');
        refreshSummary();
      }
      chips.forEach(el=> el.addEventListener('click', ()=> toggleChip(el)));
      document.querySelectorAll('#order-tab-pane [data-bulk]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = btn.getAttribute('data-bulk');
          if (t === 'clear'){
            chips.forEach(c=> c.classList.remove('active'));
            hidden.value = '';
            refreshSummary();
            return;
          }
          const selectQuadrants = (qs)=>{
            chips.forEach(c=>{
              const q = parseInt(c.dataset.q,10);
              if (qs.includes(q)){ if (!c.classList.contains('active')) c.classList.add('active'); }
            });
            const arr = [];
            chips.forEach(c=>{
              if (c.classList.contains('active')){
                const q = parseInt(c.dataset.q,10);
                const n = parseInt(c.dataset.n,10);
                arr.push(fdiCode(q,n));
              }
            });
            arr.sort((a,b)=>parseInt(a,10)-parseInt(b,10));
            hidden.value = arr.join(',');
            refreshSummary();
          };
          if (t === 'upper-all') selectQuadrants([1,2]);
          if (t === 'lower-all') selectQuadrants([3,4]);
        });
      });

      // Ú†Ø³Ø¨Ø§Ù†Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ø¨Ù‡ notes Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ (Ù‚Ø¯ÛŒÙ…ÛŒ)
      const _form = document.querySelector('#order-tab-pane form');
      if (_form){
        _form.addEventListener('submit', ()=>{
          const codes = (hidden && hidden.value || '').trim();
          if (!codes) return;
          const notes = _form.querySelector('textarea[name$="notes"]');
          if (notes){
            const tag = '\nØ¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§: ' + codes.replaceAll(',', ', ');
            if (notes.value.indexOf('Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§:') === -1){
              notes.value = (notes.value || '') + tag;
            }
          }
          // Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ ModelForm ØªØ§ Ø¯Ø± DB Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯
       const mfHidden = document.getElementById('teeth_fdi_mf');
       if (mfHidden) mfHidden.value = codes;
        });
      }
    } else {
      // Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ LMToothX (ÙÙ‚Ø· ØªØ¨ Create)
      if (window.LMToothX && typeof LMToothX.init === 'function') {
        LMToothX.init({
          root: '#order-tab-pane',         // ÙÙ‚Ø· ØªØ¨ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
          hidden: '#teeth_fdi',
          chips: '.tooth-chip',
          summary: '#tooth-summary',
          notes: '#id_notes'               // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ crispy Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ id_notes Ø§Ø³Øª
        });

      } else {
        console.warn('LMToothX not found');
      }
    }

    // --- Ø±Ù†Ø¯Ø± Ù†Ù…Ø§ÛŒ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ù„ÛŒØ³Øª (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    (function(){
      function parseQuadrants(qstr){
        const res = {UR:[], UL:[], LL:[], LR:[]};
        if(!qstr) return res;
        qstr.split('|').forEach(seg=>{
          const [k,v=''] = seg.split('=');
          const key = (k||'').trim().toUpperCase();
          if(res[key] && v.trim()){
            res[key] = v.split(',').map(s=>s.trim()).filter(Boolean);
          }
        });
        return res;
      }
      function parseFDI(fdi){
        const groups = {1:[],2:[],3:[],4:[]};
        if(!fdi) return groups;
        fdi.split(',').map(s=>s.trim()).filter(Boolean).forEach(code=>{
          const q = parseInt(code[0],10);
          const n = parseInt(code.slice(1),10);
          if(groups[q] && n>=1 && n<=8) groups[q].push(String(n));
        });
        Object.keys(groups).forEach(k=> groups[k].sort((a,b)=>parseInt(a,10)-parseInt(b,10)));
        return groups;
      }
      function fromNotes(notes){
        if(!notes) return null;
        const fa='Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹', ar='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
        function dnorm(s){
          return String(s)
            .replace(/[Û°-Û¹]/g, d => ''+fa.indexOf(d))
            .replace(/[Ù -Ù©]/g, d => ''+ar.indexOf(d));
        }
        const m = dnorm(notes).match(/Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§\s*:\s*([0-9,\sØŒ]+)/);
        if(!m) return null;
        const csv = m[1].replace(/ØŒ/g, ',');
        const codes = csv.split(',').map(s=>s.trim()).filter(Boolean);
        if(!codes.length) return null;
        const g = {1:[],2:[],3:[],4:[]};
        codes.forEach(code=>{
          const q = parseInt(code[0],10);
          const n = parseInt(code.slice(1),10);
          if(g[q] && n>=1 && n<=8) g[q].push(String(n));
        });
        Object.keys(g).forEach(k=> g[k].sort((a,b)=>parseInt(a,10)-parseInt(b,10)));
        return { UL:g[2], UR:g[1], LL:g[3], LR:g[4] };
      }
      function fill(el){
        const qstr  = el.getAttribute('data-q') || '';
        const fdi   = el.getAttribute('data-fdi') || '';
        const notes = el.getAttribute('data-notes') || '';
        let UL=[], UR=[], LL=[], LR=[];
        if(qstr){
          const q = parseQuadrants(qstr);
          UL=q.UL; UR=q.UR; LL=q.LL; LR=q.LR;
        }else if(fdi){
          const g = parseFDI(fdi);
          UL = g[2]; UR = g[1]; LL = g[3]; LR = g[4];
        }else{
          const n = fromNotes(notes);
          if(n){ UL=n.UL; UR=n.UR; LL=n.LL; LR=n.LR; }
        }
        const map = { 'tp-ul':UL, 'tp-ur':UR, 'tp-ll':LL, 'tp-lr':LR };
        Object.keys(map).forEach(cls=>{
          const box = el.querySelector('.'+cls);
          if(!box) return;
          box.innerHTML = '';
          map[cls].forEach(num=>{
            const s = document.createElement('span');
            s.textContent = num;
            s.className = 'active';
            box.appendChild(s);
          });
        });
      }
      document.querySelectorAll('.toothplus').forEach(fill);
    })();

    // Ù¾Ø§ÛŒØ§Ù† ready
  });
</script>
<script>
  // ØªØ¶Ù…ÛŒÙ† Ù†Ù‡Ø§ÛŒÛŒ (Ù†Ø³Ø®Ù‡Ù” Ø¨Ù‡Ø¨ÙˆØ¯â€ŒÛŒØ§ÙØªÙ‡):
  // Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… CreateØŒ Ú©ÙØ¯Ù‡Ø§ÛŒ Ø¯Ù†Ø¯Ø§Ù† Ø§Ø² hidden ÛŒØ§ Ø§Ø² Ú†ÛŒÙ¾â€ŒÙ‡Ø§ÛŒ .active Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  // Ø³Ù¾Ø³ Ø¯Ø± notes Ùˆ Ù‡Ù…Ú†Ù†ÛŒÙ† Ø¯Ø± Ù‡ÛŒØ¯Ù† Ù…Ø¯Ù„ (teeth_fdi_mf) Ø³Øª Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
  (function(){
    var rootSel   = '#order-tab-pane';
    var formSel   = rootSel + ' form';
    var hiddenSel = rootSel + ' #teeth_fdi';      // Ù‡ÛŒØ¯Ù† UI
    var mfSel     = rootSel + ' #teeth_fdi_mf';   // Ù‡ÛŒØ¯Ù† ModelForm (name="teeth_fdi")

    function collectFromChips(){
      var arr = [];
      document.querySelectorAll(rootSel + ' .tooth-chip.active').forEach(function(c){
        var q = parseInt(c.getAttribute('data-q'), 10);
        var n = parseInt(c.getAttribute('data-n'), 10);
        if (q && n) arr.push(String(q*10 + n));
      });
      // Ø§Ú¯Ø± hidden Ù‚Ø¨Ù„ÛŒ Ú†ÛŒØ²ÛŒ Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ Ú†ÛŒÙ¾â€ŒÙ‡Ø§ Ø§Ø¯ØºØ§Ù… Ø´ÙˆØ¯
      var hv = (document.querySelector(hiddenSel)?.value || '').split(',').map(function(s){return s.trim();}).filter(Boolean);
      hv.forEach(function(code){ if (!arr.includes(code)) arr.push(code); });
      arr.sort(function(a,b){ return parseInt(a,10) - parseInt(b,10); });
      return arr.join(',');
    }

    $(document).off('submit.__tp_sync', formSel).on('submit.__tp_sync', formSel, function(){
      // 1) Ú©Ø¯Ù‡Ø§: Ø§ÙˆÙ„ Ø§Ø² Ù‡ÛŒØ¯Ù†ØŒ Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ Ø§Ø² Ú†ÛŒÙ¾â€ŒÙ‡Ø§
      var codes = (document.querySelector(hiddenSel)?.value || '').trim();
      if (!codes) codes = collectFromChips();

      // 2) Ø¯Ø± Ù‡Ø± Ø¯Ùˆ Ù‡ÛŒØ¯Ù† Ø¨Ù†ÙˆÛŒØ³ÛŒÙ… ØªØ§ Ø­ØªÙ…Ø§Ù‹ POST Ø´ÙˆØ¯
      var $ui = $(hiddenSel); if ($ui.length) $ui.val(codes);
      var $mf = $(mfSel);     if ($mf.length) $mf.val(codes);

      // 3) Ø®Ø· Â«Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§: â€¦Â» Ø±Ø§ Ø¯Ø± notes Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†/Ø§ÙØ²ÙˆØ¯Ù‡ Ú©Ù† (Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ name Ù‡Ø±Ú†Ù‡ Ø¨Ø§Ø´Ø¯)
      var $notes = $(rootSel + ' #id_notes, ' + rootSel + ' textarea[name$="notes"]');
      if ($notes.length){
        var txt = String($notes.val() || '');
        txt = txt.replace(/(^|\n)\s*Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§\s*:\s*[^\n]*\n?/g, '$1'); // Ù¾Ø§Ú© Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        if (codes){
          txt = (txt ? txt.replace(/\s*$/,'') + '\n' : '') + 'Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§: ' + codes.replace(/,/g, ', ');
        }
        $notes.val(txt);
      }
    });
  })();
</script>
{% endblock %}















































































