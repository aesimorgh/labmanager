{% extends "base_user_panel.html" %}
{% load crispy_forms_tags %}
{% load num_extras %}
{% load jalali_tags %}
{% load static %}
{% block title %}Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§{% endblock %}

{% block head_extra %}
  <!-- Bootstrap 5 + Persian Datepicker (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØµÙØ­Ù‡) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <style>
    h1 { margin: 30px 0; text-align: center; }
    .tab-content { margin-top: 1rem; }

    .table thead th{
      background-color:#0d6efd !important;
      color:#fff !important;
      vertical-align: middle; white-space: nowrap;
      padding-top:.6rem; padding-bottom:.6rem;
      position: sticky; top: 0; z-index: 5;
    }
    .table tbody tr:nth-child(even) { background-color: #f1f3f5; }
    .table td, .table th { vertical-align: middle; }

    .sort-link{ color:inherit !important; text-decoration:none; }
    .sort-link:hover{ opacity:.9; text-decoration:none; }
    .sort-arrow{ font-size:.9em; line-height:1; }

    .badge { font-size: 0.9em; }
    .card-header { font-weight: bold; }
    .alert-success { margin-top: 1rem; }
    #order-row { flex-direction: row !important; }
    .pwt-datepicker-container { z-index: 2050 !important; }
    input[type="number"] { direction: ltr; text-align: left; }
    .en-num { direction: ltr; text-align: left; }

    .btn-chip { border-radius: 9999px; padding-inline: 0.9rem; }
    .input-group-sm .form-control { min-width: 95px; }
    .filter-row .form-select, .filter-row .form-control { height: 36px; padding-top: 2px; padding-bottom: 2px; }

    /* Tooth Picker */
    .tooth-card{background:#fff;border:1px solid #dee2e6;border-radius:.65rem;padding:1rem;margin-top:.25rem}
    .tooth-chip{
      border:1px solid #dee2e6;background:#fff;border-radius:9999px;
      padding:.24rem .5rem; font-size:.9rem; line-height:1.1; cursor:pointer; user-select:none; flex:0 0 auto;
    }
    .tooth-chip.active{background:#0d6efd;color:#fff;border-color:#0d6efd}
    .tooth-summary{margin-top:.4rem;color:#374151;font-size:.92rem}
    .midline{width:0;height:28px;position:relative;flex:0 0 0;border-left:2px dashed #9ca3af}
    .sep-h{height:0;border-top:2px dashed #9ca3af;margin:.5rem 0;pointer-events:none}

    .table-wrap { max-height: 65vh; overflow: auto; border: 1px solid #e5e7eb; border-radius: .5rem; }
    .sticky-patient { position: sticky; right: 0; z-index: 6; background: #fff; box-shadow: -4px 0 0 rgba(13,110,253,.08); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 220px; }

    .toothplus-cell{ min-width: 92px; }
    .toothplus{ position: relative; width: 80px; height: 80px; margin: 0 auto; font-size: 12px; line-height: 1.1; color:#111; user-select:none; }
    .toothplus::before, .toothplus::after{ content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#9ca3af; }
    .toothplus::before{ width:2px; height:86%; }
    .toothplus::after { height:2px; width:86%; }
    .tp{ position:absolute; display:flex; gap:1px; max-width:34px; }
    .tp span{ padding:0 2px; border-radius:4px; }
    .tp-ur{ top:12px; right:18px; justify-content:flex-end; text-align:right; }
    .tp-ul{ top:12px; left:18px;  text-align:left; }
    .tp-ll{ bottom:12px; left:18px; text-align:left; }
    .tp-lr{ bottom:12px; right:18px; justify-content:flex-end; text-align:right; }
    .tp span.active{ background:#0d6efd; color:#fff; }
  </style>
{% endblock %}

{% block subtabs %}
  <ul class="nav nav-tabs" id="tabMenu" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-tab-pane" type="button" role="tab" aria-controls="order-tab-pane" aria-selected="true">
        ğŸ“ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab" aria-controls="list-tab-pane" aria-selected="false">
        ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="transfer-tab" data-bs-toggle="tab" data-bs-target="#transfer-tab-pane" type="button" role="tab" aria-controls="transfer-tab-pane" aria-selected="false">
        â†”ï¸ ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬
      </button>
    </li>
    <li class="nav-item" role="presentation">
  <button class="nav-link" id="wb-tab" data-bs-toggle="tab" data-bs-target="#wb-tab-pane"
          type="button" role="tab" aria-controls="wb-tab-pane" aria-selected="false">
    ğŸ› ï¸ ÙˆØ±Ú©â€ŒØ¨Ù†Ú† Ù…Ø±Ø§Ø­Ù„
  </button>
</li>
  </ul>
{% endblock %}

{% block content %}
  <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h1>

  <div class="tab-content" id="tabContent">
    <!-- ========== ØªØ¨ 1: Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ========== -->
    <div class="tab-pane fade show active" id="order-tab-pane" role="tabpanel" aria-labelledby="order-tab">
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-primary text-white">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
          {% endif %}

          <form method="post">
            {% csrf_token %}

            <div id="order-row" class="row g-3">
              <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª -->
              <div class="col-12 col-md-6 order-md-1">
                {{ order_form.patient_name|as_crispy_field }}
                {{ order_form.doctor|as_crispy_field }}
                {{ order_form.order_type|as_crispy_field }}
                {{ order_form.unit_count|as_crispy_field }}

                <!-- Tooth Picker -->
                <div class="tooth-card">
                  <div class="section-title">Ø´Ù…Ø§Ø±Ù‡ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§</div>
                  <div id="tooth-summary" class="tooth-summary text-muted">Ù‡Ù†ÙˆØ² Ø¯Ù†Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>

                  <div class="tooth-row">
                    <div class="d-flex justify-content-between gap-2">
                      <div class="d-flex gap-1 flex-wrap">
                        {% for n in "87654321" %}
                          <span class="tooth-chip" data-q="1" data-n="{{ n }}">{{ n }}</span>
                        {% endfor %}
                      </div>
                      <span class="midline" aria-hidden="true"></span>
                      <div class="d-flex gap-1 flex-wrap">
                        {% for n in "12345678" %}
                          <span class="tooth-chip" data-q="2" data-n="{{ n }}">{{ n }}</span>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <div class="sep-h" aria-hidden="true"></div>

                  <div class="tooth-row">
                    <div class="d-flex justify-content-between gap-2">
                      <div class="d-flex gap-1 flex-wrap">
                        {% for n in "87654321" %}
                          <span class="tooth-chip" data-q="3" data-n="{{ n }}">{{ n }}</span>
                        {% endfor %}
                      </div>
                      <span class="midline" aria-hidden="true"></span>
                      <div class="d-flex gap-1 flex-wrap">
                        {% for n in "12345678" %}
                          <span class="tooth-chip" data-q="4" data-n="{{ n }}">{{ n }}</span>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bulk="upper-all">Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡Ù” ÙÚ© Ø¨Ø§Ù„Ø§</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bulk="lower-all">Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡Ù” ÙÚ© Ù¾Ø§ÛŒÛŒÙ†</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bulk="clear">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
                  </div>

                  <input type="hidden" name="order-teeth_fdi" id="teeth_fdi" value="">
                  <input type="hidden" name="teeth_fdi" id="teeth_fdi_mf" value="">
                  <div class="text-muted mt-1">Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Â«ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÂ» Ù‡Ù… Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                </div>
              </div>

              <!-- Ø³ØªÙˆÙ† Ú†Ù¾ -->
              <div class="col-12 col-md-6 order-md-2">
                {{ order_form.shade|as_crispy_field }}
                {{ order_form.price|as_crispy_field }}
                {{ order_form.serial_number|as_crispy_field }}
                <input type="hidden" name="order-status" value="in_progress">
                {{ order_form.order_date|as_crispy_field }}
                {{ order_form.due_date|as_crispy_field }}
                {{ order_form.notes|as_crispy_field }}
              </div>
            </div>

            <div class="mt-3">
              <button type="submit" class="btn btn-success">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- ========== ØªØ¨ 2: Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ ========== -->
    <div class="tab-pane fade" id="list-tab-pane" role="tabpanel" aria-labelledby="list-tab">
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-secondary text-white">Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
        <div class="card-body">

          <!-- ÙÛŒÙ„ØªØ± Ø³Ø±ÙˆØ±ÛŒ -->
          <form method="get" class="row g-2 mb-3 filter-row" action="#list-tab-pane">
            <input type="hidden" name="sort" value="{{ sort }}">
            <input type="hidden" name="dir" value="{{ dir }}">
            <div class="col-md-4">
              <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¨ÛŒÙ…Ø§Ø± / Ù¾Ø²Ø´Ú© / Ø³Ø±ÛŒØ§Ù„ / Ø±Ù†Ú¯">
            </div>
            <div class="col-md-3">
              <select name="doctor" class="form-select">
                <option value="">Ù‡Ù…Ù‡ Ù¾Ø²Ø´Ú©â€ŒÙ‡Ø§</option>
                {% for d in doctors %}
                  <option value="{{ d }}" {% if d == doctor %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <select name="status" class="form-select">
                <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                {% for val,label in status_choices %}
                  <option value="{{ val }}" {% if val == status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex gap-2">
              <button class="btn btn-primary flex-grow-1">Ø§Ø¹Ù…Ø§Ù„</button>
              <a class="btn btn-outline-secondary" href="?#list-tab-pane">Ø­Ø°Ù ÙÛŒÙ„ØªØ±</a>
            </div>
          </form>

          <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ù„Ø§ÛŒÙ†ØªÛŒ -->
          <input class="form-control mb-3" id="searchInput" type="text" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡...">

          <div class="table-wrap">
            <table class="table table-striped table-hover align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th class="sticky-patient">Ø¨ÛŒÙ…Ø§Ø±</th>
                  <th>Ù¾Ø²Ø´Ú©</th>
                  <th>Ù†ÙˆØ¹ Ø³ÙØ§Ø±Ø´</th>
                  <th>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯</th>
                  <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„</th>
                  <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>

                  <th>
                    <a class="sort-link"
                       href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=total_price&dir={% if sort == 'total_price' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                      Ù‚ÛŒÙ…Øª Ú©Ù„
                      <span class="sort-arrow">{% if sort == 'total_price' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                    </a>
                  </th>

                  <th>Ø±Ù†Ú¯</th>
                  <th>Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§</th>

                  <th>ÙˆØ¶Ø¹ÛŒØª</th>

                  <th>
                    <a class="sort-link"
                       href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=due_date&dir={% if sort == 'due_date' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                      ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„
                      <span class="sort-arrow">{% if sort == 'due_date' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                    </a>
                  </th>

                  <th>
                    <a class="sort-link"
                       href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort=created_at&dir={% if sort == 'created_at' and dir == 'asc' %}desc{% else %}asc{% endif %}#list-tab-pane">
                      ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª
                      <span class="sort-arrow">{% if sort == 'created_at' %}{% if dir == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•{% endif %}</span>
                    </a>
                  </th>

                  <th>Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                  <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
                  <th>Ø§Ø±Ø³Ø§Ù„</th>
                </tr>
              </thead>

              <tbody id="ordersTable">
              {% for order in orders %}
                <tr>
                  <td>{{ order.id|int_fa }}</td>
                  <td class="sticky-patient">
                    <a href="{% url 'core:order_detail' order.id %}"
                       class="js-order-detail text-decoration-none text-body"
                       data-order-id="{{ order.id }}">{{ order.patient_name }}</a>
                  </td>
                  <td>{{ order.doctor }}</td>
                  <td>{{ order.get_order_type_display }}</td>
                  <td>{{ order.unit_count|int_fa }}</td>
                  <td>{{ order.serial_number }}</td>
                  <td>{{ order.price|money_fa }}</td>
                  <td>{{ order.total_price|money_fa }}</td>
                  <td>{{ order.shade }}</td>
                  <td class="toothplus-cell">
                    <div class="toothplus"
                         data-q="{% if order.teeth_fdi %}{% else %}{{ order.teeth_quadrants|default:'' }}{% endif %}"
                         data-fdi="{{ order.teeth_fdi|default:'' }}"
                         data-notes="{{ order.notes|default_if_none:''|striptags }}">
                      <div class="tp tp-ul"></div>
                      <div class="tp tp-ur"></div>
                      <div class="tp tp-ll"></div>
                      <div class="tp tp-lr"></div>
                    </div>
                  </td>
                  <td>
                    {% if order.status == 'done' %}
                      <span class="badge bg-success">{{ order.get_status_display }}</span>
                    {% elif order.status == 'in_progress' %}
                      <span class="badge bg-warning text-dark">{{ order.get_status_display }}</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ order.get_status_display }}</span>
                    {% endif %}
                  </td>
                  <td>{{ order.due_date|jalali_date|digits_fa }}</td>
                  <td>{{ order.order_date|jalali_date|digits_fa }}</td>
                  <td>
                    <a href="{% url 'core:order_detail' order.id %}"
                       class="btn btn-sm btn-outline-primary btn-chip js-order-detail"
                       data-order-id="{{ order.id }}">Ø¬Ø²Ø¦ÛŒØ§Øª</a>
                  </td>
                  <td>
                    <a href="{% url 'core:order_edit' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
                       class="btn btn-sm btn-outline-warning btn-chip">ÙˆÛŒØ±Ø§ÛŒØ´</a>
                  </td>
                  <td>
                    {% if not order.shipped_date %}
                      <form method="post"
                            action="{% url 'core:deliver_order' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
                            class="d-inline-block">
                        {% csrf_token %}
                        <div class="input-group input-group-sm" style="width: 200px;">
                          <input type="text" name="shipped_date" class="form-control jalali_date" placeholder="ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„">
                          <button type="submit" class="btn btn-success">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</button>
                        </div>
                      </form>
                    {% else %}
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-muted">{{ order.shipped_date|dash_to_slash|digits_fa }}</span>
                        <form method="post"
                              action="{% url 'core:deliver_order' order.id %}?next={{ request.get_full_path|urlencode }}#list-tab-pane"
                              class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="undo" value="1">
                          <button type="submit" class="btn btn-outline-danger btn-sm">Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†</button>
                        </form>
                      </div>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="16" class="text-center text-muted">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
              {% endfor %}
              </tbody>
            </table>

            <!-- Modal: Order Detail -->
            <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                  </div>
                  <div class="modal-body"><div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div></div>
                </div>
              </div>
            </div>
          </div> <!-- /.table-wrap -->

          {% if page_obj.paginator.num_pages > 1 %}
          <nav aria-label="pagination" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link"
                     href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.previous_page_number }}#list-tab-pane">Ù‚Ø¨Ù„ÛŒ</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Ù‚Ø¨Ù„ÛŒ</span></li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link">{{ page_obj.number|int_fa }} / {{ page_obj.paginator.num_pages|int_fa }}</span>
              </li>
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link"
                     href="?q={{ q|urlencode }}&doctor={{ doctor|urlencode }}&status={{ status|urlencode }}&sort={{ sort|urlencode }}&dir={{ dir|urlencode }}&page={{ page_obj.next_page_number }}#list-tab-pane">Ø¨Ø¹Ø¯ÛŒ</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Ø¨Ø¹Ø¯ÛŒ</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- ========== ØªØ¨ 3: ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ (Ø³ÙÛŒØ¨Ù€Ù„ÛŒÙ†Ú¯Ù Ù„ÛŒØ³ØªØ› Ù†Ù‡ Ø¯Ø§Ø®Ù„ Ø¢Ù†) ========== -->
    <div class="tab-pane fade" id="transfer-tab-pane" role="tabpanel" aria-labelledby="transfer-tab">
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ Ø³Ø±ÛŒØ¹ Ø³ÙØ§Ø±Ø´</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ú©ØªØ±</label>
              <input id="doctorSearch" type="text" class="form-control" placeholder="Ù†Ø§Ù… Ø¯Ú©ØªØ±... (Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯)">
              <div id="doctorList" class="list-group mt-2" style="max-height: 260px; overflow:auto;"></div>
            </div>

            <div class="col-md-5">
              <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ§Ø±Ø´Ù Ø¢Ù† Ø¯Ú©ØªØ±</label>
              <input id="orderSearch" type="text" class="form-control" placeholder="Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±/Ø³Ø±ÛŒØ§Ù„/ØªØ§Ø±ÛŒØ®... Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø³Ø±ÛŒØ¹">
              <div id="orderList" class="list-group mt-2" style="max-height: 260px; overflow:auto;"></div>
            </div>

            <div class="col-md-3">
              <form id="evtForm" method="post" class="vstack gap-2">
                {% csrf_token %}
                <input type="hidden" id="selectedOrderId" name="__selected_order_id">

                <!-- Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯ (ÙÙ‚Ø· Ûµ Ú¯Ø²ÛŒÙ†Ù‡) -->
                <label class="form-label">Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
                <select id="eventType" name="event_type" class="form-select">
                  <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>
                  <option value="sent_to_clinic">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù…Ø·Ø¨</option>
                  <option value="received_in_lab">Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ù…Ø·Ø¨</option>
                  <option value="sent_to_digital_lab">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø± Ø¯ÛŒØ¬ÛŒØªØ§Ù„</option>
                  <option value="received_from_digital_lab">Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø± Ø¯ÛŒØ¬ÛŒØªØ§Ù„</option>
                  <option value="final_shipment">Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ</option>
                </select>

                <!-- Ø¹Ù„Øª (Select) -->
                <label class="form-label">Ø¹Ù„Øª</label>
                <select name="cause_choice" id="cause_choice" class="form-select">
                  <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>
                  <option value="components_announce">Ø§Ø¹Ù„Ø§Ù… Ù‚Ø·Ø¹Ø§Øª</option>
                  <option value="components_received">Ø¯Ø±ÛŒØ§ÙØª Ù‚Ø·Ø¹Ø§Øª</option>
                  <option value="waxrim_record_bite">waxrim & record bite</option>
                  <option value="dural_try_in">Ø§Ù…ØªØ­Ø§Ù† Ø¯ÙˆØ±Ø§Ù„ÛŒ</option>
                  <option value="frame_try_in">Ø§Ù…ØªØ­Ø§Ù† ÙØ±ÛŒÙ…</option>
                  <option value="porcelain_try_in">Ø§Ù…ØªØ­Ø§Ù† Ù¾Ø±Ø³Ù„Ù†</option>
                  <option value="framework_design">Ø·Ø±Ø§Ø­ÛŒ ÙØ±ÛŒÙ…</option>
                  <option value="custom_abutment">Ú©Ø§Ø³ØªÙˆÙ…Ø§ÛŒØ² Ø§Ø¨Ø§ØªÙ…Ù†Øª</option>
                  <option value="qc_check">Ø¨Ø±Ø±Ø³ÛŒ Ú©ÛŒÙÛŒ</option>
                  <option value="other">Ø³Ø§ÛŒØ± (Ù‚Ø§Ø¨Ù„ ØªØ§ÛŒÙ¾)</option>
                </select>

                <!-- Ù…ØªÙ†Ù Ø¹Ù„Øª ÙˆÙ‚ØªÛŒ Â«Ø³Ø§ÛŒØ±Â» Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯ -->
                <div id="cause_text_wrap" style="display:none;">
                  <label class="form-label">Ø¹Ù„Øª (Ù…ØªÙ† Ø¢Ø²Ø§Ø¯)</label>
                  <input type="text" name="cause_text" id="cause_text" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªÙˆØ¶ÛŒØ­ Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§">
                  <div class="form-text">Ø§Ú¯Ø± Â«Ø³Ø§ÛŒØ±Â» Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù¾Ø± Ú©Ù†.</div>
                </div>
                <!-- Ù…Ø±Ø­Ù„Ù‡ Ù…Ø±ØªØ¨Ø· (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) -->
                <label class="form-label">Ù…Ø±Ø­Ù„Ù‡ Ù…Ø±ØªØ¨Ø· (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                <select id="stageInstance" name="stage_instance" class="form-select">
                  <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>
                </select>

                </select>
                <label class="form-label">ØªØ§Ø±ÛŒØ® ÙˆÙ‚ÙˆØ¹</label>
                <input id="happenedAt" name="happened_at" type="text" class="form-control jalali_date" placeholder="YYYY/MM/DD">

                <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                <textarea name="notes" class="form-control" rows="2" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ­ÙˆÛŒÙ„ Ø´Ø¯ Ø¨Ù‡ Ù¾ÛŒÚ© / Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§Ú©Ù„ÙˆØ²Ø§Ù„"></textarea>

                <button class="btn btn-success w-100 mt-2">Ø«Ø¨Øª ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬</button>
              </form>
              <script>
                (function(){
                  function toggleCause() {
                    var val = document.getElementById('cause_choice')?.value || '';
                    document.getElementById('cause_text_wrap').style.display = (val === 'other') ? 'block' : 'none';
                  }
                  document.addEventListener('change', function(e){
                    if (e.target && e.target.id === 'cause_choice') toggleCause();
                  });
                  toggleCause(); // init
                })();
              </script>
              <div class="form-text mt-1">Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ú©ØªØ±ØŒ Ø§Ø² Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ ÛŒÚ©ÛŒ Ø±Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø´ÙˆØ¯.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
      <!-- ========== ØªØ¨ 4: ğŸ› ï¸ ÙˆØ±Ú©â€ŒØ¨Ù†Ú† Ù…Ø±Ø§Ø­Ù„ ========== -->
  <div class="tab-pane fade" id="wb-tab-pane" role="tabpanel" aria-labelledby="wb-tab">
    <div class="mt-3">
      <iframe id="wb-iframe"
              src="/workbench/?status=active"
              style="width:100%; height:80vh; border:0; background:#fff;"></iframe>
    </div>
  </div>

  </div> <!-- /.tab-content -->
{% endblock %}

{% block body_extra %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window.__TP_FLAG__ = !/(?:^|[?&])tp=0(?:&|$)/.test(location.search);
    window.__DP_FLAG__ = !/(?:^|[?&])dp=0(?:&|$)/.test(location.search);
  </script>
  <script src="{% static 'js/toothpicker.experimental.v1.js' %}?v=20251009"></script>
  <script src="{% static 'js/date-utils.experimental.v1.js' %}?v=20251009"></script>

  <script>
  $(function() {
    const TP = !!window.__TP_FLAG__;
    const DP = !!window.__DP_FLAG__;

    /* Ø§Ù†ØªØ®Ø§Ø¨ ØªØ¨ Ø¨Ø§ hash ÛŒØ§ query */
    try{
      const h = window.location.hash;
      if (h === '#transfer-tab-pane') {
        const el = document.querySelector('#transfer-tab');
        if (el) new bootstrap.Tab(el).show();
      } else if (h === '#list-tab-pane' || window.location.search) {
        const el = document.querySelector('#list-tab');
        if (el) new bootstrap.Tab(el).show();
      }
    }catch(e){}

    /* Datepicker ØªØ¨ Ù„ÛŒØ³Øª (Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯) */
    const $listDates = $("#list-tab-pane input.jalali_date");
    $listDates.each(function(){ try { this.type='text'; }catch(e){} $(this).attr({autocomplete:'off', inputmode:'numeric', dir:'ltr'}); });
    $listDates.filter(function(){ return !$(this).data('pDatepicker'); })
      .persianDatepicker({ format:'YYYY/MM/DD', autoClose:true, initialValue:false, initialValueType:'persian', calendar:{persian:{locale:'fa'}}, persianDigit:true });
    $("#list-tab-pane form[action*='deliver_order']").on('submit', function(){
      var $inp = $(this).find('input.jalali_date').first();
      if(!$inp.length) return;
      var v = ($inp.val()||'').trim();
      if(!v) return;
      var map = {'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9','Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','-':'/'};
      v = v.replace(/[Û°-Û¹Ù -Ù©\-]/g, ch => map[ch]||ch);
      $inp.val(v);
    });

    /* Datepicker ØªØ¨ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ */
    const $createDates = $("#order-tab-pane input[name$='order_date'], #order-tab-pane input[name$='due_date']");
    $createDates.each(function(idx){
      const $vis = $(this); try{ this.type='text'; }catch(e){}
      $vis.attr('autocomplete','off');
      const altId = ($vis.attr('id')||('create_date_'+idx)) + '_alt';
      if(!document.getElementById(altId)){
        $('<input>', {type:'hidden', id:altId}).insertAfter($vis);
      }
      $vis.persianDatepicker({
        format:'YYYY/MM/DD', autoClose:true, initialValue:false,
        calendar:{persian:{locale:'fa'}},
        altField:'#'+altId, altFormat:'YYYY-MM-DD', altCalendar:'gregorian'
      });
    });
    $('#order-tab-pane form').off('submit.__create_dates').on('submit.__create_dates', function(){
      $createDates.each(function(idx){
        const $vis=$(this), altId = ($vis.attr('id')||('create_date_'+idx)) + '_alt', $alt = $('#'+altId);
        if($alt.length && $alt.val()) $vis.val($alt.val());
      });
    });

    /* Tooth Picker (Create) */
    (function(){
      const chips = document.querySelectorAll('#order-tab-pane .tooth-chip');
      const hidden = document.querySelector('#order-tab-pane #teeth_fdi');
      const summary = document.querySelector('#order-tab-pane #tooth-summary');
      function fdiCode(q,n){ return (q*10+n).toString(); }
      function refreshSummary(){
        const codes = (hidden.value||'').split(',').filter(Boolean);
        if(!codes.length){ summary.textContent='Ù‡Ù†ÙˆØ² Ø¯Ù†Ø¯Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'; summary.classList.add('text-muted'); return; }
        summary.classList.remove('text-muted');
        const g={1:[],2:[],3:[],4:[]};
        codes.forEach(c=>{ const q=parseInt(c[0],10), n=parseInt(c.slice(1),10); if(g[q]) g[q].push(n); });
        Object.keys(g).forEach(k=>g[k].sort((a,b)=>a-b));
        const parts=[];
        if(g[1].length) parts.push('Ø¨Ø§Ù„Ø§ Ø±Ø§Ø³Øª: '+g[1].join(', '));
        if(g[2].length) parts.push('Ø¨Ø§Ù„Ø§ Ú†Ù¾: '+g[2].join(', '));
        if(g[3].length) parts.push('Ù¾Ø§ÛŒÛŒÙ† Ú†Ù¾: '+g[3].join(', '));
        if(g[4].length) parts.push('Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ø³Øª: '+g[4].join(', '));
        summary.textContent=parts.join('  |  ');
      }
      function toggleChip(el){
        el.classList.toggle('active');
        const q=parseInt(el.dataset.q,10), n=parseInt(el.dataset.n,10), code=fdiCode(q,n);
        let arr=(hidden.value||'').split(',').filter(Boolean);
        if(el.classList.contains('active')){ if(!arr.includes(code)) arr.push(code); }
        else { arr = arr.filter(c=>c!==code); }
        arr.sort((a,b)=>parseInt(a,10)-parseInt(b,10));
        hidden.value=arr.join(',');
        refreshSummary();
      }
      chips.forEach(el=> el.addEventListener('click', ()=> toggleChip(el)));
      document.querySelectorAll('#order-tab-pane [data-bulk]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t=btn.getAttribute('data-bulk');
          if(t==='clear'){ chips.forEach(c=>c.classList.remove('active')); hidden.value=''; refreshSummary(); return; }
          const qs = (t==='upper-all')?[1,2]:(t==='lower-all')?[3,4]:[];
          chips.forEach(c=>{ const q=parseInt(c.dataset.q,10); if(qs.includes(q)) c.classList.add('active'); });
          let arr=[]; chips.forEach(c=>{ if(c.classList.contains('active')){ const q=parseInt(c.dataset.q,10), n=parseInt(c.dataset.n,10); arr.push(fdiCode(q,n)); } });
          arr.sort((a,b)=>parseInt(a,10)-parseInt(b,10)); hidden.value=arr.join(','); refreshSummary();
        });
      });
      const _form = document.querySelector('#order-tab-pane form');
      if(_form){
        _form.addEventListener('submit', ()=>{
          const codes=(hidden && hidden.value || '').trim(); if(!codes) return;
          const notes=_form.querySelector('textarea[name$="notes"]');
          if(notes){
            const tag='\nØ¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§: '+codes.replaceAll(',', ', ');
            if(notes.value.indexOf('Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§:')===-1){ notes.value=(notes.value||'')+tag; }
          }
          const mfHidden=document.getElementById('teeth_fdi_mf'); if(mfHidden) mfHidden.value=codes;
        });
      }
    })();

    /* Ø±Ù†Ø¯Ø± Ù†Ù…Ø§ÛŒ Ø¯Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ù„ÛŒØ³Øª */
    (function(){
      function parseFDI(fdi){
        const g={1:[],2:[],3:[],4:[]}; if(!fdi) return g;
        fdi.split(',').map(s=>s.trim()).filter(Boolean).forEach(code=>{
          const q=parseInt(code[0],10), n=parseInt(code.slice(1),10);
          if(g[q] && n>=1 && n<=8) g[q].push(String(n));
        });
        Object.keys(g).forEach(k=>g[k].sort((a,b)=>parseInt(a,10)-parseInt(b,10)));
        return g;
      }
      function fill(el){
        const fdi = el.getAttribute('data-fdi')||'';
        const notes = el.getAttribute('data-notes')||'';
        let UL=[],UR=[],LL=[],LR=[];
        if(fdi){ const x=parseFDI(fdi); UL=x[2]; UR=x[1]; LL=x[3]; LR=x[4]; }
        const map={'tp-ul':UL,'tp-ur':UR,'tp-ll':LL,'tp-lr':LR};
        Object.keys(map).forEach(cls=>{
          const box=el.querySelector('.'+cls); if(!box) return; box.innerHTML='';
          map[cls].forEach(num=>{ const s=document.createElement('span'); s.textContent=num; s.className='active'; box.appendChild(s); });
        });
      }
      document.querySelectorAll('.toothplus').forEach(fill);
    })();

    /* Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ */
    $(document).on('click', 'a.js-order-detail', function (e) {
      if (e.ctrlKey || e.metaKey || e.shiftKey || e.which === 2) return;
      e.preventDefault();
      var href=this.href, $mod=$('#orderDetailModal'), $body=$mod.find('.modal-body');
      $body.html('<div class="text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>');
      new bootstrap.Modal($mod[0]).show();
      fetch(href, { credentials:'same-origin' })
        .then(r=>r.text())
        .then(html=>{
          var m=html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
          $body.html(m?m[1]:html);
          var $inputs=$body.find('input.jalali_date, #id_happened_at');
          $inputs.each(function(){ try{ if(this.type!=='text') this.type='text'; }catch(e){} $(this).attr('autocomplete','off'); });
          $inputs.filter(function(){ return !$(this).data('pDatepicker'); })
            .persianDatepicker({ format:'YYYY/MM/DD', autoClose:true, calendar:{ persian:{ locale:'fa' } } });
          var $form=$body.find('form[action*="add_order_event"]');
          if($form.length){
            var action=$form.attr('action')||'', sep=action.indexOf('?')===-1?'?':'&';
            var nextUrl=window.location.pathname+window.location.search+'#list-tab-pane';
            if(action.indexOf('next=')===-1) $form.attr('action', action+sep+'next='+encodeURIComponent(nextUrl));
          }
        })
        .catch(()=> $body.html('<div class="text-danger">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª.</div>'));
    });

    /* ØªØ¨ ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬: API Ø¯Ú©ØªØ±Ù‡Ø§ Ùˆ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ */
    (function(){
      const $docInput=$("#doctorSearch"), $docList=$("#doctorList");
      const $ordInput=$("#orderSearch"), $ordList=$("#orderList");
      const $form=$("#evtForm"), $selOrder=$("#selectedOrderId");
      const $cause = $("#cause_choice");
      const $causeTextWrap = $("#cause_text_wrap");
      const $stage = $("#stageInstance");

      let doctors=[], orders=[];

      async function fetchDoctors(q){
        const url='/api/doctors'+(q?('?q='+encodeURIComponent(q)):'');
        const data=await fetch(url,{headers:{'Accept':'application/json'}}).then(r=>r.json());
        doctors=data.results||[]; renderDoctors();
      }
      function renderDoctors(){
        $docList.empty();
        doctors.forEach(d=>{
          const $it=$('<button type="button" class="list-group-item list-group-item-action"></button>');
          $it.text(d.name).data('id', d.id).on('click', ()=>{
            $docList.find('.active').removeClass('active'); $it.addClass('active');
            $docInput.val(d.name); fetchOrdersByDoctor(d.id,'');
          });
          $docList.append($it);
        });
      }
      async function fetchOrdersByDoctor(docId,q){
        $ordInput.prop('disabled', false).val(''); $ordList.empty(); $selOrder.val('');
        const url='/api/orders-by-doctor?doctor_id='+encodeURIComponent(docId)+(q?('&q='+encodeURIComponent(q)):'');
        const data=await fetch(url,{headers:{'Accept':'application/json'}}).then(r=>r.json());
        orders=(data.results||[]); renderOrders();
      }
      function populateCauseOptions(stages){
        let html = '<option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>';

      // Ù…Ø±Ø§Ø­Ù„ Ø³ÙØ§Ø±Ø´ (Ø§Ú¯Ø± Ø¨ÙˆØ¯)
        if (stages && stages.length){
          html += '<optgroup label="Ù…Ø±Ø§Ø­Ù„ Ø³ÙØ§Ø±Ø´">';
          stages.forEach(s => {
            const lbl = (s.label || '').toString();
            html += '<option value="'+ lbl.replace(/"/g,'&quot;') +'">'+ lbl +'</option>';
          });
          html += '</optgroup>';
        }

        // Ø¹Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
        html += '<optgroup label="Ø¹Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ">'
              + '<option value="components_announce">Ø§Ø¹Ù„Ø§Ù… Ù‚Ø·Ø¹Ø§Øª</option>'
              + '<option value="components_received">Ø¯Ø±ÛŒØ§ÙØª Ù‚Ø·Ø¹Ø§Øª</option>'
              + '<option value="waxrim_record_bite">waxrim & record bite</option>'
              + '<option value="dural_try_in">Ø§Ù…ØªØ­Ø§Ù† Ø¯ÙˆØ±Ø§Ù„ÛŒ</option>'
              + '<option value="frame_try_in">Ø§Ù…ØªØ­Ø§Ù† ÙØ±ÛŒÙ…</option>'
              + '<option value="porcelain_try_in">Ø§Ù…ØªØ­Ø§Ù† Ù¾Ø±Ø³Ù„Ù†</option>'
              + '<option value="framework_design">Ø·Ø±Ø§Ø­ÛŒ ÙØ±ÛŒÙ…</option>'
              + '<option value="custom_abutment">Ú©Ø§Ø³ØªÙˆÙ…Ø§ÛŒØ² Ø§Ø¨Ø§ØªÙ…Ù†Øª</option>'
              + '<option value="qc_check">Ø¨Ø±Ø±Ø³ÛŒ Ú©ÛŒÙÛŒ</option>'
              + '</optgroup>';

        // Ø³Ø§ÛŒØ±
        html += '<option value="other">Ø³Ø§ÛŒØ± (Ù‚Ø§Ø¨Ù„ ØªØ§ÛŒÙ¾)</option>';

        $cause.html(html);
        // sync Ù†Ù…Ø§ÛŒØ´ ÙÛŒÙ„Ø¯ Â«Ø³Ø§ÛŒØ±Â»
        if ($cause.val() !== 'other') $causeTextWrap.hide();
      }

      async function fetchOrderStagesFor(orderId){
        try{
          const url = '/api/order-stages?order_id=' + encodeURIComponent(orderId);
          const data = await fetch(url, {headers:{'Accept':'application/json'}}).then(r=>r.json());
          populateCauseOptions(data.results || []);
          populateStageSelect(data.results || []);
        }catch(e){
          populateCauseOptions([]); // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø´Ø¯ØŒ ÙÙ‚Ø· Ø¹Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø±Ø§ Ø¨Ú¯Ø°Ø§Ø±
        }
      }

      function labelFor(o){
        const name=(o.patient_name||o.patient||(o.patient&&o.patient.name)||'').toString().trim();
        const due = o.due_date ? (' â€” ØªØ­ÙˆÛŒÙ„: '+o.due_date) : '';
        const sn  = o.serial_number ? (' â€” Ø³Ø±ÛŒØ§Ù„: '+o.serial_number) : '';
        return 'Ø³ÙØ§Ø±Ø´ #'+o.id+(name?(' â€” '+name):' â€” Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…')+sn+due;
      }
      function renderOrders(){
        $ordList.empty();
        orders.forEach(o=>{
          const $it=$('<button type="button" class="list-group-item list-group-item-action"></button>');
          $it.text(labelFor(o)).data('id',o.id).on('click', ()=>{
            $ordList.find('.active').removeClass('active'); $it.addClass('active'); $selOrder.val(String(o.id));
            fetchOrderStagesFor(o.id);
          });
          $ordList.append($it);
        });
      }
      function populateStageSelect(stages){
        let html = '<option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€”</option>';
        if (stages && stages.length){
          stages.forEach(s => {
            const id = (s.id || '').toString();
            const lbl = (s.label || '').toString();
            html += '<option value="'+ id.replace(/"/g,'&quot;') +'">'+ lbl +'</option>';
          });
        }
        $stage.html(html);
      }
      let tDoc=null;
      $docInput.on('input', function(){ const q=$(this).val().trim(); clearTimeout(tDoc); tDoc=setTimeout(()=>fetchDoctors(q),250); });
      fetchDoctors('');

      $ordInput.on('input', function(){
        const q=$(this).val().trim().toLowerCase();
        $ordList.children().each(function(){ const ok=$(this).text().toLowerCase().indexOf(q)>=0; $(this).toggle(ok); });
      });

      // ØªØ§Ø±ÛŒØ® Ø¬Ù„Ø§Ù„ÛŒ Ø§ÛŒÙ† ØªØ¨
      try{ $('#transfer-tab-pane #happenedAt').persianDatepicker({ format:'YYYY/MM/DD', autoClose:true, calendar:{persian:{locale:'fa'}} }); }catch(e){}

      $(document).on('change', '#cause_choice', function(){
        $causeTextWrap.toggle(this.value === 'other');
      });
      $causeTextWrap.toggle($cause.val() === 'other'); // init on load

      $form.on('submit', function(e){
        const oid=($selOrder.val()||'').trim();
        if(!oid){ e.preventDefault(); alert('Ø§ÙˆÙ„ Ø¯Ú©ØªØ± Ùˆ Ø³Ù¾Ø³ ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
        const nextUrl='/orders/#list-tab-pane';
        this.action='/orders/'+encodeURIComponent(oid)+'/add-event/?next='+encodeURIComponent(nextUrl);
      });
    })();

  });
  </script>
  <script>
(function(){
  const iframe = document.getElementById('wb-iframe');
  if (!iframe) return;

  function resizeWB(){
    // Ø§Ú¯Ø± Ø§Ø±ØªÙØ§Ø¹ Ø²ÛŒØ§Ø¯/Ú©Ù… Ø¨ÙˆØ¯ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø±Ùˆ Ú©Ù…ÛŒ Ú©Ù…â€ŒÙˆØ²ÛŒØ§Ø¯ Ú©Ù†
    iframe.style.height = Math.max(400, window.innerHeight - 180) + 'px';
  }

  // ÙˆÙ‚ØªÛŒ ØªØ¨ Â«ÙˆØ±Ú©â€ŒØ¨Ù†Ú†Â» ÙØ¹Ø§Ù„ Ø´Ø¯ØŒ Ø§Ø±ØªÙØ§Ø¹ Ø±Ùˆ ÙÛŒØª Ú©Ù†
  document.addEventListener('shown.bs.tab', function(e){
    if (e.target && e.target.id === 'wb-tab') resizeWB();
  });

  // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÛŒ Ù¾Ù†Ø¬Ø±Ù‡
  window.addEventListener('resize', resizeWB);

  // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ (Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ ÙˆØ§Ø±Ø¯ ØªØ¨ Ø´Ø¯ Ù‡Ù… Ø§ÙˆÚ©ÛŒ Ù…ÛŒØ´Ù‡)
  resizeWB();
})();
</script>
{% endblock %}
















































































