{% extends "base_user_panel.html" %}
{% load num_extras %}
{% load jalali_tags %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯{% endblock %}

{% block head_extra %}
  <style>
    .wrap{display:grid;gap:1rem}
    .heading{font-weight:800;font-size:1.25rem;margin:.25rem 0 1rem}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}
    .kpi{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem;padding:.8rem;cursor:pointer}
    .kpi .t{font-size:.9rem;color:#6b7280;margin-bottom:.25rem}
    .kpi .v{font-weight:800;font-size:1.2rem;font-variant-numeric:tabular-nums}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-top:1rem}
    .card{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem}
    .card-h{padding:.6rem .9rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .card-b{padding:.9rem}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{display:inline-block;padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:.5rem;text-decoration:none;color:#111827}
    .btn:hover{background:#f8fafc}
    .search{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem}
    .search input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .6rem;min-width:260px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:.45rem .55rem;border-top:1px solid #eef2f7;text-align:start}
    .table thead th{background:#f8fafc;white-space:nowrap}
    .num{text-align:end;font-variant-numeric:tabular-nums}
    .muted{color:#6b7280}
    @media (max-width: 520px){ .search input{flex:1} }

    /* Modal */
    .m-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .m-card{background:#fff;max-width:980px;width:96%;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .m-h{display:flex;align-items:center;justify-content:space-between;padding:.7rem 1rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .m-b{padding:1rem;max-height:70vh;overflow:auto}
    .m-close{border:none;background:transparent;font-size:1.2rem;line-height:1;cursor:pointer}
    .hidden{display:none}
  </style>
{% endblock %}

{% block subtabs %}
  <ul class="nav nav-pills mb-3">
    <li class="nav-item"><span class="nav-link active">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'core:orders_home' %}">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'billing:financial_home' %}">Ù…Ø§Ù„ÛŒ</a></li>
    {# ğŸ”§ FIX: Ù…Ø³ÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø± Ø±ÙˆØª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ù†Ø§Ù… 'settings' Ø§Ø³ØªØŒ Ù†Ù‡ 'core:settings' #}
    <li class="nav-item"><a class="nav-link" href="{% url 'settings' %}">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a></li>
  </ul>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="heading">Ø®Ù„Ø§ØµÙ‡Ù” ÙˆØ¶Ø¹ÛŒØª</div>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi" data-title="Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²" data-target="content-orders-today">
      <div class="t">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
      <div class="v">{{ kpis.orders_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ" data-target="content-orders-month">
      <div class="t">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (ØªØ¹Ø¯Ø§Ø¯)</div>
      <div class="v">{{ kpis.orders_month|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…" data-target="content-in-progress">
      <div class="t">Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
      <div class="v">{{ kpis.in_progress|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡" data-target="content-delivered">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</div>
      <div class="v">{{ kpis.done|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="Ù…Ø¹ÙˆÙ‚ (Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡)" data-target="content-overdue">
      <div class="t">Ù…Ø¹ÙˆÙ‚ (Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡)</div>
      <div class="v">{{ kpis.overdue|default:0|int_fa }}</div>
    </div>
    <!-- Ø¯Ùˆ Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ -->
    <div class="kpi" data-title="ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²" data-target="content-deliveries-today">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
      <div class="v">{{ kpis.deliveries_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯Ø§" data-target="content-deliveries-tomorrow">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯Ø§</div>
      <div class="v">{{ kpis.deliveries_tomorrow|default:0|int_fa }}</div>
    </div>
    <div class="kpi">
      <div class="t">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø² (Ù…Ø§Ù„ÛŒ)</div>
      <div class="v">
        {% if kpis.open_invoices is not None %}
          {{ kpis.open_invoices|int_fa }}
        {% else %}
          <span class="muted">â€”</span>
        {% endif %}
      </div>
      <div class="muted" style="margin-top:.25rem"><a class="muted" href="{% url 'billing:report_open_invoices' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²</a></div>
    </div>
  </div>

  <!-- Ø¯Ùˆ Ø³ØªÙˆÙ†: Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ + Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
  <div class="grid">
    <div class="card">
      <div class="card-h">Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§ Ùˆ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹</div>
      <div class="card-b">
        <form method="get" action="{% url 'core:orders_home' %}" class="search">
          <input type="text" name="q" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¨ÛŒÙ…Ø§Ø± / Ù¾Ø²Ø´Ú© / Ø³Ø±ÛŒØ§Ù„ / Ø±Ù†Ú¯">
          <button class="btn" type="submit">Ø¬Ø³ØªØ¬Ùˆ</button>
        </form>
        <div class="actions">
          <a class="btn" href="{% url 'core:home' %}">â• Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a>
          <a class="btn" href="{% url 'core:orders_home' %}#list-tab-pane">ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a>
          <a class="btn" href="{% url 'billing:financial_home' %}">ğŸ’³ Ù…Ø§Ù„ÛŒ</a>
          <a class="btn" href="{% url 'billing:report_aging' %}">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Aging</a>
        </div>
        <div class="muted" style="margin-top:.6rem">
          Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø±ÙØªÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Â«Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§Â»ØŒ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù„ÛŒÙ†Ú© <code>#list-tab-pane</code> Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
      <div class="card-b" style="padding-top:.2rem">
        {% if latest_orders %}
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø¨ÛŒÙ…Ø§Ø±</th>
                  <th>Ù¾Ø²Ø´Ú©</th>
                  <th>Ù†ÙˆØ¹</th>
                  <th>ÙˆØ¶Ø¹ÛŒØª</th>
                  <th>ØªØ­ÙˆÛŒÙ„</th>
                  <th>Ø«Ø¨Øª</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
              {% for o in latest_orders %}
                <tr>
                  <td class="num">{{ forloop.counter|int_fa }}</td>
                  <td>{{ o.patient_name }}</td>
                  <td>{{ o.doctor }}</td>
                  <td>{{ o.get_order_type_display|default:o.order_type }}</td>
                  <td>
                    {% if o.status == 'done' %}
                      <span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
                    {% elif o.status == 'delivered' %}
                      <span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
                    {% elif o.status == 'in_progress' %}
                      <span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
                    {% else %}
                      <span class="muted">{{ o.status }}</span>
                    {% endif %}
                  </td>
                  <td class="muted">
                    {% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}
                  </td>
                  <td class="muted">
                    {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}
                  </td>
                  <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="muted">Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# ---------- Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø®ÙÛŒ Ù‡Ø± KPI: Ø¬Ø¯Ø§ÙˆÙ„ inline (Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† include Ø®Ø§Ø±Ø¬ÛŒ) ---------- #}
<div id="content-orders-today" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th>Ø«Ø¨Øª</th>
<th></th></tr></thead>
      <tbody>
      {% if orders_today_list %}
        {% for o in orders_today_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td class="muted">
              {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}
            </td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-orders-month" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th>Ø«Ø¨Øª</th>
<th></th></tr></thead>
      <tbody>
      {% if orders_month_list %}
        {% for o in orders_month_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td class="muted">
              {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}
            </td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-in-progress" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% if in_progress_list %}
        {% for o in in_progress_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-delivered" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% if delivered_list %}
        {% for o in delivered_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td><span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span></td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-overdue" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% if overdue_list %}
        {% for o in overdue_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-deliveries-today" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% if deliveries_today_list %}
        {% for o in deliveries_today_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-deliveries-tomorrow" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>Ø¨ÛŒÙ…Ø§Ø±</th><th>Ù¾Ø²Ø´Ú©</th><th>Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% if deliveries_tomorrow_list %}
        {% for o in deliveries_tomorrow_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
              {% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="m" class="m-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="m-card">
    <div class="m-h">
      <div id="m-title">Ø¬Ø²Ø¦ÛŒØ§Øª</div>
      <button class="m-close" onclick="closeModal()" aria-label="Ø¨Ø³ØªÙ†">Ã—</button>
    </div>
    <div id="m-body" class="m-b"></div>
  </div>
</div>

<script>
  function openModal(title, html) {
    document.getElementById('m-title').textContent = title || 'Ø¬Ø²Ø¦ÛŒØ§Øª';
    document.getElementById('m-body').innerHTML = html || '<div class="muted">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
    document.getElementById('m').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    document.getElementById('m').style.display = 'none';
    document.body.style.overflow = '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.kpi[data-target]').forEach(function(el){
      el.addEventListener('click', function(){
        var target = this.getAttribute('data-target');
        var title  = this.getAttribute('data-title') || this.querySelector('.t')?.textContent || 'Ø¬Ø²Ø¦ÛŒØ§Øª';
        var src    = document.getElementById(target);
        openModal(title, src ? src.innerHTML : '<div class="muted">Ù„ÛŒØ³ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>');
      });
    });
    document.getElementById('m').addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){ closeModal(); }
    });
  });
</script>
{% endblock %}



















