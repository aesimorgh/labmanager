{% extends "base_user_panel.html" %}
{% load num_extras %}
{% load jalali_tags %}

{% block title %}داشبورد{% endblock %}

{% block head_extra %}
  <style>
    .wrap{display:grid;gap:1rem}
    .heading{font-weight:800;font-size:1.25rem;margin:.25rem 0 1rem}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}
    .kpi{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem;padding:.8rem;cursor:pointer}
    .kpi .t{font-size:.9rem;color:#6b7280;margin-bottom:.25rem}
    .kpi .v{font-weight:800;font-size:1.2rem;font-variant-numeric:tabular-nums}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-top:1rem}
    .card{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem}
    .card-h{padding:.6rem .9rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .card-b{padding:.9rem}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{display:inline-block;padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:.5rem;text-decoration:none;color:#111827}
    .btn:hover{background:#f8fafc}
    .search{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem}
    .search input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .6rem;min-width:260px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:.45rem .55rem;border-top:1px solid #eef2f7;text-align:start}
    .table thead th{background:#f8fafc;white-space:nowrap}
    .num{text-align:end;font-variant-numeric:tabular-nums}
    .muted{color:#6b7280}
    @media (max-width: 520px){ .search input{flex:1} }

    /* Modal */
    .m-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .m-card{background:#fff;max-width:980px;width:96%;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .m-h{display:flex;align-items:center;justify-content:space-between;padding:.7rem 1rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .m-b{padding:1rem;max-height:70vh;overflow:auto}
    .m-close{border:none;background:transparent;font-size:1.2rem;line-height:1;cursor:pointer}
    .hidden{display:none}
  </style>
{% endblock %}

{% block subtabs %}
  <ul class="nav nav-pills mb-3">
    <li class="nav-item"><span class="nav-link active">داشبورد</span></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'core:orders_home' %}">سفارش‌ها</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'billing:financial_home' %}">مالی</a></li>
    {# 🔧 FIX: مسیر تنظیمات در روت پروژه با نام 'settings' است، نه 'core:settings' #}
    <li class="nav-item"><a class="nav-link" href="{% url 'settings' %}">تنظیمات</a></li>
  </ul>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="heading">خلاصهٔ وضعیت</div>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi" data-title="سفارش‌های امروز" data-target="content-orders-today">
      <div class="t">سفارش‌های امروز</div>
      <div class="v">{{ kpis.orders_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="سفارش‌های ماه جاری" data-target="content-orders-month">
      <div class="t">سفارش‌های ماه جاری (تعداد)</div>
      <div class="v">{{ kpis.orders_month|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="درحال انجام" data-target="content-in-progress">
      <div class="t">درحال انجام</div>
      <div class="v">{{ kpis.in_progress|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="تحویل‌شده" data-target="content-delivered">
      <div class="t">تحویل‌شده</div>
      <div class="v">{{ kpis.done|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="معوق (سررسید گذشته)" data-target="content-overdue">
      <div class="t">معوق (سررسید گذشته)</div>
      <div class="v">{{ kpis.overdue|default:0|int_fa }}</div>
    </div>
    <!-- دو کارت جدید -->
    <div class="kpi" data-title="تحویل‌های امروز" data-target="content-deliveries-today">
      <div class="t">تحویل‌های امروز</div>
      <div class="v">{{ kpis.deliveries_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi" data-title="تحویل‌های فردا" data-target="content-deliveries-tomorrow">
      <div class="t">تحویل‌های فردا</div>
      <div class="v">{{ kpis.deliveries_tomorrow|default:0|int_fa }}</div>
    </div>
    <div class="kpi">
      <div class="t">فاکتورهای باز (مالی)</div>
      <div class="v">
        {% if kpis.open_invoices is not None %}
          {{ kpis.open_invoices|int_fa }}
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
      <div class="muted" style="margin-top:.25rem"><a class="muted" href="{% url 'billing:report_open_invoices' %}">مشاهدهٔ مطالبات باز</a></div>
    </div>
  </div>

  <!-- دو ستون: جستجوی سریع + آخرین سفارش‌ها -->
  <div class="grid">
    <div class="card">
      <div class="card-h">میانبرها و جستجوی سریع</div>
      <div class="card-b">
        <form method="get" action="{% url 'core:orders_home' %}" class="search">
          <input type="text" name="q" placeholder="جستجو: بیمار / پزشک / سریال / رنگ">
          <button class="btn" type="submit">جستجو</button>
        </form>
        <div class="actions">
          <a class="btn" href="{% url 'core:home' %}">➕ ثبت سفارش جدید</a>
          <a class="btn" href="{% url 'core:orders_home' %}#list-tab-pane">📋 لیست سفارش‌ها</a>
          <a class="btn" href="{% url 'billing:financial_home' %}">💳 مالی</a>
          <a class="btn" href="{% url 'billing:report_aging' %}">📊 گزارش Aging</a>
        </div>
        <div class="muted" style="margin-top:.6rem">
          نکته: برای رفتن مستقیم به «لیست سفارش‌ها»، به انتهای لینک <code>#list-tab-pane</code> اضافه شده است.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">آخرین سفارش‌ها</div>
      <div class="card-b" style="padding-top:.2rem">
        {% if latest_orders %}
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>بیمار</th>
                  <th>پزشک</th>
                  <th>نوع</th>
                  <th>وضعیت</th>
                  <th>تحویل</th>
                  <th>ثبت</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
              {% for o in latest_orders %}
                <tr>
                  <td class="num">{{ forloop.counter|int_fa }}</td>
                  <td>{{ o.patient_name }}</td>
                  <td>{{ o.doctor }}</td>
                  <td>{{ o.get_order_type_display|default:o.order_type }}</td>
                  <td>
                    {% if o.status == 'done' %}
                      <span class="muted">انجام‌شده</span>
                    {% elif o.status == 'delivered' %}
                      <span class="muted">تحویل‌شده</span>
                    {% elif o.status == 'in_progress' %}
                      <span>درحال انجام</span>
                    {% else %}
                      <span class="muted">{{ o.status }}</span>
                    {% endif %}
                  </td>
                  <td class="muted">
                    {% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}
                  </td>
                  <td class="muted">
                    {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}—{% endif %}
                  </td>
                  <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="muted">سفارشی برای نمایش نیست.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# ---------- محتوای مخفی هر KPI: جداول inline (بدون هیچ include خارجی) ---------- #}
<div id="content-orders-today" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th>ثبت</th>
<th></th></tr></thead>
      <tbody>
      {% if orders_today_list %}
        {% for o in orders_today_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td class="muted">
              {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}—{% endif %}
            </td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-orders-month" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th>ثبت</th>
<th></th></tr></thead>
      <tbody>
      {% if orders_month_list %}
        {% for o in orders_month_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td class="muted">
              {% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}—{% endif %}
            </td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-in-progress" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th></th></tr></thead>
      <tbody>
      {% if in_progress_list %}
        {% for o in in_progress_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-delivered" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th></th></tr></thead>
      <tbody>
      {% if delivered_list %}
        {% for o in delivered_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td><span class="muted">تحویل‌شده</span></td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-overdue" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th></th></tr></thead>
      <tbody>
      {% if overdue_list %}
        {% for o in overdue_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-deliveries-today" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th></th></tr></thead>
      <tbody>
      {% if deliveries_today_list %}
        {% for o in deliveries_today_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div id="content-deliveries-tomorrow" class="hidden">
  <div style="overflow:auto">
    <table class="table">
      <thead><tr><th>#</th><th>بیمار</th><th>پزشک</th><th>نوع</th><th>وضعیت</th><th>تحویل</th><th></th></tr></thead>
      <tbody>
      {% if deliveries_tomorrow_list %}
        {% for o in deliveries_tomorrow_list %}
          <tr>
            <td class="num">{{ forloop.counter|int_fa }}</td>
            <td>{{ o.patient_name }}</td>
            <td>{{ o.doctor }}</td>
            <td>{{ o.get_order_type_display|default:o.order_type }}</td>
            <td>
              {% if o.status == 'done' %}<span class="muted">انجام‌شده</span>
              {% elif o.status == 'delivered' %}<span class="muted">تحویل‌شده</span>
              {% elif o.status == 'in_progress' %}<span>درحال انجام</span>
              {% else %}<span class="muted">{{ o.status }}</span>{% endif %}
            </td>
            <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}—{% endif %}</td>
            <td><a class="btn" href="{% url 'core:order_detail' o.id %}">جزئیات</a></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="muted">آیتمی برای نمایش نیست.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div id="m" class="m-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="m-card">
    <div class="m-h">
      <div id="m-title">جزئیات</div>
      <button class="m-close" onclick="closeModal()" aria-label="بستن">×</button>
    </div>
    <div id="m-body" class="m-b"></div>
  </div>
</div>

<script>
  function openModal(title, html) {
    document.getElementById('m-title').textContent = title || 'جزئیات';
    document.getElementById('m-body').innerHTML = html || '<div class="muted">موردی یافت نشد.</div>';
    document.getElementById('m').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    document.getElementById('m').style.display = 'none';
    document.body.style.overflow = '';
  }
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.kpi[data-target]').forEach(function(el){
      el.addEventListener('click', function(){
        var target = this.getAttribute('data-target');
        var title  = this.getAttribute('data-title') || this.querySelector('.t')?.textContent || 'جزئیات';
        var src    = document.getElementById(target);
        openModal(title, src ? src.innerHTML : '<div class="muted">لیستی برای نمایش نیست.</div>');
      });
    });
    document.getElementById('m').addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){ closeModal(); }
    });
  });
</script>
{% endblock %}



















