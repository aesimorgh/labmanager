{% extends "base_user_panel.html" %}
{% load num_extras %}
{% load jalali_tags %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯{% endblock %}

{% block head_extra %}
  <style>
    .wrap{display:grid;gap:1rem}
    .heading{font-weight:800;font-size:1.25rem;margin:.25rem 0 1rem}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}
    .kpi{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem;padding:.9rem;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .kpi:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .kpi .t{font-size:.9rem;color:#64748b;margin-bottom:.35rem}
    .kpi .v{font-weight:800;font-size:1.25rem;font-variant-numeric:tabular-nums;color:#0f172a}

    /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ù…Ù„Ø§ÛŒÙ… (pastel) */
    .kpi.colored{color:#0f172a;border-color:#e5e7eb}
    .kpi.colored .t{color:#475569}
    .kpi--blue  {background:linear-gradient(135deg,#eef4ff 0%, #e6eeff 100%)}
    .kpi--green {background:linear-gradient(135deg,#e8f8ef 0%, #dcf6e7 100%)}
    .kpi--amber {background:linear-gradient(135deg,#fff6e1 0%, #ffefcc 100%)}
    .kpi--purple{background:linear-gradient(135deg,#f3eaff 0%, #ece2ff 100%)}
    .kpi--red   {background:linear-gradient(135deg,#ffe9e9 0%, #ffdede 100%)}
    .kpi--teal  {background:linear-gradient(135deg,#e9fffb 0%, #d8fbf5 100%)}
    .kpi--indigo{background:linear-gradient(135deg,#eef0ff 0%, #e6e8ff 100%)}
    .kpi--slate {background:linear-gradient(135deg,#f2f6fa 0%, #eef3f8 100%)}

    .kpi--link{display:block;text-decoration:none}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;margin-top:1rem}
    .card{border:1px solid #e5e7eb;background:#fff;border-radius:.75rem}
    .card-h{padding:.6rem .9rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .card-b{padding:.9rem}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{display:inline-block;padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:.5rem;text-decoration:none;color:#111827}
    .btn:hover{background:#f8fafc}
    .search{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem}
    .search input{border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem .6rem;min-width:260px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:.45rem .55rem;border-top:1px solid #eef2f7;text-align:start}
    .table thead th{background:#f8fafc;white-space:nowrap;position:sticky;top:0;z-index:1}
    .num{text-align:end;font-variant-numeric:tabular-nums}
    .muted{color:#6b7280}
    @media (max-width: 520px){ .search input{flex:1} }

    /* Modal */
    .m-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .m-card{background:#fff;max-width:980px;width:96%;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .m-h{display:flex;align-items:center;justify-content:space-between;padding:.7rem 1rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .m-b{padding:1rem;max-height:70vh;overflow:auto}  /* ØªÙ†Ù‡Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„Ø± Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§Ø³Øª */
    .m-close{border:none;background:transparent;font-size:1.2rem;line-height:1;cursor:pointer}

    .tbl-toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.5rem}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:.25rem .6rem;background:#fff;cursor:pointer;font-size:.9rem}
    .chip.active{background:#111827;color:#fff;border-color:#111827}
    th.sortable{cursor:pointer}
    th.sortable:after{content:"â†•";margin-inline-start:.35rem;font-size:.8em;color:#9ca3af}
    th.sortable.asc:after{content:"â†‘"}
    th.sortable.desc:after{content:"â†“"}

    .chart-wrap{height:320px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block subtabs %}
  <ul class="nav nav-pills mb-3">
    <li class="nav-item"><span class="nav-link active">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'core:orders_home' %}">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'billing:financial_home' %}">Ù…Ø§Ù„ÛŒ</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'settings_app:settings_home' %}">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a></li>
  </ul>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="heading">Ø®Ù„Ø§ØµÙ‡Ù” ÙˆØ¶Ø¹ÛŒØª</div>

  <div class="kpis">
    <div class="kpi colored kpi--blue" data-title="Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²" data-target="content-orders-today">
      <div class="t">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
      <div class="v">{{ kpis.orders_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--indigo" data-title="Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ" data-target="content-orders-month">
      <div class="t">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ (ØªØ¹Ø¯Ø§Ø¯)</div>
      <div class="v">{{ kpis.orders_month|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--purple" data-title="Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…" data-target="content-in-progress">
      <div class="t">Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
      <div class="v">{{ kpis.in_progress|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--green" data-title="ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡" data-target="content-delivered">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</div>
      <div class="v">{{ kpis.done|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--red" data-title="Ù…Ø¹ÙˆÙ‚ (Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡)" data-target="content-overdue">
      <div class="t">Ù…Ø¹ÙˆÙ‚ (Ø³Ø±Ø±Ø³ÛŒØ¯ Ú¯Ø°Ø´ØªÙ‡)</div>
      <div class="v">{{ kpis.overdue|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--amber" data-title="ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²" data-target="content-deliveries-today">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
      <div class="v">{{ kpis.deliveries_today|default:0|int_fa }}</div>
    </div>
    <div class="kpi colored kpi--teal" data-title="ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯Ø§" data-target="content-deliveries-tomorrow">
      <div class="t">ØªØ­ÙˆÛŒÙ„â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯Ø§</div>
      <div class="v">{{ kpis.deliveries_tomorrow|default:0|int_fa }}</div>
    </div>
    <a class="kpi colored kpi--slate kpi--link" href="{% url 'billing:report_open_invoices' %}">
      <div class="t">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø² (Ù…Ø§Ù„ÛŒ)</div>
      <div class="v">
        {% if kpis.open_invoices is not None %}
          {{ kpis.open_invoices|int_fa }}
        {% else %}
          <span style="opacity:.8">â€”</span>
        {% endif %}
      </div>
    </a>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-h">Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§ Ùˆ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹</div>
      <div class="card-b">
        <form method="get" action="{% url 'core:orders_home' %}" class="search">
          <input type="text" name="q" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø¨ÛŒÙ…Ø§Ø± / Ù¾Ø²Ø´Ú© / Ø³Ø±ÛŒØ§Ù„ / Ø±Ù†Ú¯">
          <button class="btn" type="submit">Ø¬Ø³ØªØ¬Ùˆ</button>
        </form>
        <div class="actions">
          <a class="btn" href="{% url 'core:home' %}">â• Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</a>
          <a class="btn" href="{% url 'core:orders_home' %}#list-tab-pane">ğŸ“‹ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</a>
          <a class="btn" href="{% url 'billing:financial_home' %}">ğŸ’³ Ù…Ø§Ù„ÛŒ</a>
          <a class="btn" href="{% url 'billing:report_aging' %}">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Aging</a>
        </div>
        <div class="muted" style="margin-top:.6rem">
          Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø±ÙØªÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Â«Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§Â»ØŒ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù„ÛŒÙ†Ú© <code>#list-tab-pane</code> Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</div>
      <div class="card-b" style="padding-top:.2rem">
        {% if latest_orders %}
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø¨ÛŒÙ…Ø§Ø±</th>
                  <th>Ù¾Ø²Ø´Ú©</th>
                  <th>Ù†ÙˆØ¹</th>
                  <th>ÙˆØ¶Ø¹ÛŒØª</th>
                  <th>ØªØ­ÙˆÛŒÙ„</th>
                  <th>Ø«Ø¨Øª</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
              {% for o in latest_orders %}
                <tr>
                  <td class="num">{{ forloop.counter|int_fa }}</td>
                  <td>{{ o.patient_name }}</td>
                  <td>{{ o.doctor }}</td>
                  <td>{{ o.get_order_type_display|default:o.order_type }}</td>
                  <td>
                    {% if o.status == 'done' %}
                      <span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>
                    {% elif o.status == 'delivered' %}
                      <span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
                    {% elif o.status == 'in_progress' %}
                      <span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
                    {% else %}
                      <span class="muted">{{ o.status }}</span>
                    {% endif %}
                  </td>
                  <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
                  <td class="muted">{% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}</td>
                  <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="muted">Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">ØªÙÚ©ÛŒÚ© Ù†ÙˆØ¹ Ú©Ø§Ø± Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</div>
    <div class="card-b">
      {% if orders_month_list %}
        <div class="chart-wrap">
          <canvas id="orders-type-chart" aria-label="Orders By Type Pie" role="img"></canvas>
        </div>
      {% else %}
        <div class="muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>
      {% endif %}
    </div>
  </div>

</div>

{# ===== Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ KPI Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† overflow Ø¯Ø§Ø®Ù„ÛŒ ØªØ§ sticky Ú©Ø§Ø± Ú©Ù†Ø¯) ===== #}

<template id="content-orders-today">
  <div>
    <div class="tbl-toolbar" data-has-status="1">
      <span class="chip active" data-status="all">Ù‡Ù…Ù‡</span>
      <span class="chip" data-status="in_progress">Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
      <span class="chip" data-status="delivered">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
    </div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th class="sortable">Ø«Ø¨Øª</th><th></th></tr></thead>
      <tbody>
      {% for o in orders_today_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>{% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>{% else %}<span class="muted">{{ o.status }}</span>{% endif %}</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td class="muted">{% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="8" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-orders-month">
  <div>
    <div class="tbl-toolbar" data-has-status="1">
      <span class="chip active" data-status="all">Ù‡Ù…Ù‡</span>
      <span class="chip" data-status="in_progress">Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
      <span class="chip" data-status="delivered">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
    </div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th class="sortable">Ø«Ø¨Øª</th><th></th></tr></thead>
      <tbody>
      {% for o in orders_month_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>{% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>{% else %}<span class="muted">{{ o.status }}</span>{% endif %}</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td class="muted">{% if o.order_date %}{{ o.order_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="8" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-in-progress">
  <div>
    <div class="tbl-toolbar" data-has-status="1">
      <span class="chip active" data-status="all">Ù‡Ù…Ù‡</span>
      <span class="chip" data-status="in_progress">Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
      <span class="chip" data-status="delivered">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>
    </div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% for o in in_progress_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-delivered">
  <div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th>ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% for o in delivered_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td><span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span></td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-overdue">
  <div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% for o in overdue_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>{% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>{% else %}<span class="muted">{{ o.status }}</span>{% endif %}</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-deliveries-today">
  <div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% for o in deliveries_today_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>{% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>{% else %}<span class="muted">{{ o.status }}</span>{% endif %}</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-deliveries-tomorrow">
  <div>
    <table class="table">
      <thead><tr>
        <th class="sortable">#</th><th class="sortable">Ø¨ÛŒÙ…Ø§Ø±</th><th class="sortable">Ù¾Ø²Ø´Ú©</th>
        <th class="sortable">Ù†ÙˆØ¹</th><th class="sortable">ÙˆØ¶Ø¹ÛŒØª</th>
        <th class="sortable">ØªØ­ÙˆÛŒÙ„</th><th></th></tr></thead>
      <tbody>
      {% for o in deliveries_tomorrow_list %}
        <tr>
          <td class="num">{{ forloop.counter|int_fa }}</td>
          <td>{{ o.patient_name }}</td>
          <td>{{ o.doctor }}</td>
          <td>{{ o.get_order_type_display|default:o.order_type }}</td>
          <td>{% if o.status == 'done' %}<span class="muted">Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'delivered' %}<span class="muted">ØªØ­ÙˆÛŒÙ„â€ŒØ´Ø¯Ù‡</span>{% elif o.status == 'in_progress' %}<span>Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>{% else %}<span class="muted">{{ o.status }}</span>{% endif %}</td>
          <td class="muted">{% if o.due_date %}{{ o.due_date|jalali_date }}{% else %}â€”{% endif %}</td>
          <td><a class="btn" href="{% url 'core:order_detail' o.id %}">Ø¬Ø²Ø¦ÛŒØ§Øª</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="muted">Ø¢ÛŒØªÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</template>

<template id="content-open-invoices">
  <div style="padding:.25rem .25rem .75rem">
    <div class="muted" style="margin-bottom:.5rem">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù„ÛŒØ³Øª Ø¯Ù‚ÛŒÙ‚ Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø²ØŒ Ø§Ø² Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>
    <a class="btn" href="{% url 'billing:report_open_invoices' %}">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ø² Ø¯Ø± Ù…Ø§Ù„ÛŒ</a>
  </div>
</template>

{# Ø¯Ø§Ø¯Ù‡Ù” Ù†Ù…ÙˆØ¯Ø§Ø± â€” Ø§Ú¯Ø± orders_type_for_chart Ø§Ø² ÙˆÛŒÙˆ Ø¨ÛŒØ§Ø¯ Ø§Ø² Ù‡Ù…ÙˆÙ† Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…ØŒ ÙˆÚ¯Ø±Ù†Ù‡ Ø§Ø² orders_month_list #}
<script id="orders-type-data" type="application/json">[
{% if orders_type_for_chart %}
  {% for t in orders_type_for_chart %}"{{ t|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
{% else %}
  {% for o in orders_month_list %}"{{ o.get_order_type_display|default:o.order_type|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
{% endif %}
]</script>

<div id="m" class="m-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="m-card">
    <div class="m-h">
      <div id="m-title">Ø¬Ø²Ø¦ÛŒØ§Øª</div>
      <button class="m-close" onclick="closeModal()" aria-label="Ø¨Ø³ØªÙ†">Ã—</button>
    </div>
    <div id="m-body" class="m-b"></div>
  </div>
</div>

<script>
  function openModal(title, html){
    document.getElementById('m-title').textContent = title || 'Ø¬Ø²Ø¦ÛŒØ§Øª';
    document.getElementById('m-body').innerHTML = html || '<div class="muted">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
    document.getElementById('m').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    enhanceModalTable();
  }
  function closeModal(){
    document.getElementById('m').style.display = 'none';
    document.body.style.overflow = '';
  }

  function enhanceModalTable(){
    const body = document.getElementById('m-body');
    const table = body.querySelector('table');
    if(!table) return;

    // sorting
    const ths = table.querySelectorAll('thead th.sortable');
    ths.forEach((th, idx)=>{
      th.addEventListener('click', ()=>{
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const dir = th.classList.contains('asc') ? 'desc' : 'asc';
        ths.forEach(x=>x.classList.remove('asc','desc'));
        th.classList.add(dir);

        const getText = tr => (tr.children[idx]?.innerText || '').trim();
        const isNumCol = th.textContent.trim() === '#' || th.classList.contains('num');
        const norm = v => isNumCol ? (parseFloat(v.replace(/[^\d.-]/g,'')) || 0) : v;

        rows.sort((a,b)=>{
          const va = norm(getText(a)), vb = norm(getText(b));
          if(va < vb) return dir==='asc' ? -1 : 1;
          if(va > vb) return dir==='asc' ? 1 : -1;
          return 0;
        });
        rows.forEach(r=>tbody.appendChild(r));
      });
    });

    // status filter
    const toolbar = body.querySelector('.tbl-toolbar');
    if(!toolbar) return;
    const hasStatus = toolbar.getAttribute('data-has-status') === '1';
    if(!hasStatus) return;

    const chips = toolbar.querySelectorAll('.chip');
    const statusColIndex = (()=>{
      const headers = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
      return headers.findIndex(h => h.includes('ÙˆØ¶Ø¹ÛŒØª'));
    })();
    if(statusColIndex < 0) return;

    const normalize = txt => {
      txt = (txt||'').trim();
      if(txt.includes('ØªØ­ÙˆÛŒÙ„')) return 'delivered';
      if(txt.includes('Ø¯Ø±Ø­Ø§Ù„')) return 'in_progress';
      if(txt.includes('Ø§Ù†Ø¬Ø§Ù…')) return 'done';
      return 'other';
    };

    chips.forEach(ch=>{
      ch.addEventListener('click', ()=>{
        chips.forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        const key = ch.getAttribute('data-status');
        table.querySelectorAll('tbody tr').forEach(tr=>{
          const cell = tr.children[statusColIndex];
          const val = normalize(cell ? cell.innerText : '');
          tr.style.display = (key==='all') ? '' : (val===key ? '' : 'none');
        });
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.kpi[data-target]').forEach(function(el){
      el.addEventListener('click', function(){
        const target = this.getAttribute('data-target');
        const title  = this.getAttribute('data-title') || this.querySelector('.t')?.textContent || 'Ø¬Ø²Ø¦ÛŒØ§Øª';
        const tpl    = document.getElementById(target);
        let html = '<div class="muted">Ù„ÛŒØ³ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>';
        if(tpl){ html = tpl.innerHTML; }
        openModal(title, html);
      });
    });

    document.getElementById('m').addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){ closeModal(); }
    });
  });

  // Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø§ÛŒ
  document.addEventListener('DOMContentLoaded', function(){
    const dataEl = document.getElementById('orders-type-data');
    const canvas = document.getElementById('orders-type-chart');
    if(!dataEl || !canvas) return;

    let raw = dataEl.textContent || '[]';
    let arr = [];
    try { arr = JSON.parse(raw); } catch(e){ arr = []; }

    const counts = {};
    arr.forEach(t=>{
      const key = (t || 'Ù†Ø§Ù…Ø´Ø®Øµ').toString().trim();
      counts[key] = (counts[key]||0) + 1;
    });

    const labels = Object.keys(counts);
    const values = labels.map(l => counts[l]);
    if(values.length === 0){ return; }

    const palette = ['#e6eeff','#dcf6e7','#ffefcc','#ece2ff','#ffdede','#d8fbf5','#e6e8ff','#eef3f8','#fbe5ff','#e0f2fe','#fee2e2','#dcfce7'];
    const colors = labels.map((_,i)=> palette[i % palette.length]);

    new Chart(canvas.getContext('2d'), {
      type: 'pie',
      data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 1 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', rtl: true, labels: { usePointStyle: true, boxWidth: 10 } },
          tooltip: { callbacks: { label: (ctx)=> (ctx.label||'') + ' â€“ ' + (ctx.parsed||0).toLocaleString('fa-IR') + ' Ù…ÙˆØ±Ø¯' } }
        }
      }
    });
  });
</script>
{% endblock %}































