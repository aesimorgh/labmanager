{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø§Ø±Ø³Ø§Ù„/Ø¯Ø±ÛŒØ§ÙØª Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <style>
    body{background:#f8fafc}
    .card{max-width:1200px;margin:24px auto}
    .pick-list{max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem;padding:.25rem;background:#fff}
    .pick-item{padding:.5rem .65rem;border-radius:.5rem;cursor:pointer;line-height:1.4}
    .pick-item:hover{background:#f1f5f9}
    .pick-item.active{background:#e0e7ff}
    .pick-sub{font-size:.85rem;color:#6b7280;margin-top:2px}
    .hint{font-size:.9rem;color:#6b7280}
    .required-star::after{content:" *";color:#ef4444}
    .card-header .crumb{opacity:.9;font-weight:500}
    .toggle-link{font-size:.85rem; margin-inline-start:8px; cursor:pointer}
    .d-none{display:none !important}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0}
  </style>
</head>
<body>
<div class="card shadow-sm">
  <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
    <span>Ø§Ø±Ø³Ø§Ù„ / Ø¯Ø±ÛŒØ§ÙØª Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</span>
    <span class="crumb">Ø³ÙØ§Ø±Ø´: {{ order.id|default:"â€”" }}</span>
  </div>

  <div class="card-body">
    <div class="row g-3">

      <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ú©ØªØ± -->
      <div class="col-lg-6">
        <label class="form-label required-star">
          Ø¯Ú©ØªØ± / Ù…Ø·Ø¨
          <a id="changeDoctor" class="toggle-link text-primary d-none">ØªØºÛŒÛŒØ±</a>
        </label>
        <input id="doctorSearch" class="form-control" placeholder="Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯â€¦">
        <div id="doctorList" class="pick-list mt-2"></div>
        <div class="hint">Ø¨Ø§ ØªØ§ÛŒÙ¾ Ú©Ø±Ø¯Ù†ØŒ Ø¯Ú©ØªØ±Ù‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
      </div>

      <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
      <div class="col-lg-6">
        <label class="form-label required-star">
          Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
          <a id="changeOrders" class="toggle-link text-primary d-none">ØªØºÛŒÛŒØ±</a>
        </label>
        <input id="orderSearch" class="form-control" type="text" placeholder="Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø± / Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„" disabled>
        <div id="orderList" class="pick-list mt-2"></div>
        <div class="hint">Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ú©ØªØ±ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
      </div>

      <!-- ÙØ±Ù… -->
      <div class="col-12">
        <form id="dlabForm" method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}
          <!-- Hidden Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® (ISO) Ùˆ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ØªÙ†ÛŒ -->
          <input type="hidden" name="sent_date" id="sent_date">
          <input type="hidden" name="received_date" id="received_date">
          <input type="hidden" name="stage_name" id="stage_name">
          <input type="hidden" name="shade_code" id="shade_code">
          <input type="hidden" name="credit_amount" id="credit_amount">
          <!-- Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø§ÛŒÙ…Ù¾Ù„Ù†Øª/Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¨Ø§ØªÙ…Ù†Øª -->
          <input type="hidden" name="units_override" id="units_override">

          <div class="row g-3 mt-1">

            <div class="col-md-3">
              <label class="form-label required-star">Ù„Ø§Ø¨ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</label>
              {{ form.lab_name }}
            </div>

            <!-- Ù…Ø±Ø­Ù„Ù‡: Ù„ÛŒØ³Øª Ø²ÛŒØ¨Ø§ Ù…Ø«Ù„ Ø¨Ù‚ÛŒÙ‡ -->
            <div class="col-md-3">
              <label class="form-label required-star">
                Ù…Ø±Ø­Ù„Ù‡
                <a id="changeStage" class="toggle-link text-primary d-none">ØªØºÛŒÛŒØ±</a>
              </label>
              <input id="stage_display" class="form-control" placeholder="Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†â€¦" disabled>
              <div id="stageList" class="pick-list mt-2 d-none"></div>
              <div class="hint">Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ§Ø±Ø´ØŒ Ù…Ø±Ø­Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø§Ù† Ù…Ø­ØµÙˆÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            </div>

            <div class="col-md-3">
              <label class="form-label">Ø±Ù†Ú¯</label>
              <input id="shade_display" class="form-control" list="shade_list" placeholder="A1 / BL2â€¦" disabled>
              <datalist id="shade_list">
                <option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ù†Ú¯ â€”</option>
                <option>A1</option><option>A2</option><option>A3</option><option>A3.5</option><option>A4</option>
                <option>B1</option><option>B2</option><option>B3</option><option>B4</option>
                <option>C1</option><option>C2</option><option>C3</option><option>C4</option>
                <option>D2</option><option>D3</option><option>D4</option>
                <option>BL1</option><option>BL2</option><option>BL3</option><option>BL4</option>
              </datalist>
            </div>

            <div class="col-md-3">
              <label class="form-label required-star">Ù†ÙˆØ¹ Ø«Ø¨Øª</label>
              {{ form.status }}
              <div class="hint">Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ Ø¯Ø±ÛŒØ§ÙØª</div>
            </div>

            <div class="col-md-3">
              <label class="form-label required-star">ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„ (Ø´Ù…Ø³ÛŒ)</label>
              <input id="sent_date_fa" class="form-control jalali_date" placeholder="Û±Û´Û°Û´/Û°Û¸/Û±Û°" inputmode="numeric" dir="ltr" disabled>
            </div>
            <div class="col-md-3">
              <label class="form-label">ØªØ§Ø±ÛŒØ® Ø¯Ø±ÛŒØ§ÙØª (Ø´Ù…Ø³ÛŒ)</label>
              <input id="received_date_fa" class="form-control jalali_date" placeholder="Û±Û´Û°Û´/Û°Û¸/Û±Ûµ" inputmode="numeric" dir="ltr" disabled>
            </div>

            <div class="col-md-3">
              <label class="form-label required-star">Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
              <input id="charge_display" class="form-control" placeholder="Û±Ù¬ÛµÛ°Û°Ù¬Û°Û°Û°" inputmode="numeric" dir="ltr" disabled>
              <div class="hint">Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙØ§Ø±Ø´ØŒ Ø¨Ø§ ØªØ¹Ø¯Ø§Ø¯ Ø®ÙˆØ¯ Ø³ÙØ§Ø±Ø´ Ø¶Ø±Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Ø§Ø¹ØªØ¨Ø§Ø± / Ø¨Ø±Ú¯Ø´Øª</label>
              <input id="credit_display" class="form-control" placeholder="Û°" inputmode="numeric" dir="ltr" disabled>
            </div>

            <!-- ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø³ÙØ§Ø±Ø´ Ø§ÛŒÙ…Ù¾Ù„Ù†Øª Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¨Ø§ØªÙ…Ù†Øª Ø¨Ø§Ø´Ø¯ -->
            <div id="abutmentBox" class="col-md-3 d-none">
              <label class="form-label required-star">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨Ø§ØªÙ…Ù†Øª</label>
              <input id="abutment_count" class="form-control" placeholder="Û²" inputmode="numeric" dir="ltr">
              <div class="hint">ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Â«Ø§ÛŒÙ…Ù¾Ù„Ù†Øª + Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¨Ø§ØªÙ…Ù†ØªÂ»</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
              {{ form.note }}
            </div>
          </div>

          <hr>

          <!-- Ù†ÙˆØ§Ø± Ø®Ù„Ø§ØµÙ‡ -->
          <div id="summaryBar" class="d-flex flex-wrap align-items-center justify-content-between mb-2" style="gap:12px;">
            <div class="small text-muted">
              Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: <span id="selCount">Û°</span> Ø³ÙØ§Ø±Ø´
              <span class="mx-2">|</span>
              Ø¬Ù…Ø¹ Ù…Ø¨Ù„Øº ØªØ®Ù…ÛŒÙ†ÛŒ: <span id="estTotal">Û°</span> ØªÙˆÙ…Ø§Ù†
            </div>
            <div class="small text-muted">
              (Ø¬Ù…Ø¹ = Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯ Ã— Ù…Ø¬Ù…ÙˆØ¹ Â«ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯Â» Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ â€” Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø³Ø±ÙˆØ±)
            </div>
          </div>

          <div class="mt-2">
            <button class="btn btn-success" id="submitBtn" type="submit" disabled>Ø«Ø¨Øª</button>
            <a href="{% url 'core:orders_home' %}" class="btn btn-outline-secondary">Ø§Ù†ØµØ±Ø§Ù</a>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script>
(function(){
  // --- Ø§Ø¨Ø²Ø§Ø± Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ/Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ---
  const faDigits="Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹", enDigits="0123456789";
  const mapFa2En=Object.fromEntries(faDigits.split('').map((d,i)=>[d,enDigits[i]]));
  function faToEn(s){return String(s||'').replace(/[Û°-Û¹]/g,d=>mapFa2En[d]);}
  function enToFa(s){return String(s||'').replace(/[0-9]/g,d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);}

  function normalizeMoneyFaToAscii(s){
    if(!s) return "0.00";
    const en=faToEn(String(s)).replace(/[,\s]/g,'');
    if(!en) return "0.00";
    const parts=en.split('.');
    if(parts.length===1) return `${en}.00`;
    return `${parts[0]}.${(parts[1]+'00').slice(0,2)}`;
  }

  function jalaliFaToISO($inp){
    const val=$inp.val().trim(); if(!val) return "";
    const en = faToEn(val).replace(/\s/g,'');
    const m = en.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
    if(!m) return "";
    return `${m[1]}-${m[2]}-${m[3]}`;
  }

  // Ø¹Ù†Ø§ØµØ±
  const $form=$("#dlabForm");
  const $docInput=$("#doctorSearch"), $docList=$("#doctorList"), $docChange=$("#changeDoctor");
  const $ordInput=$("#orderSearch"), $ordList=$("#orderList"), $ordChange=$("#changeOrders");
  const $stageDisp=$("#stage_display"), $stageList=$("#stageList"), $stageChange=$("#changeStage");
  const $shade=$("#shade_display"), $sent=$("#sent_date_fa"), $recv=$("#received_date_fa");
  const $charge=$("#charge_display"), $credit=$("#credit_display"), $btn=$("#submitBtn");
  const $abutBox=$("#abutmentBox"), $abut=$("#abutment_count");

  let doctors=[], orders=[], stageLabels=[];
  function enableForm(ok){
    [$stageDisp,$shade,$sent,$recv,$charge,$credit,$btn].forEach($e=>$e.prop('disabled',!ok));
  }
  enableForm(false);

  function initPickers(){
    try{
      $sent.persianDatepicker({format:'YYYY/MM/DD', autoClose:true, calendar:{persian:{locale:'fa'}}});
      $recv.persianDatepicker({format:'YYYY/MM/DD', autoClose:true, calendar:{persian:{locale:'fa'}}});
    }catch(e){}
  }

  // ========== Ø¯Ú©ØªØ± ==========
  async function fetchDoctors(q){
    const url=`{% url 'core:api_doctors' %}`+(q?`?q=${encodeURIComponent(q)}`:'');
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const data=await res.json(); doctors=(data.results||[]);
    renderDoctors();
  }
  function renderDoctors(){
    $docList.empty().removeClass('d-none');
    doctors.forEach(d=>{
      const $it=$('<div class="pick-item"></div>').text(d.name).data('id',d.id);
      $it.on('click',()=>{
        $docList.find('.pick-item').removeClass('active'); $it.addClass('active');
        $docInput.val(d.name).prop('disabled',true);
        $docList.addClass('d-none');             // Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨: Ø¨Ø¨Ù†Ø¯
        $docChange.removeClass('d-none');        // Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ± Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        fetchOrders(d.id);
      });
      $docList.append($it);
    });
  }
  $docChange.on('click', ()=>{
    $docInput.prop('disabled',false).focus();
    $docList.removeClass('d-none');
    $docChange.addClass('d-none');
  });

  // ========== Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ ==========
  async function fetchOrders(docId){
    $ordInput.prop('disabled', false).val('');
    $ordList.empty().removeClass('d-none');
    enableForm(false);
    const url=`{% url 'core:api_orders_by_doctor' %}?doctor_id=${encodeURIComponent(docId)}`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const data=await res.json(); orders=(data.results||[]);
    renderOrders();
  }

  function renderOrders(){
    $ordList.empty();
    const $head=$('<div class="d-flex fw-bold border-bottom pb-1"><div style="width:40px"></div><div class="flex-grow-1">Ø³ÙØ§Ø±Ø´ / Ø¨ÛŒÙ…Ø§Ø±</div></div>');
    $ordList.append($head);

    orders.forEach(o=>{
      const name   = o.patient_name || (o.patient && o.patient.name) || '';
      const serial = o.serial_number ? ('Ø³Ø±ÛŒØ§Ù„ ' + o.serial_number) : '';
      const due    = o.due_date ? ('ØªØ­ÙˆÛŒÙ„: ' + o.due_date) : '';
      const top    = `#${o.id} â€” ${name||'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'}`;
      const sub    = [serial, due].filter(Boolean).join(' | ');

      const $row=$('<div class="d-flex align-items-start py-1 pick-item"></div>');
      const $chk=$('<input type="checkbox" class="form-check-input me-2 mt-1">').val(o.id);
      const $lbl=$('<div class="flex-grow-1"></div>');
      $lbl.append($('<div class="fw-semibold"></div>').text(top));
      if(sub){ $lbl.append($('<div class="pick-sub"></div>').text(sub)); }

      $chk.on('change', ()=>{
        $row.toggleClass('active',$chk.is(':checked'));
        const checked=$ordList.find('input[type="checkbox"]:checked');
        if(checked.length>0){
          enableForm(true);
          loadStages(checked.first().val());
          initPickers();
          // Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³ÙØ§Ø±Ø´: Ù„ÛŒØ³Øª Ø±Ø§ Ø¨Ø¨Ù†Ø¯ Ùˆ Ø§Ù…Ú©Ø§Ù† "ØªØºÛŒÛŒØ±" Ø¨Ø¯Ù‡
          $ordList.addClass('d-none');
          $ordInput.prop('disabled',true);
          $ordChange.removeClass('d-none');
        }else{
          enableForm(false);
        }
        updateSummary();
        updateAbutmentVisibility();
      });

      $row.append($('<div style="width:40px"></div>').append($chk), $lbl);
      $ordList.append($row);
    });
  }
  $ordChange.on('click', ()=>{
    $ordInput.prop('disabled',false).focus();
    $ordList.removeClass('d-none');
    $ordChange.addClass('d-none');
  });

  // ÙÛŒÙ„ØªØ± Ú©Ù„Ø§ÛŒÙ†ØªÛŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
  $ordInput.on('input', function(){
    const q=$(this).val().trim().toLowerCase();
    $ordList.children().each(function(){
      $(this).toggle($(this).text().toLowerCase().includes(q) || $(this).hasClass('d-flex'));
    });
  });

  // ========== Ù…Ø±Ø­Ù„Ù‡â€ŒÙ‡Ø§ ==========
  async function loadStages(orderId){
    try{
      const res=await fetch(`{% url 'core:api_order_stages' %}?order_id=${encodeURIComponent(orderId)}`, {headers:{'Accept':'application/json'}});
      const js=await res.json();
      stageLabels=(Array.isArray(js)?js:(js.results||[])).map(x=> (typeof x==='string'?x:(x.label||x.name||x.key||x.value||'')) ).filter(Boolean);
      renderStageList();
      $stageDisp.prop('disabled', false).val('');
      $stageList.removeClass('d-none');
      $stageChange.addClass('d-none');
    }catch(e){
      alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.');
    }
  }
  function renderStageList(){
    $stageList.empty();
    stageLabels.forEach(lbl=>{
      const $it=$('<div class="pick-item"></div>').text(lbl);
      $it.on('click', ()=>{
        $stageDisp.val(lbl);
        $stageList.addClass('d-none');      // Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨: Ø¨Ø¨Ù†Ø¯
        $stageChange.removeClass('d-none'); // Ø¯Ú©Ù…Ù‡ ØªØºÛŒÛŒØ±
        updateAbutmentVisibility();
      });
      $stageList.append($it);
    });
  }
  $stageChange.on('click', ()=>{
    $stageList.removeClass('d-none');
    $stageChange.addClass('d-none');
    $stageDisp.focus();
  });

  // ========== Ù†ÙˆØ§Ø± Ø®Ù„Ø§ØµÙ‡ ==========
  function getUnitCountFromOrder(o){
    return Number(o.unit_count ?? o.units ?? 1) || 1;
  }
  function calcEstimatedTotal(){
    const unitRaw=$charge.val();
    const unitAscii=faToEn(unitRaw).replace(/[,\s]/g,'');
    const unit=Number(unitAscii || '0');

    let sumUnits=0;
    const checkedIds=[];
    $ordList.find('input[type="checkbox"]:checked').each(function(){
      checkedIds.push($(this).val());
    });
    checkedIds.forEach(id=>{
      const o=orders.find(x=> String(x.id)===String(id));
      if(o){ sumUnits += getUnitCountFromOrder(o); }
    });

    // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø§ÛŒÙ…Ù¾Ù„Ù†Øª/Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¨Ø§ØªÙ…Ù†Øª Ø¨Ø§Ø´Ø¯ Ùˆ ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯ØŒ Ø¨Ù‡â€ŒØ¬Ø§ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ØŒ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯Ø´Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (Ø¨Ø±Ø§ÛŒ ØªØ®Ù…ÛŒÙ† UI)
    const abutVal = Number(faToEn($abut.val()||'').replace(/[,\s]/g,'')) || 0;
    if(shouldShowAbutment() && abutVal>0){
      sumUnits = abutVal;
    }

    return {count: checkedIds.length, total: unit * sumUnits};
  }
  function updateSummary(){
    const {count,total}=calcEstimatedTotal();
    $('#selCount').text(enToFa(String(count)));
    const totalStr = total.toLocaleString('en-US').replace(/[0-9]/g,(d)=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
    $('#estTotal').text(totalStr);
  }
  $charge.on('input', updateSummary);
  $abut.on('input', updateSummary);

 // ========== Ù…Ù†Ø·Ù‚ Ù†Ù…Ø§ÛŒØ´ Â«ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨Ø§ØªÙ…Ù†ØªÂ» (Ù†Ø³Ø®Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø± Ø§Ø³Ø§Ø³ implant_pfm / implant_zirconia + abutment.select) ==========
function anySelectedImplantOrder(){
  // Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø´Ù†Ø§Ø³Ù‡Ù” Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªÛŒÚ©â€ŒØ®ÙˆØ±Ø¯Ù‡
  const selectedIds = $ordList
    .find('input[type="checkbox"]:checked')
    .map((_, el) => String(el.value))
    .get();

  if (!selectedIds.length) return false;

  for (const id of selectedIds){
    const o = orders.find(x => String(x.id) === id);
    if (!o) continue;

    // Ù‡Ù…Ù‡Ù” ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ú©ÙØ¯/Ù†ÙˆØ¹ Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ù†Ø±Ù…Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    const fields = [
      o.product_code,
      o.order_type,
      o.product_kind,
      o.product_name,
      o.product,
      o.type,
      o.kind
    ]
    .filter(v => v != null && v !== '')
    .map(v => String(v).toLowerCase().trim());

    // Ù…Ø¹ÛŒØ§Ø± Ø§ÛŒÙ…Ù¾Ù„Ù†Øª: Ú©Ù„Ù…Ù‡Ù” implant ÛŒØ§ Ú©Ø¯Ù‡Ø§ÛŒ ØµØ±ÛŒØ­
    const isImplant =
      fields.some(f =>
        f === 'implant_pfm' ||
        f === 'implant_zirconia' ||
        f.includes('implant')
      );

    if (isImplant){
      console.log('âœ… implant order:', o.id, fields);
      return true;
    }
  }

  console.log('âŒ No implant order among selected.');
  return false;
}

function isAbutmentSelectStage(){
  const raw  = ($stageDisp.val() || '').toString().trim().toLowerCase();
  const norm = raw.replace(/[\s\.\-_\u200c]+/g, ''); // Ø­Ø°Ù ÙØ§ØµÙ„Ù‡ØŒ Ø¹Ù„Ø§Ø¦Ù…ØŒ Ù†ÛŒÙ…â€ŒÙØ§ØµÙ„Ù‡

  // Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
  const enOk =
    norm.includes('abutment') || norm.includes('aboutment');

  // ÙØ§Ø±Ø³ÛŒ (Ú©Ø§ÙÛŒâ€ŒØ³Øª Â«Ø§Ø¨Ø§ØªÙ…Ù†ØªÂ» Ø¯Ø± Ù…ØªÙ† Ø¨Ø§Ø´Ø¯Ø› Ú†Ù‡ Â«Ø§Ù†ØªØ®Ø§Ø¨Â» Ú†Ù‡ Â«Ø¯Ø±ÛŒØ§ÙØªÂ»)
  const faOk = norm.includes('Ø§Ø¨Ø§ØªÙ…Ù†Øª');

  const ok = enOk || faOk;
  console.log('ğŸ” Stage check:', raw, 'â†’ normalized:', norm, 'â†’ result:', ok);
  return ok;
}

function isReceivedStatus(){
  return String($('select[name="status"]').val() || '').toLowerCase() === 'received';
}

function shouldShowAbutment(){
  // ÙÙ‚Ø· Ú©Ø§ÙÛŒ Ø§Ø³Øª Ø³ÙØ§Ø±Ø´ Ø§ÛŒÙ…Ù¾Ù„Ù†Øª Ø¨Ø§Ø´Ø¯ Ùˆ Ù…Ø±Ø­Ù„Ù‡ Â«Ø§Ø¨Ø§ØªÙ…Ù†ØªÂ» ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
  return anySelectedImplantOrder() && isAbutmentSelectStage();
}

function updateAbutmentVisibility(){
  if (shouldShowAbutment()){
    $abutBox.removeClass('d-none');
  } else {
    $abutBox.addClass('d-none');
    $abut.val('');
  }
  updateSummary(); // ØªØ®Ù…ÛŒÙ† Ø¬Ù…Ø¹ Ø±Ø§ Ø¨Ø§ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨Ø§ØªÙ…Ù†Øª (Ø¯Ø± ØµÙˆØ±Øª Ù†Ù…Ø§ÛŒØ´) Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†
}
  // ========== ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØª â†’ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ® Ø¯Ø±ÛŒØ§ÙØª ==========
  const $statusSel=$('select[name="status"]');
$statusSel.on('change',()=>{
  $recv.prop('disabled', $statusSel.val()!=='received');
  updateAbutmentVisibility();   // â† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
});

  // ========== Ø³Ø§Ø¨Ù…ÛŒØª ==========
  $form.on('submit', function(e){
    const ids=[];
    $ordList.find('input[type="checkbox"]').each(function(){
      if($(this).is(':checked')) ids.push($(this).val());
    });
    if(!ids.length){
      e.preventDefault(); alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return;
    }

    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ hiddenÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    $(this).find('input[name="order_ids[]"],input[name="charge_unit"],input[name="sent_date"],input[name="received_date"]').remove();

    // Ø¢Ø±Ø§ÛŒÙ‡ order_ids[]
    ids.forEach(id=>{
      $('<input type="hidden" name="order_ids[]">').val(id).appendTo(this);
    });

    // Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯ (ASCII)
    $('<input type="hidden" name="charge_unit">')
      .val(normalizeMoneyFaToAscii($charge.val()))
      .appendTo(this);

    // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
    $('#stage_name').val($stageDisp.val().trim());
    $('#shade_code').val($shade.val().trim());
    $('#credit_amount').val(normalizeMoneyFaToAscii($credit.val()));

    // ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø´Ù…Ø³ÛŒ â†’ ISO
    const sentISO = jalaliFaToISO($sent);
    if(!sentISO){
      e.preventDefault(); alert('ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø´Ù…Ø³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return;
    }
    $('<input type="hidden" name="sent_date">').val(sentISO).appendTo(this);

    const recvISO = jalaliFaToISO($recv);
    if(recvISO){
      $('<input type="hidden" name="received_date">').val(recvISO).appendTo(this);
    }

    // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø§ÛŒÙ…Ù¾Ù„Ù†Øª/Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¨Ø§ØªÙ…Ù†Øª Ø§Ø³Øª Ùˆ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ØŒ Ø¨ÙØ±Ø³Øª
    if(shouldShowAbutment()){
      const ab = faToEn($abut.val()||'').replace(/[,\s]/g,'');
      if(ab){ $('#units_override').val(ab); }
    }
  });

  // Ø¢ØºØ§Ø²
  fetchDoctors('');
})();
</script>
</body>
</html>



